<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN">
<html xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns="http://www.w3.org/1999/xhtml" xmlns:x="http://www.texmacs.org/2002/extensions">
  <head>
    <title>fangle</title>
    <meta content="TeXmacs 1.0.7.10" name="generator"></meta>
    <style type="text/css">
      body { text-align: justify } h5 { display: inline; padding-right: 1em }
      h6 { display: inline; padding-right: 1em } table { border-collapse:
      collapse } td { padding: 0.2em; vertical-align: baseline } .subsup {
      display: inline; vertical-align: -0.2em } .subsup td { padding: 0px;
      text-align: left} .fraction { display: inline; vertical-align: -0.8em }
      .fraction td { padding: 0px; text-align: center } .wide { position:
      relative; margin-left: -0.4em } .accent { position: relative;
      margin-left: -0.4em; top: -0.1em } .title-block { width: 100%;
      text-align: center } .title-block p { margin: 0px } .compact-block p {
      margin-top: 0px; margin-bottom: 0px } .left-tab { text-align: left }
      .center-tab { text-align: center } .right-tab { float: right; position:
      relative; top: -1em } 
    </style>
  </head>
  <body>
    <p>
      
    </p>
    <p>
      <p>
        
      </p>
      <table class="title-block">
        <tr>
          <td><font size="+2"><p>
            <table class="title-block">
              <tr>
                <td><b><font size="+5">fangle</font></b></td>
              </tr>
            </table>
            <p style="margin-top: 10%; margin-bottom: 10%">
              <div class="compact-block">
                <table class="title-block">
                  <tr>
                    <td><p>
                      <span style="margin-left: 0pt"></span>
                      <table style="display: inline; vertical-align: -0.55em">
                        <tbody><tr>
                          <td style="text-align: center; padding-left: 0em; padding-right: 0em; padding-bottom: 0em; padding-top: 0em; width: 100%"><center>
                            <p>
                              <p>
                                <span style="margin-left: 0pt"></span>
                                <table style="display: inline; vertical-align: -0.55em">
                                  <tbody><tr>
                                    <td style="text-align: center; padding-left: 0em; padding-right: 0em; padding-bottom: 0em; padding-top: 0em; width: 100%"><center>
                                      <p>
                                        <class style="font-variant: small-caps"><font size="+2"> Sam
                                        Liddicott</font></class>
                                      </p>
                                    </center></td>
                                  </tr></tbody>
                                </table>
                              </p>
                              <p style="margin-top: 2em; margin-bottom: 2em">
                                <span style="margin-left: 0pt"></span>
                                <table style="display: inline; vertical-align: -0.55em">
                                  <tbody><tr>
                                    <td style="text-align: center; padding-left: 0em; padding-right: 0em; padding-bottom: 0em; padding-top: 0em; width: 100%"><center>
                                      <p>
                                        sam@liddicott.com
                                      </p>
                                    </center></td>
                                  </tr></tbody>
                                </table>
                              </p>
                            </p>
                          </center></td>
                        </tr></tbody>
                      </table>
                    </p></td>
                  </tr>
                </table>
              </div>
            </p>
            <p>
              <span style="margin-left: 0pt"></span>
              <table style="display: inline; vertical-align: -0.55em">
                <tbody><tr>
                  <td style="text-align: center; padding-left: 0em; padding-right: 0em; padding-bottom: 0em; padding-top: 0em; width: 100%"><center>
                    <p>
                      <i>August 2009</i>
                    </p>
                  </center></td>
                </tr></tbody>
              </table>
            </p>
          </p></font></td>
        </tr>
      </table>
      <p>
        
      </p>
      <p>
        
      </p>
      <div class="right-tab">
        <span style="margin-left: 0em"></span>
      </div>
    </p>
    <h2 id="auto-1">Introduction</h2>
    <p>
      <class style="font-variant: small-caps">Fangle</class> is a tool for fangled literate programming.
      Newfangled is defined as <em>New and often needlessly novel</em> by
      <class style="font-variant: small-caps">TheFreeDictionary.com</class>.
    </p>
    <p>
      In this case, fangled means yet another not-so-new
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . but improved.
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-1"></a>
      <sup><a href="#footnote-1">1</a></sup>
      method for literate programming.
    </p>
    <p>
      <class style="font-variant: small-caps">Literate Programming</class> has a long history starting
      with the great <class style="font-variant: small-caps">Donald Knuth</class> himself, whose
      literate programming tools seem to make use of as many escape sequences
      for semantic markup as TeX (also by <class style="font-variant: small-caps">Donald Knuth</class>).
    </p>
    <p>
      <class style="font-variant: small-caps">Norman Ramsey</class> wrote the <class style="font-variant: small-caps">Noweb</class>
      set of tools (<tt class="verbatim">notangle</tt>, <tt class="verbatim">noweave</tt> and <tt
      class="verbatim">noroots</tt>) and helpfully reduced the amount of magic character
      sequences to pretty much just <tt class="verbatim">&lt;&lt;</tt>, <tt class="verbatim">&gt;&gt;</tt>
      and <tt class="verbatim">@</tt>, and in doing so brought the wonders of literate
      programming within my reach.
    </p>
    <p>
      While using the L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X editor for
      LaTeX editing I had various troubles with the noweb tools, some of which
      were my fault, some of which were noweb's fault and some of which were
      L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X's fault.
    </p>
    <p>
      <class style="font-variant: small-caps">Noweb</class> generally brought literate programming to
      the masses through removing some of the complexity of the original
      literate programming, but this would be of no advantage to me if the
      L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X / LaTeX combination brought
      more complications in their place.
    </p>
    <p>
      <class style="font-variant: small-caps">Fangle</class> was thus born (originally called <class
      style="font-variant: small-caps">Newfangle</class>) as an awk replacement for notangle, adding
      some important features, like better integration with L<span style="margin-left: -0.1667em"></span>Y<span
      style="margin-left: -0.125em"></span>X and LaTeX (and later TeXmacs), multiple output format
      conversions, and fixing notangle bugs like indentation when using -L for
      line numbers.
    </p>
    <p>
      Significantly, fangle is just one program which replaces various
      programs in <class style="font-variant: small-caps">Noweb</class>. Noweave is done away with and
      implemented directly as LaTeX macros, and noroots is implemented as a
      function of the untangler fangle.
    </p>
    <p>
      Fangle is written in awk for portability reasons, awk being available
      for most platforms. A Python version
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . hasn't anyone implemented awk in python yet?
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-2"></a>
      <sup><a href="#footnote-2">2</a></sup>
      was considered for the benefit of L
      <span style="margin-left: -0.1667em"></span>
      Y
      <span style="margin-left: -0.125em"></span>
      X but a scheme version for TeXmacs will probably materialise first; as
      TeXmacs macro capabilities help make edit-time and format-time rendering
      of fangle chunks simple enough for my weak brain.
    </p>
    <p>
      As an extension to many literate-programming styles, Fangle permits code
      chunks to take parameters and thus operate somewhat like C pre-processor
      macros, or like C++ templates. Name parameters (or even local
      <em>variables</em> in the callers scope) are anticipated, as
      parameterized chunks <class style="font-family: Times New Roman">&mdash;</class> useful though they
      are <class style="font-family: Times New Roman">&mdash;</class> are hard to comprehend in the literate
      document.
    </p>
    <h2 id="auto-2"><a id="License"></a>License</h2>
    <p>
      Fangle is licensed under the GPL 3 (or later).
    </p>
    <p>
      This doesn't mean that sources generated by fangle must be licensed
      under the GPL 3.
    </p>
    <p>
      This doesn't mean that you can't use or distribute fangle with sources
      of an incompatible license, but it means you must make the source of
      fangle available too.
    </p>
    <p>
      As fangle is currently written in awk, an interpreted language, this
      should not be too hard.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-gpl3-copyright-1"></a>
        <table style="width: 100%" id="code-ref-gpl3-copyright-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="gpl3-copyright"></a><font size="-1"><font color="blue">gpl3-copyright</font>[1](),
            lang=<font color="blue">text</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt># fangle - fully featured notangle replacement in awk
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>#
<tt>3  </tt># Copyright (C) 2009-2010 Sam Liddicott &lt;sam@liddicott.com&gt;
<tt>4  </tt>#
<tt>5  </tt># This program is free software: you can redistribute it and/or modify
<tt>6  </tt># it under the terms of the GNU General Public License as published by
<tt>7  </tt># the Free Software Foundation, either version 3 of the License, or
<tt>8  </tt># (at your option) any later version.
<tt>9  </tt>#
<tt>10  </tt># This program is distributed in the hope that it will be useful,
<tt>11  </tt># but WITHOUT ANY WARRANTY; without even the implied warranty of
<tt>12  </tt># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<tt>13  </tt># GNU General Public License for more details.
<tt>14  </tt>#
<tt>15  </tt># You should have received a copy of the GNU General Public License</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>16  </tt># along with this program.  If not, see
            &lt;http://www.gnu.org/licenses/&gt;.
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-gpl3-copyright-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1>Table of contents</h1>
    <p style="margin-top: 25%; margin-bottom: 10%">
      <div style="text-indent: 0em">
        <div class="compact-block">
          <p>
            Introduction <span style="margin-left: 5mm"></span> <a href="#auto-1">3</a>
          </p>
          <p>
            License <span style="margin-left: 5mm"></span> <a href="#auto-2">4</a>
          </p>
          <p style="margin-top: 2em; margin-bottom: 1em">
            <b><font size="+1">I<span style="margin-left: 1em"></span>Using Fangle</font></b> <span
            style="margin-left: 5mm"></span> <a href="#auto-3">9</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>1<span style="margin-left: 1em"></span>Introduction to Literate Programming</b>
            <span style="margin-left: 5mm"></span> <a href="#auto-4">11</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>2<span style="margin-left: 1em"></span>Running Fangle</b> <span style="margin-left: 5mm"></span> <a
            href="#auto-5">13</a>
          </p>
          <p>
            2.1<span style="margin-left: 1em"></span>Listing roots <span style="margin-left: 5mm"></span> <a href="#auto-6">13</a>
          </p>
          <p>
            2.2<span style="margin-left: 1em"></span>Extracting roots <span style="margin-left: 5mm"></span> <a
            href="#auto-7">13</a>
          </p>
          <p>
            2.3<span style="margin-left: 1em"></span>Formatting the document <span style="margin-left: 5mm"></span>
            <a href="#auto-8">13</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>3<span style="margin-left: 1em"></span>Using Fangle with L<sup><span style="margin-left: -0.4em"></span>A</sup><span
            style="margin-left: -0.1em"></span>T<sub><span style="margin-left: -0.2em"></span>E</sub><span style="margin-left: -0.2em"></span>X</b>
            <span style="margin-left: 5mm"></span> <a href="#auto-9">15</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>4<span style="margin-left: 1em"></span>Using Fangle with L<span style="margin-left: -0.1667em"></span>Y<span
            style="margin-left: -0.125em"></span>X</b> <span style="margin-left: 5mm"></span> <a href="#auto-10">17</a>
          </p>
          <p>
            4.1<span style="margin-left: 1em"></span>Installing the L<span style="margin-left: -0.1667em"></span>Y<span
            style="margin-left: -0.125em"></span>X module <span style="margin-left: 5mm"></span> <a href="#auto-11">17</a>
          </p>
          <p>
            4.2<span style="margin-left: 1em"></span>Obtaining a decent mono font <span style="margin-left: 5mm"></span>
            <a href="#auto-12">17</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              4.2.1<span style="margin-left: 1em"></span>txfonts <span style="margin-left: 5mm"></span> <a href="#auto-13">17</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              4.2.2<span style="margin-left: 1em"></span>ams pmb <span style="margin-left: 5mm"></span> <a href="#auto-14">17</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              4.2.3<span style="margin-left: 1em"></span>Luximono <span style="margin-left: 5mm"></span> <a href="#auto-15">17</a>
            </p>
          </div>
          <p>
            4.3<span style="margin-left: 1em"></span>Formatting your Lyx document <span style="margin-left: 5mm"></span>
            <a href="#auto-16">18</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              4.3.1<span style="margin-left: 1em"></span>Customising the listing appearance
              <span style="margin-left: 5mm"></span> <a href="#auto-17">18</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              4.3.2<span style="margin-left: 1em"></span>Global customisations <span style="margin-left: 5mm"></span>
              <a href="#auto-18">18</a>
            </p>
          </div>
          <p>
            4.4<span style="margin-left: 1em"></span>Configuring the build script <span style="margin-left: 5mm"></span>
            <a href="#auto-19">19</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              4.4.1<span style="margin-left: 1em"></span>... <span style="margin-left: 5mm"></span> <a href="#auto-20">19</a>
            </p>
          </div>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>5<span style="margin-left: 1em"></span>Using Fangle with T<sub><span style="margin-left: -0.2em"></span>E</sub><span
            style="margin-left: -0.2em"></span>X<sub><span style="margin-left: -0.2em"></span>M<span style="margin-left: -0.1em"></span>A<span
            style="margin-left: -0.2em"></span>CS</sub></b> <span style="margin-left: 5mm"></span> <a href="#auto-21">21</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>6<span style="margin-left: 1em"></span>Fangle with Makefiles</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-22">23</a>
          </p>
          <p>
            6.1<span style="margin-left: 1em"></span>A word about makefiles formats <span style="margin-left: 5mm"></span>
            <a href="#auto-23">23</a>
          </p>
          <p>
            6.2<span style="margin-left: 1em"></span>Extracting Sources <span style="margin-left: 5mm"></span> <a
            href="#auto-24">23</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              6.2.1<span style="margin-left: 1em"></span>Converting from L<span style="margin-left: -0.1667em"></span>Y<span
              style="margin-left: -0.125em"></span>X to L<sup><span style="margin-left: -0.4em"></span>A</sup><span style="margin-left: -0.1em"></span>T<sub><span
              style="margin-left: -0.2em"></span>E</sub><span style="margin-left: -0.2em"></span>X <span style="margin-left: 5mm"></span>
              <a href="#auto-25">24</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              6.2.2<span style="margin-left: 1em"></span>Converting from T<sub><span style="margin-left: -0.2em"></span>E</sub><span
              style="margin-left: -0.2em"></span>X<sub><span style="margin-left: -0.2em"></span>M<span style="margin-left: -0.1em"></span>A<span
              style="margin-left: -0.2em"></span>CS</sub> <span style="margin-left: 5mm"></span> <a href="#auto-26">24</a>
            </p>
          </div>
          <p>
            6.3<span style="margin-left: 1em"></span>Extracting Program Source <span style="margin-left: 5mm"></span>
            <a href="#auto-27">25</a>
          </p>
          <p>
            6.4<span style="margin-left: 1em"></span>Extracting Source Files <span style="margin-left: 5mm"></span>
            <a href="#auto-28">25</a>
          </p>
          <p>
            6.5<span style="margin-left: 1em"></span>Extracting Documentation <span style="margin-left: 5mm"></span>
            <a href="#auto-29">27</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              6.5.1<span style="margin-left: 1em"></span>Formatting T<sub><span style="margin-left: -0.2em"></span>E</sub><span
              style="margin-left: -0.2em"></span>X <span style="margin-left: 5mm"></span> <a href="#auto-30">27</a>
            </p>
          </div>
          <div style="margin-left: 48px">
            <p>
              6.5.1.1<span style="margin-left: 1em"></span>Running pdflatex <span style="margin-left: 5mm"></span>
              <a href="#auto-31">27</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              6.5.2<span style="margin-left: 1em"></span>Formatting T<sub><span style="margin-left: -0.2em"></span>E</sub><span
              style="margin-left: -0.2em"></span>X<sub><span style="margin-left: -0.2em"></span>M<span style="margin-left: -0.1em"></span>A<span
              style="margin-left: -0.2em"></span>CS</sub> <span style="margin-left: 5mm"></span> <a href="#auto-32">28</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              6.5.3<span style="margin-left: 1em"></span>Building the Documentation as a Whole
              <span style="margin-left: 5mm"></span> <a href="#auto-33">28</a>
            </p>
          </div>
          <p>
            6.6<span style="margin-left: 1em"></span>Other helpers <span style="margin-left: 5mm"></span> <a href="#auto-34">29</a>
          </p>
          <p>
            6.7<span style="margin-left: 1em"></span>Boot-strapping the extraction <span style="margin-left: 5mm"></span>
            <a href="#auto-35">29</a>
          </p>
          <p>
            6.8<span style="margin-left: 1em"></span>Incorporating Makefile.inc into existing
            projects <span style="margin-left: 5mm"></span> <a href="#auto-36">30</a>
          </p>
          <div style="margin-left: 96px">
            <p>
              Example <span style="margin-left: 5mm"></span> <a href="#auto-37">30</a>
            </p>
          </div>
          <p style="margin-top: 2em; margin-bottom: 1em">
            <b><font size="+1">II<span style="margin-left: 1em"></span>Source Code</font></b> <span
            style="margin-left: 5mm"></span> <a href="#auto-38">31</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>7<span style="margin-left: 1em"></span>Fangle awk source code</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-39">33</a>
          </p>
          <p>
            7.1<span style="margin-left: 1em"></span>AWK tricks <span style="margin-left: 5mm"></span> <a href="#auto-40">33</a>
          </p>
          <p>
            7.2<span style="margin-left: 1em"></span>Catching errors <span style="margin-left: 5mm"></span> <a
            href="#auto-41">34</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>8<span style="margin-left: 1em"></span>L<sup><span style="margin-left: -0.4em"></span>A</sup><span
            style="margin-left: -0.1em"></span>T<sub><span style="margin-left: -0.2em"></span>E</sub><span style="margin-left: -0.2em"></span>X
            and lstlistings</b> <span style="margin-left: 5mm"></span> <a href="#auto-42">35</a>
          </p>
          <p>
            8.1<span style="margin-left: 1em"></span>Additional lstlstings parameters <span
            style="margin-left: 5mm"></span> <a href="#auto-43">35</a>
          </p>
          <p>
            8.2<span style="margin-left: 1em"></span>Parsing chunk arguments <span style="margin-left: 5mm"></span>
            <a href="#auto-44">37</a>
          </p>
          <p>
            8.3<span style="margin-left: 1em"></span>Expanding parameters in the text <span
            style="margin-left: 5mm"></span> <a href="#auto-45">38</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>9<span style="margin-left: 1em"></span>Language Modes &amp; Quoting</b> <span
            style="margin-left: 5mm"></span> <a href="#auto-46">41</a>
          </p>
          <p>
            9.1<span style="margin-left: 1em"></span>Modes <span style="margin-left: 5mm"></span> <a href="#auto-47">41</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              9.1.1<span style="margin-left: 1em"></span>Modes to keep code together <span
              style="margin-left: 5mm"></span> <a href="#auto-48">41</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.1.2<span style="margin-left: 1em"></span>Modes affect included chunks <span
              style="margin-left: 5mm"></span> <a href="#auto-49">41</a>
            </p>
          </div>
          <p>
            9.2<span style="margin-left: 1em"></span>Language Mode Definitions <span style="margin-left: 5mm"></span>
            <a href="#auto-50">42</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              9.2.1<span style="margin-left: 1em"></span>Backslash <span style="margin-left: 5mm"></span> <a href="#auto-51">43</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.2.2<span style="margin-left: 1em"></span>Strings <span style="margin-left: 5mm"></span> <a href="#auto-52">44</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.2.3<span style="margin-left: 1em"></span>Parentheses, Braces and Brackets <span
              style="margin-left: 5mm"></span> <a href="#auto-53">45</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.2.4<span style="margin-left: 1em"></span>Customizing Standard Modes <span style="margin-left: 5mm"></span>
              <a href="#auto-54">45</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.2.5<span style="margin-left: 1em"></span>Comments <span style="margin-left: 5mm"></span> <a href="#auto-55">45</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.2.6<span style="margin-left: 1em"></span>Regex <span style="margin-left: 5mm"></span> <a href="#auto-56">46</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.2.7<span style="margin-left: 1em"></span>Perl <span style="margin-left: 5mm"></span> <a href="#auto-57">47</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.2.8<span style="margin-left: 1em"></span>sh <span style="margin-left: 5mm"></span> <a href="#auto-58">47</a>
            </p>
          </div>
          <p>
            9.3<span style="margin-left: 1em"></span>Some tests <span style="margin-left: 5mm"></span> <a href="#auto-59">47</a>
          </p>
          <p>
            9.4<span style="margin-left: 1em"></span>A non-recursive mode tracker <span style="margin-left: 5mm"></span>
            <a href="#auto-60">48</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              9.4.1<span style="margin-left: 1em"></span>Constructor <span style="margin-left: 5mm"></span> <a
              href="#auto-61">48</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.4.2<span style="margin-left: 1em"></span>Management <span style="margin-left: 5mm"></span> <a
              href="#auto-62">48</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              9.4.3<span style="margin-left: 1em"></span>Tracker <span style="margin-left: 5mm"></span> <a href="#auto-63">49</a>
            </p>
          </div>
          <div style="margin-left: 48px">
            <p>
              9.4.3.1<span style="margin-left: 1em"></span>One happy chunk <span style="margin-left: 5mm"></span>
              <a href="#auto-64">52</a>
            </p>
          </div>
          <div style="margin-left: 48px">
            <p>
              9.4.3.2<span style="margin-left: 1em"></span>Tests <span style="margin-left: 5mm"></span> <a href="#auto-65">52</a>
            </p>
          </div>
          <p>
            9.5<span style="margin-left: 1em"></span>Escaping and Quoting <span style="margin-left: 5mm"></span>
            <a href="#auto-66">52</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>10<span style="margin-left: 1em"></span>Recognizing Chunks</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-67">55</a>
          </p>
          <p>
            10.1<span style="margin-left: 1em"></span>Chunk start <span style="margin-left: 5mm"></span> <a href="#auto-68">55</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              10.1.1<span style="margin-left: 1em"></span>T<sub><span style="margin-left: -0.2em"></span>E</sub><span
              style="margin-left: -0.2em"></span>X<sub><span style="margin-left: -0.2em"></span>M<span style="margin-left: -0.1em"></span>A<span
              style="margin-left: -0.2em"></span>CS</sub> hackery <span style="margin-left: 5mm"></span> <a href="#auto-69">55</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              10.1.2<span style="margin-left: 1em"></span>lstlistings <span style="margin-left: 5mm"></span> <a
              href="#auto-70">56</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              10.1.3<span style="margin-left: 1em"></span>T<sub><span style="margin-left: -0.2em"></span>E</sub><span
              style="margin-left: -0.2em"></span>X<sub><span style="margin-left: -0.2em"></span>M<span style="margin-left: -0.1em"></span>A<span
              style="margin-left: -0.2em"></span>CS</sub> <span style="margin-left: 5mm"></span> <a href="#auto-71">56</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              10.1.4<span style="margin-left: 1em"></span>Noweb <span style="margin-left: 5mm"></span> <a href="#auto-72">57</a>
            </p>
          </div>
          <p>
            10.2<span style="margin-left: 1em"></span>Chunk end <span style="margin-left: 5mm"></span> <a href="#auto-73">57</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              10.2.1<span style="margin-left: 1em"></span>lstlistings <span style="margin-left: 5mm"></span> <a
              href="#auto-74">58</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              10.2.2<span style="margin-left: 1em"></span>noweb <span style="margin-left: 5mm"></span> <a href="#auto-75">58</a>
            </p>
          </div>
          <p>
            10.3<span style="margin-left: 1em"></span>Chunk contents <span style="margin-left: 5mm"></span> <a
            href="#auto-76">58</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              10.3.1<span style="margin-left: 1em"></span>lstlistings <span style="margin-left: 5mm"></span> <a
              href="#auto-77">59</a>
            </p>
          </div>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>11<span style="margin-left: 1em"></span>Processing Options</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-78">61</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>12<span style="margin-left: 1em"></span>Generating the Output</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-79">63</a>
          </p>
          <p>
            12.1<span style="margin-left: 1em"></span>Assembling the Chunks <span style="margin-left: 5mm"></span>
            <a href="#auto-80">64</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              12.1.1<span style="margin-left: 1em"></span>Chunk Parts <span style="margin-left: 5mm"></span> <a
              href="#auto-81">64</a>
            </p>
          </div>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>13<span style="margin-left: 1em"></span>Storing Chunks</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-82">69</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>14<span style="margin-left: 1em"></span>getopt</b> <span style="margin-left: 5mm"></span> <a href="#auto-83">71</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>15<span style="margin-left: 1em"></span>Fangle LaTeX source code</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-84">75</a>
          </p>
          <p>
            15.1<span style="margin-left: 1em"></span>fangle module <span style="margin-left: 5mm"></span> <a
            href="#auto-85">75</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              15.1.1<span style="margin-left: 1em"></span>The Chunk style <span style="margin-left: 5mm"></span>
              <a href="#auto-86">75</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              15.1.2<span style="margin-left: 1em"></span>The chunkref style <span style="margin-left: 5mm"></span>
              <a href="#auto-87">76</a>
            </p>
          </div>
          <p>
            15.2<span style="margin-left: 1em"></span>Latex Macros <span style="margin-left: 5mm"></span> <a href="#auto-88">76</a>
          </p>
          <div style="margin-left: 24px">
            <p>
              15.2.1<span style="margin-left: 1em"></span>The chunk command <span style="margin-left: 5mm"></span>
              <a href="#auto-89">77</a>
            </p>
          </div>
          <div style="margin-left: 48px">
            <p>
              15.2.1.1<span style="margin-left: 1em"></span>Chunk parameters <span style="margin-left: 5mm"></span>
              <a href="#auto-90">78</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              15.2.2<span style="margin-left: 1em"></span>The noweb styled caption <span style="margin-left: 5mm"></span>
              <a href="#auto-91">78</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              15.2.3<span style="margin-left: 1em"></span>The chunk counter <span style="margin-left: 5mm"></span>
              <a href="#auto-93">78</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              15.2.4<span style="margin-left: 1em"></span>Cross references <span style="margin-left: 5mm"></span>
              <a href="#auto-94">81</a>
            </p>
          </div>
          <div style="margin-left: 24px">
            <p>
              15.2.5<span style="margin-left: 1em"></span>The end <span style="margin-left: 5mm"></span> <a href="#auto-95">82</a>
            </p>
          </div>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>16<span style="margin-left: 1em"></span>Extracting fangle</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-96">83</a>
          </p>
          <p>
            16.1<span style="margin-left: 1em"></span>Extracting from Lyx <span style="margin-left: 5mm"></span>
            <a href="#auto-97">83</a>
          </p>
          <p>
            16.2<span style="margin-left: 1em"></span>Extracting documentation <span style="margin-left: 5mm"></span>
            <a href="#auto-98">83</a>
          </p>
          <p>
            16.3<span style="margin-left: 1em"></span>Extracting from the command line <span
            style="margin-left: 5mm"></span> <a href="#auto-99">84</a>
          </p>
          <p>
            16.4<span style="margin-left: 1em"></span>Testing <span style="margin-left: 5mm"></span> <a href="#auto-100">84</a>
          </p>
          <p style="margin-top: 2em; margin-bottom: 1em">
            <b><font size="+1">III<span style="margin-left: 1em"></span>Tests</font></b> <span
            style="margin-left: 5mm"></span> <a href="#auto-101">85</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>17<span style="margin-left: 1em"></span>Chunk Parameters</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-102">87</a>
          </p>
          <p style="margin-top: 1em; margin-bottom: 0.5em">
            <b>18<span style="margin-left: 1em"></span>Compile-log-lyx</b> <span style="margin-left: 5mm"></span>
            <a href="#auto-103">89</a>
          </p>
        </div>
      </div>
      <a id="auto-3"></a>
      <br></br>
      <b><font size="+5"><div class="center-tab">
        Part I
      </div><div class="right-tab">
        <br></br>Using Fangle
      </div></font></b>
    </p>
    <h1 id="auto-4">Chapter 1<br></br>Introduction to Literate Programming</h1>
    <p>
      Todo: Should really follow on from a part-0 explanation of what literate
      programming is.
    </p>
    <h1 id="auto-5">Chapter 2<br></br>Running Fangle</h1>
    <p>
      Fangle is a replacement for <class style="font-variant: small-caps">noweb</class>, which consists
      of <tt class="verbatim">notangle</tt>, <tt class="verbatim">noroots</tt> and <tt class="verbatim">noweave</tt>.
    </p>
    <p>
      Like <tt class="verbatim">notangle</tt> and <tt class="verbatim">noroots</tt>, <tt class="verbatim">fangle</tt>
      can read multiple named files, or from stdin.
    </p>
    <h2 id="auto-6">2.1<span style="margin-left: 1em"></span>Listing roots</h2>
    <p>
      The -r option causes fangle to behave like noroots.
    </p>
    <p>
      <code>fangle -r filename.tex</code>
    </p>
    <p>
      will print out the fangle roots of a tex file. 
    </p>
    <p>
      Unlike the <tt class="verbatim">noroots</tt> command, the printed roots are not
      enclosed in angle brackets e.g. <tt class="verbatim">&lt;&lt;name&gt;&gt;</tt>,
      unless at least one of the roots is defined using the <tt class="verbatim">notangle</tt>
      notation <tt class="verbatim">&lt;&lt;name&gt;&gt;=</tt>.
    </p>
    <p>
      Also, unlike noroots, it prints out all roots &ndash;- not just those
      that are not used elsewhere. I find that a root not being used doesn't
      make it particularly top level <class style="font-family: Times New Roman">&mdash;</class> and
      so-called top level roots could also be included in another root as
      well. 
    </p>
    <p>
      My convention is that top level roots to be extracted begin with <tt
      class="verbatim">./</tt> and have the form of a filename.
    </p>
    <p>
      Makefile.inc, discussed in <a href="#makefile.inc">6</a>, can automatically extract all
      such sources prefixed with <tt class="verbatim">./</tt>
    </p>
    <h2 id="auto-7">2.2<span style="margin-left: 1em"></span>Extracting roots</h2>
    <p>
      notangle's <tt class="verbatim">-R</tt> and <tt class="verbatim">-L</tt> options are
      supported.
    </p>
    <p>
      If you are using L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X or LaTeX,
      the standard way to extract a file would be:
    </p>
    <pre class="verbatim" xml:space="preserve">
fangle -R./Makefile.inc fangle.tex &gt; ./Makefile.inc</pre>
    <p>
      If you are using TeXmacs, the standard way to extract a file would
      similarly be:
    </p>
    <pre class="verbatim" xml:space="preserve">
fangle -R./Makefile.inc fangle.txt &gt; ./Makefile.inc</pre>
    <p>
      TeXmacs users would obtain the text file with a <em>verbatim</em> export
      from TeXmacs which can be done on the command line with <tt class="verbatim">texmacs
      -s -c fangle.tm fangle.txt -q</tt>
    </p>
    <p>
      Unlike the <tt class="verbatim">noroots</tt> command, the <tt class="verbatim"><tt class="verbatim">-L</tt></tt>
      option to generate C pre-preocessor <tt class="verbatim">#file</tt> style
      line-number directives,does not break indenting of the generated file..
    </p>
    <p>
      Also, thanks to mode tracking (described in <a href="#modes">9</a>) the <tt
      class="verbatim">-L</tt> option does not interrupt (and break) multi-line C macros
      either.
    </p>
    <p>
      This does mean that sometimes the compiler might calculate the source
      line wrongly when generating error messages in such cases, but there
      isn't any other way around if multi-line macros include other chunks.
    </p>
    <p>
      Future releases will include a mapping file so that line/character
      references from the C compiler can be converted to the correct part of
      the source document.
    </p>
    <h2 id="auto-8">2.3<span style="margin-left: 1em"></span>Formatting the document</h2>
    <p>
      The noweave replacement built into the editing and formatting
      environment for TeXmacs, L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X
      (which uses LaTeX), and even for raw LaTeX.
    </p>
    <p>
      Use of fangle with TeXmacs, L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X
      and LaTeX are explained the the next few chapters.
    </p>
    <h1 id="auto-9">Chapter 3<br></br>Using Fangle with LaTeX</h1>
    <p>
      Because the noweave replacement is impemented in LaTeX, there is no
      processing stage required before running the LaTeX command. Of course,
      LaTeX may need running two or more times, so that the code chunk
      references can be fully calculated.
    </p>
    <p>
      The formatting is managed by a set of macros shown in <a href="#latex-source">15</a>,
      and can be included with:
    </p>
    <pre class="verbatim" xml:space="preserve">
\usepackage{fangle.sty}</pre>
    <p>
      Norman Ramsay's origial <tt class="verbatim">noweb.sty</tt> package is currently
      required as it is used for formatting the code chunk captions.
    </p>
    <p>
      The <tt class="verbatim">listings.sty</tt> package is required, and is used for
      formatting the code chunks and syntax highlighting.
    </p>
    <p>
      The <tt class="verbatim">xargs.sty</tt> package is also required, and makes
      writing LaTeX macro so much more pleasant.
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: Add examples of use of Macros</td>
      </tr></tbody>
    </table>
    <h1 id="auto-10">Chapter 4<br></br>Using Fangle with L<span style="margin-left: -0.1667em"></span>Y<span
    style="margin-left: -0.125em"></span>X</h1>
    <p>
      L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X uses the same LaTeX macros
      shown in <a href="#latex-source">15</a> as part of a L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X
      module file <tt class="verbatim">fangle.module</tt>, which automatically includes
      the macros in the document pre-amble provided that the fangle L<span
      style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X module is used in the document.
    </p>
    <h2 id="auto-11">4.1<span style="margin-left: 1em"></span>Installing the L<span style="margin-left: -0.1667em"></span>Y<span
    style="margin-left: -0.125em"></span>X module</h2>
    <p>
      Copy <tt class="verbatim">fangle.module</tt> to your L<span style="margin-left: -0.1667em"></span>Y<span
      style="margin-left: -0.125em"></span>X layouts directory, which for unix users will be <tt
      class="verbatim">~/.lyx/layouts</tt>
    </p>
    <p>
      In order to make the new literate styles availalble, you will need to
      reconfigure L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X by clicking
      Tools-&gt;Reconfigure, and then re-start L<span style="margin-left: -0.1667em"></span>Y<span
      style="margin-left: -0.125em"></span>X.
    </p>
    <h2 id="auto-12">4.2<span style="margin-left: 1em"></span>Obtaining a decent mono font</h2>
    <p>
      The syntax high-lighting features of <class style="font-variant: small-caps">lstlistings</class>
      makes use of bold; however a mono-space tt font is used to typeset the
      listings. Obtaining a <tt><strong>bold</strong> tt font</tt> can be
      impossibly difficult and amazingly easy. I spent many hours at it,
      following complicated instructions from those who had spend many hours
      over it, and was finally delivered the simple solution on the lyx
      mailing list.
    </p>
    <h3 id="auto-13">4.2.1<span style="margin-left: 1em"></span>txfonts</h3>
    <p>
      The simple way was to add this to my preamble:
    </p>
    <pre class="verbatim" xml:space="preserve">
\usepackage{txfonts}
\renewcommand{\ttdefault}{txtt}</pre>
    <p>
      
    </p>
    <h3 id="auto-14">4.2.2<span style="margin-left: 1em"></span>ams pmb</h3>
    <p>
      The next simplest way was to use ams poor-mans-bold, by adding this to
      the pre-amble:
    </p>
    <pre class="verbatim" xml:space="preserve">
\usepackage{amsbsy}
%\renewcommand{\ttdefault}{txtt}
%somehow make \pmb be the command for bold, forgot how, sorry, above line not work</pre>
    <p>
      It works, but looks wretched on the dvi viewer.
    </p>
    <h3 id="auto-15">4.2.3<span style="margin-left: 1em"></span>Luximono</h3>
    <p>
      The lstlistings documention suggests using Luximono.
    </p>
    <p>
      Luximono was installed according to the instructions in Ubuntu Forums
      thread 1159181
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . http://ubuntuforums.org/showthread.php?t=1159181
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-1"></a>
      <sup><a href="#footnote-1">1</a></sup>
      with tips from miknight
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                .
                http://miknight.blogspot.com/2005/11/how-to-install-luxi-mono-font-in.html
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-2"></a>
      <sup><a href="#footnote-2">2</a></sup>
      stating that
      <tt class="verbatim">sudo updmap &ndash;enable MixedMap ul9.map</tt>
      is required. It looks fine in PDF and PS view but still looks rotten in
      dvi view.
    </p>
    <h2 id="auto-16">4.3<span style="margin-left: 1em"></span>Formatting your Lyx document</h2>
    <p>
      It is not necessary to base your literate document on any of the
      original L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X literate classes;
      so select a regular class for your document type.
    </p>
    <p>
      Add the new module <em>Fangle Literate Listings</em> and also
      <em>Logical Markup</em> which is very useful.
    </p>
    <p>
      In the drop-down style listbox you should notice a new style defined,
      called <em>Chunk</em>.
    </p>
    <p>
      When you wish to insert a literate chunk, you enter it's plain name in
      the Chunk style, instead of the old <class style="font-variant: small-caps">noweb</class> method
      that uses <tt class="verbatim">&lt;&lt;name&gt;&gt;=</tt> type tags. In the line
      (or paragraph) following the chunk name, you insert a listing with:
      Insert-&gt;Program Listing.
    </p>
    <p>
      Inside the white listing box you can type (or paste using
      <kbd>shift+ctrl+V</kbd>) your listing. There is no need to use
      <kbd>ctrl+enter</kbd> at the end of lines as with some older L<span
      style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X literate techniques &ndash;- just
      press enter as normal.
    </p>
    <h3 id="auto-17">4.3.1<span style="margin-left: 1em"></span>Customising the listing appearance</h3>
    <p>
      The code is formatted using the <class style="font-variant: small-caps">lstlistings</class>
      package. The chunk style doesn't just define the chunk name, but can
      also define any other chunk options supported by the lstlistings package
      <tt class="verbatim">\lstset</tt> command. In fact, what you type in the chunk
      style is raw latex. If you want to set the chunk language without having
      to right-click the listing, just add <tt class="verbatim">,lanuage=C</tt> after
      the chunk name. (Currently the language will affect all subsequent
      listings, so you may need to specify <tt class="verbatim">,language=</tt> quite a
      lot).
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: so fix the bug</td>
      </tr></tbody>
    </table>
    <p>
      Of course you can do this by editing the listings box advanced
      properties by right-clicking on the listings box, but that takes longer,
      and you can't see at-a-glance what the advanced settings are while
      editing the document; also advanced settings apply only to that box
      &ndash;- the chunk settings apply through the rest of the document
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . It ought to apply only to subsequent chunks of the same
                name. I'll fix that later
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-3"></a>
      <sup><a href="#footnote-3">3</a></sup>
      .
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: So make sure they only apply to chunks of
        that name</td>
      </tr></tbody>
    </table>
    <h3 id="auto-18">4.3.2<span style="margin-left: 1em"></span>Global customisations</h3>
    <p>
      As lstlistings is used to set the code chunks, it's <tt class="verbatim">\lstset</tt>
      command can be used in the pre-amble to set some document wide settings.
    </p>
    <p>
      If your source has many words with long sequences of capital letters,
      then <tt class="verbatim">columns=fullflexible</tt> may be a good idea, or the
      capital letters will get crowded. (I think lstlistings ought to use a
      slightly smaller font for captial letters so that they still fit).
    </p>
    <p>
      The font family <tt class="verbatim">\ttfamily</tt> looks more normal for code,
      but has no bold (an alternate typewriter font is used). 
    </p>
    <p>
      With <tt class="verbatim">\ttfamily</tt>, I must also specify <tt class="verbatim">columns=fullflexible</tt>
      or the wrong letter spacing is used.
    </p>
    <p>
      In my LaTeX pre-amble I usually specialise my code format with:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-document-preamble-1"></a>
        <table style="width: 100%" id="code-ref-document-preamble-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="document-preamble"></a><font size="-1"><font color="blue">document-preamble</font>[1](),
            lang=<font color="blue">tex</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>\lstset{
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>numbers=left, stepnumber=1, numbersep=5pt,
<tt>3  </tt>breaklines=false,
<tt>4  </tt>basicstyle=\footnotesize\ttfamily,
<tt>5  </tt>numberstyle=\tiny,
<tt>6  </tt>language=C,
<tt>7  </tt>columns=fullflexible,
<tt>8  </tt>numberfirstline=true</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>9  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-document-preamble-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      
    </p>
    <h2 id="auto-19">4.4<span style="margin-left: 1em"></span>Configuring the build script</h2>
    <p>
      You can invoke code extraction and building from the L<span style="margin-left: -0.1667em"></span>Y<span
      style="margin-left: -0.125em"></span>X menu option Document-&gt;Build Program.
    </p>
    <p>
      First, make sure you don't have a conversion defined for Lyx-&gt;Program
    </p>
    <p>
      From the menu Tools-&gt;Preferences, add a conversion from
      Latex(Plain)-&gt;Program as:
    </p>
    <pre class="verbatim" xml:space="preserve">
set -x ; fangle -Rlyx-build $$i | 
  env LYX_b=$$b LYX_i=$$i LYX_o=$$o LYX_p=$$p LYX_r=$$r bash</pre>
    <p>
      (But don't cut-n-paste it from this document or you may be be pasting a
      multi-line string which will break your lyx preferences file). 
    </p>
    <p>
      I hope that one day, L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X will
      set these into the environment when calling the build script.
    </p>
    <p>
      You may also want to consider adding options to this conversion...
    </p>
    <pre class="verbatim" xml:space="preserve">
parselog=/usr/share/lyx/scripts/listerrors</pre>
    <p>
      ...but if you do you will lose your stderr
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . There is some bash plumbing to get a copy of stderr but this
                footnote is too small
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-4"></a>
      <sup><a href="#footnote-4">4</a></sup>
      .
    </p>
    <p>
      Now, a shell script chunk called <tt class="verbatim">lyx-build</tt> will be
      extracted and run whenever you choose the Document-&gt;Build Program
      menu item.
    </p>
    <p>
      This document was originally managed using L<span style="margin-left: -0.1667em"></span>Y<span
      style="margin-left: -0.125em"></span>X and lyx-build script for this document is shown here for
      historical reference. 
    </p>
    <pre class="verbatim" xml:space="preserve">
lyx -e latex fangle.lyx &amp;&amp; \
  fangle fangle.lyx &gt; ./autoboot</pre>
    <p>
      This looks simple enough, but as mentioned, fangle has to be had from
      somewhere before it can be extracted.
    </p>
    <h3 id="auto-20">4.4.1<span style="margin-left: 1em"></span>...</h3>
    <p>
      When the lyx-build chunk is executed, the current directory will be a
      temporary directory, and <tt class="verbatim">LYX_SOURCE</tt> will refer to the
      tex file in this temporary directory. This is unfortunate as our
      makefile wants to run from the project directory where the Lyx file is
      kept.
    </p>
    <p>
      We can extract the project directory from <tt class="verbatim">$$r</tt>, and
      derive the probable Lyx filename from the noweb file that Lyx generated.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-lyx-build-helper-1"></a>
        <table style="width: 100%" id="code-ref-lyx-build-helper-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="lyx-build-helper"></a><font size="-1"><div class="left-tab">
              <font color="blue">lyx-build-helper</font>[1](), lang=<font color="blue">sh</font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-lyx-build-helper-2">83c</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>PROJECT_DIR=&quot;$LYX_r&quot;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>LYX_SRC=&quot;$PROJECT_DIR/${LYX_i%.tex}.lyx&quot;
<tt>3  </tt>TEX_DIR=&quot;$LYX_p&quot;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>TEX_SRC=&quot;$TEX_DIR/$LYX_i&quot;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-lyx-build-helper-1"></a>
      </p></font>
    </p>
    <p>
      And then we can define a lyx-build fragment similar to the autoboot
      fragment
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-lyx-build-1"></a>
        <table style="width: 100%" id="code-ref-lyx-build-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="lyx-build"></a><font size="-1"><div class="left-tab">
              <font color="blue">lyx-build</font>[1](), lang=<font color="blue">sh</font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-lyx-build-2">83a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>#! /bin/sh
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>=&lt;\chunkref{lyx-build-helper}&gt;
<tt>3  </tt>cd $PROJECT_DIR || exit 1
<tt>4  </tt>
<tt>5  </tt>#/usr/bin/fangle -filter ./notanglefix-filter \
<tt>6  </tt>#  -R./Makefile.inc &quot;../../noweb-lyx/noweb-lyx3.lyx&quot; \
<tt>7  </tt>#  | sed '/NOWEB_SOURCE=/s/=.*/=samba4-dfs.lyx/' \
<tt>8  </tt>#  &gt; ./Makefile.inc
<tt>9  </tt>#</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>#make -f ./Makefile.inc fangle_sources
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-lyx-build-1"></a>
      </p></font>
    </p>
    <p>
      
    </p>
    <h1 id="auto-21">Chapter 5<br></br>Using Fangle with TeXmacs</h1>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: Write this chapter</td>
      </tr></tbody>
    </table>
    <h1 id="auto-22"><a id="makefile.inc"></a>Chapter 6<br></br>Fangle with Makefiles</h1>
    <p>
      Here we describe a <tt class="verbatim">Makefile.inc</tt> that you can include in
      your own Makefiles, or glue as a recursive make to other projects.
    </p>
    <p>
      <tt class="verbatim">Makefile.inc</tt> will cope with extracting all the other
      source files from this or any specified literate document and keeping
      them up to date. 
    </p>
    <p>
      It may also be included by a <tt class="verbatim">Makefile</tt> or <tt class="verbatim">Makefile.am</tt>
      defined in a literate document to automatically deal with the extraction
      of source files and documents during normal builds.
    </p>
    <p>
      Thus, if <tt class="verbatim">Makefile.inc</tt> is included into a main project
      makefile it add rules for the source files, capable of extracting the
      source files from the literate document.
    </p>
    <h2 id="auto-23">6.1<span style="margin-left: 1em"></span>A word about makefiles formats</h2>
    <p>
      Whitespace formatting is very important in a Makefile. The first
      character of each action line must be a TAB. 
    </p>
    <pre class="verbatim" xml:space="preserve">
target: pre-requisite
&#x21A6;action
&#x21A6;action</pre>
    <p>
      This requires that the literate programming environment have the ability
      to represent a TAB character in a way that fangle will generate an
      actual TAB character.
    </p>
    <p>
      We also adopt a convention that code chunks whose names beginning with
      <tt class="verbatim">./</tt> should always be automatically extracted from the
      document. Code chunks whose names do not begin with <tt class="verbatim">./</tt>
      are for internal reference. Such chunks may be extracted directly, but
      will not be automatically extracted by this Makefile.
    </p>
    <h2 id="auto-24">6.2<span style="margin-left: 1em"></span>Extracting Sources</h2>
    <p>
      Our makefile has two parts; variables must be defined before the targets
      that use them.
    </p>
    <p>
      As we progress through this chapter, explaining concepts, we will be
      adding lines to Makefile.inc-vars <a href="#code-ref-Makefile.inc-vars-1">23b</a> and
      Makefile.inc-targets <a href="#code-ref-Makefile.inc-targets-1">24b</a> which are included in
      ./Makefile.inc <a href="#code-ref-./Makefile.inc-1">23a</a> below.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./Makefile.inc-1"></a>
        <table style="width: 100%" id="code-ref-./Makefile.inc-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./Makefile.inc"></a><font size="-1"><font color="blue">./Makefile.inc</font>[1](),
            lang=<font color="blue">make</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>Makefile.inc-vars <a href="#code-ref-Makefile.inc-vars-1">23b</a>
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>Makefile.inc-targets <a href="#code-ref-Makefile.inc-targets-1">24b</a>
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-./Makefile.inc-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We first define a placeholder for <tt class="verbatim">LITERATE_SOURCE</tt> to
      hold the name of this document. This will normally be passed on the
      command line.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-1"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-Makefile.inc-vars-2">24a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>LITERATE_SOURCE=
        </div></tt>
      </p><p>
        <a id="code-end-Makefile.inc-vars-1"></a>
      </p></font>
    </p>
    <p>
      Fangle cannot process L
      <span style="margin-left: -0.1667em"></span>
      Y
      <span style="margin-left: -0.125em"></span>
      X or TeXmacs documents directly, so the first stage is to convert these
      to more suitable text based formats
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X and TeXmacs
                formats are text-based, but not suitable for fangle
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-1"></a>
      <sup><a href="#footnote-1">1</a></sup>
      .
    </p>
    <h3 id="auto-25"><a id="Converting-from-Lyx"></a>6.2.1<span style="margin-left: 1em"></span>Converting from L<span style="margin-left: -0.1667em"></span>Y<span
    style="margin-left: -0.125em"></span>X to LaTeX</h3>
    <p>
      The first stage will always be to convert the L
      <span style="margin-left: -0.1667em"></span>
      Y
      <span style="margin-left: -0.125em"></span>
      X file to a LaTeX file. Fangle must run on a TeX file because the L
      <span style="margin-left: -0.1667em"></span>
      Y
      <span style="margin-left: -0.125em"></span>
      X command
      <tt class="verbatim">server-goto-file-line</tt>
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . The Lyx command <tt class="verbatim">server-goto-file-line</tt> is
                used to position the Lyx cursor at the compiler errors.
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-2"></a>
      <sup><a href="#footnote-2">2</a></sup>
      requries that the line number provided be a line of the TeX file and
      always maps this the line in the L
      <span style="margin-left: -0.1667em"></span>
      Y
      <span style="margin-left: -0.125em"></span>
      X docment. We use
      <tt class="verbatim">server-goto-file-line</tt>
      when moving the cursor to error lines during compile failures.
    </p>
    <p>
      The command <tt class="verbatim">lyx -e literate fangle.lyx</tt> will produce <tt
      class="verbatim">fangle.tex</tt>, a TeX file; so we define a make target to be the
      same as the L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X file but with
      the <tt class="verbatim">.tex</tt> extension.
    </p>
    <p>
      The <tt class="verbatim">EXTRA_DIST</tt> is for automake support so that the TeX
      files will automaticaly be distributed with the source, to help those
      who don't have L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X installed.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-2"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[2]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-vars-1">23b</a> <a href="#code-ref-Makefile.inc-vars-3">24c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>TEX_SOURCE=$(LYX_SOURCE:.lyx=.tex)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>EXTRA_DIST+=$(TEX_SOURCE)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-vars-2"></a>
      </p></font>
    </p>
    <p>
      We then specify that the TeX source is to be generated from the L<span
      style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X source.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-1"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-Makefile.inc-targets-2">24d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>$(TEX_SOURCE): $(LYX_SOURCE)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>&#x21A6;lyx -e latex $&lt;
<tt>3  </tt>clean_tex:
<tt>4  </tt>&#x21A6;rm -f -- $(TEX_SOURCE)</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>clean: clean_tex
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-1"></a>
      </p></font>
    </p>
    <h3 id="auto-26"><a id="Converting-from-Lyx"></a>6.2.2<span style="margin-left: 1em"></span>Converting from TeXmacs</h3>
    <p>
      Fangle cannot process TeXmacs files directly
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . but this is planned when TeXmacs uses xml as it's native
                format
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-3"></a>
      <sup><a href="#footnote-3">3</a></sup>
      , but must first convert them to text files.
    </p>
    <p>
      The command <tt class="verbatim">texmacs -c fangle.tm fangle.txt -q</tt> will
      produce <tt class="verbatim">fangle.txt</tt>, a text file; so we define a make
      target to be the same as the TeXmacs file but with the <tt class="verbatim">.txt</tt>
      extension.
    </p>
    <p>
      The <tt class="verbatim">EXTRA_DIST</tt> is for automake support so that the TeX
      files will automaticaly be distributed with the source, to help those
      who don't have L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X installed.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-3"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[3]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-2">24a</a> <a href="#code-ref-Makefile.inc-vars-4">25a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>TXT_SOURCE=$(LITERATE_SOURCE:.tm=.txt)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>EXTRA_DIST+=$(TXT_SOURCE)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-vars-3"></a>
      </p></font>
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: Add loop around each $&lt; so multiple
        targets can be specified</td>
      </tr></tbody>
    </table>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-2"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[2]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-targets-1">24b</a> <a href="#code-ref-Makefile.inc-targets-3">25c</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>$(TXT_SOURCE): $(LITERATE_SOURCE)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>7  </tt>&#x21A6;texmacs -c $&lt; $(TXT_SOURCE) -q
<tt>8  </tt>clean_txt:
<tt>9  </tt>&#x21A6;rm -f -- $(TXT_SOURCE)</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>clean: clean_txt
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-2"></a>
      </p></font>
    </p>
    <h2 id="auto-27">6.3<span style="margin-left: 1em"></span>Extracting Program Source</h2>
    <p>
      The program source is extracted using fangle, which is designed to
      operate on text or a LaTeX documents
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . LaTeX documents are just slightly special text documents
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-4"></a>
      <sup><a href="#footnote-4">4</a></sup>
      .
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-4"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[4]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-vars-3">24c</a> <a href="#code-ref-Makefile.inc-vars-5">25b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>6  </tt>FANGLE_SOURCE=$(TEX_SOURCE) $(TXT_SOURCE)
        </div></tt>
      </p><p>
        <a id="code-end-Makefile.inc-vars-4"></a>
      </p></font>
    </p>
    <p>
      The literate document can result in any number of source files, but not
      all of these will be changed each time the document is updated. We
      certainly don't want to update the timestamps of these files and cause
      the whole source tree to be recompiled just because the literate
      explanation was revised. We use <tt class="verbatim">CPIF</tt> from the
      <em>Noweb</em> tools to avoid updating the file if the content has not
      changed, but should probably write our own.
    </p>
    <p>
      However, if a source file is not updated, then the fangle file will
      always have a newer time-stamp and the makefile would always re-attempt
      to extact a newer source file which would be a waste of time.
    </p>
    <p>
      Because of this, we use a stamp file which is always updated each time
      the sources are fully extracted from the LaTeX document. If the stamp
      file is newer than the document, then we can avoid an attempt to
      re-extract any of the sources. Because this stamp file is only updated
      when extraction is complete, it is safe for the user to interrupt the
      build-process mid-extraction.
    </p>
    <p>
      We use <tt class="verbatim">echo</tt> rather than <tt class="verbatim">touch</tt> to update
      the stamp file beause the <tt class="verbatim">touch</tt> command does not work
      very well over an <tt class="verbatim">sshfs</tt>mount  that I was using.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-5"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[5]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-4">25a</a> <a href="#code-ref-Makefile.inc-vars-6">26a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>7  </tt>FANGLE_SOURCE_STAMP=$(FANGLE_SOURCE).stamp
        </div></tt>
      </p><p>
        <a id="code-end-Makefile.inc-vars-5"></a>
      </p></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-3"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[3]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-targets-2">24d</a> <a href="#code-ref-Makefile.inc-targets-4">26b</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>11  </tt>$(FANGLE_SOURCE_STAMP): $(FANGLE_SOURCE) \
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>12  </tt>&#x21A6;                $(FANGLE_SOURCES) ; \
<tt>13  </tt>&#x21A6;echo -n &gt; $(FANGLE_SOURCE_STAMP)
<tt>14  </tt>clean_stamp:
<tt>15  </tt>&#x21A6;rm -f $(FANGLE_SOURCE_STAMP)</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>16  </tt>clean: clean_stamp
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-3"></a>
      </p></font>
    </p>
    <h2 id="auto-28">6.4<span style="margin-left: 1em"></span>Extracting Source Files</h2>
    <p>
      We compute <tt class="verbatim">FANGLE_SOURCES</tt> to hold the names of all the
      source files defined in the document. We compute this only once, by
      means of <tt class="verbatim">:=</tt> in assignent. The sed deletes the any <tt
      class="verbatim">&lt;&lt;</tt> and <tt class="verbatim">&gt;&gt;</tt> which may surround the
      roots names (for compatibility with Noweb's noroots command).
    </p>
    <p>
      As we use chunk names beginning with <tt class="verbatim">./</tt> to denote top
      level fragments that should be extracted, we filter out all fragments
      that do not begin with <tt class="verbatim">./</tt>
    </p>
    <p style="margin-top: 1em; margin-bottom: 1em">
      <b>Note <class style="font-style: normal">1</class>. </b><tt class="verbatim">FANGLE_PREFIX</tt> is
      set to <tt class="verbatim">./</tt> by default, but whatever it may be overridden
      to, the prefix is replaced by a literal <tt class="verbatim">./</tt> before
      extraction so that files will be extracted in the current directory
      whatever the prefix. This helps namespace or sub-project prefixes like
      <tt class="verbatim">documents:</tt> for chunks like <tt class="verbatim">documents:docbook/intro.xml</tt>
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: This doesn't work though, because it loses
        the full name and doesn't know what to extact!</td>
      </tr></tbody>
    </table>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-6"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-6">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[6]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-vars-5">25b</a> <a href="#code-ref-Makefile.inc-vars-7">26e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>8  </tt>FANGLE_PREFIX:=\.\/
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>9  </tt>FANGLE_SOURCES:=$(shell \
<tt>10  </tt>  fangle -r $(FANGLE_SOURCE) |\
<tt>11  </tt>  sed -e 's/^[&lt;][&lt;]//;s/[&gt;][&gt;]$$//;/^$(FANGLE_PREFIX)/!d' \</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>12  </tt>      -e 's/^$(FANGLE_PREFIX)/\.\//' )
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-vars-6"></a>
      </p></font>
    </p>
    <p>
      The target below, <tt class="verbatim">echo_fangle_sources</tt> is a helpful
      debugging target and shows the names of the files that would be
      extracted.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-4"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[4]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-targets-3">25c</a> <a href="#code-ref-Makefile.inc-targets-5">26c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>17  </tt>.PHONY: echo_fangle_sources
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>echo_fangle_sources: ; @echo $(FANGLE_SOURCES)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-4"></a>
      </p></font>
    </p>
    <p>
      We define a convenient target called <tt class="verbatim">fangle_sources</tt> so
      that <tt class="verbatim">make -f fangle_sources</tt> will re-extract the source
      if the literate document has been updated. 
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-5"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[5]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-targets-4">26b</a> <a href="#code-ref-Makefile.inc-targets-6">26d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>19  </tt>.PHONY: fangle_sources
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>20  </tt>fangle_sources: $(FANGLE_SOURCE_STAMP)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-5"></a>
      </p></font>
    </p>
    <p>
      And also a convenient target to remove extracted sources.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-6"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-6">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[6]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-targets-5">26c</a> <a href="#code-ref-Makefile.inc-targets-7">27d</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>21  </tt>.PHONY: clean_fangle_sources
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>22  </tt>clean_fangle_sources: ; \</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>23  </tt>        rm -f &ndash; $(FANGLE_SOURCE_STAMP)
            $(FANGLE_SOURCES)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-6"></a>
      </p></font>
    </p>
    <p>
      We now look at the extraction of the source files.
    </p>
    <p>
      This makefile macro <tt class="verbatim">if_extension</tt> takes 4 arguments: the
      filename <tt class="verbatim">$(1)</tt>, some extensions to match <tt class="verbatim">$(2)</tt>
      and a shell command to return if the filename does match the exensions
      <tt class="verbatim">$(3)</tt>, and a shell command to return if it does not match
      the extensions <tt class="verbatim">$(4)</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-7"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-7">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[7]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-6">26a</a> <a href="#code-ref-Makefile.inc-vars-8">26f</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>13  </tt>if_extension=$(if $(findstring $(suffix
          $(1)),$(2)),$(3),$(4))
        </div></tt>
      </p><p>
        <a id="code-end-Makefile.inc-vars-7"></a>
      </p></font>
    </p>
    <p>
      For some source files like C files, we want to output the line number
      and filename of the original LaTeX document from which the source came
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . I plan to replace this option with a separate mapping file
                so as not to pollute the generated source, and also to allow a
                code pretty-printing reformatter like <tt class="verbatim">indent</tt>
                be able to re-format the file and adjust for changes through
                comparing the character streams.
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-5"></a>
      <sup><a href="#footnote-5">5</a></sup>
      .
    </p>
    <p>
      To make this easier we define the file extensions for which we want to
      do this.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-8"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-8">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[8]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-7">26e</a> <a href="#code-ref-Makefile.inc-vars-9">26g</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>14  </tt>C_EXTENSIONS=.c .h
        </div></tt>
      </p><p>
        <a id="code-end-Makefile.inc-vars-8"></a>
      </p></font>
    </p>
    <p>
      We can then use the <tt class="verbatim">if_extensions</tt> macro to define a
      macro which expands out to the <tt class="verbatim">-L</tt> option if fangle is
      being invoked in a C source file, so that C compile errors will refer to
      the line number in the TeX document. 
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-9"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-9">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[9]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-8">26f</a> <a href="#code-ref-Makefile.inc-vars-10">27a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>15  </tt>TABS=8
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>16  </tt>nf_line=-L -T$(TABS)</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>17  </tt>fangle=fangle $(call
            if_extension,$(2),$(C_EXTENSIONS),$(nf_line)) -R&quot;$(2)&quot;
            $(1)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-vars-9"></a>
      </p></font>
    </p>
    <p>
      We can use a similar trick to define an indent macro which takes just
      the filename as an argument and can return a pipeline stage calling the
      indent command. Indent can be turned off with <tt class="verbatim">make
      fangle_sources indent=</tt>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-10"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-10">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[10]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-vars-9">26g</a> <a href="#code-ref-Makefile.inc-vars-11">27b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>indent_options=-npro -kr -i8 -ts8 -sob -l80 -ss -ncs
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>19  </tt>indent=$(call if_extension,$(1),$(C_EXTENSIONS), |
            indent $(indent_options))
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-vars-10"></a>
      </p></font>
    </p>
    <p>
      We now define the pattern for extracting a file. The files are written
      using noweb's <tt class="verbatim">cpif</tt> so that the file timestamp will not
      be touched if the contents haven't changed. This avoids the need to
      rebuild the entire project because of a typographical change in the
      documentation, or if none or a few C source files have changed.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-11"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-11">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[11]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-10">27a</a> <a href="#code-ref-Makefile.inc-vars-12">27c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>20  </tt>fangle_extract=@mkdir -p $(dir $(1)) &amp;&amp; \
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>21  </tt>  $(call fangle,$(2),$(1)) &gt; &quot;$(1).tmp&quot; &amp;&amp; \
<tt>22  </tt>  cat &quot;$(1).tmp&quot; $(indent) | cpif &quot;$(1)&quot; \
<tt>23  </tt>  &amp;&amp; rm -- &quot;$(1).tmp&quot; || \</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>24  </tt>  (echo error newfangling $(1) from $(2) ; exit 1)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-vars-11"></a>
      </p></font>
    </p>
    <p>
      We define a target which will extract or update all sources. To do this
      we first defined a makefile template that can do this for any source
      file in the LaTeX document.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-12"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-12">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[12]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-11">27b</a> <a href="#code-ref-Makefile.inc-vars-13">28a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>25  </tt>define FANGLE_template
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>26  </tt>  $(1): $(2)
<tt>27  </tt>&#x21A6;$$(call fangle_extract,$(1),$(2))
<tt>28  </tt>  FANGLE_TARGETS+=$(1)</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>29  </tt>endef
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-vars-12"></a>
      </p></font>
    </p>
    <p>
      We then enumerate the discovered <tt class="verbatim">FANGLE_SOURCES</tt> to
      generate a makefile rule for each one using the makefile template we
      defined above.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-7"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-7">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[7]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-targets-6">26d</a> <a href="#code-ref-Makefile.inc-targets-8">27e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>24  </tt>$(foreach source,$(FANGLE_SOURCES),\
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>25  </tt>  $(eval $(call FANGLE_template,$(source),$(FANGLE_SOURCE))) \</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>26  </tt>)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-7"></a>
      </p></font>
    </p>
    <p>
      These will all be built with <tt class="verbatim">FANGLE_SOURCE_STAMP</tt>.
    </p>
    <p>
      We also remove the generated sources on a make distclean.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-8"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-8">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[8]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-targets-7">27d</a> <a href="#code-ref-Makefile.inc-targets-9">28b</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>27  </tt>_distclean: clean_fangle_sources
        </div></tt>
      </p><p>
        <a id="code-end-Makefile.inc-targets-8"></a>
      </p></font>
    </p>
    <h2 id="auto-29">6.5<span style="margin-left: 1em"></span>Extracting Documentation</h2>
    <p>
      We then identify the intermediate stages of the documentation and their
      build and clean targets.
    </p>
    <h3 id="auto-30">6.5.1<span style="margin-left: 1em"></span>Formatting TeX</h3>
    <h4 id="auto-31">6.5.1.1<span style="margin-left: 1em"></span>Running pdflatex</h4>
    <p>
      We produce a pdf file from the tex file.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-13"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-13">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[13]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-vars-12">27c</a> <a href="#code-ref-Makefile.inc-vars-14">28c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>30  </tt>FANGLE_PDF=$(TEX_SOURCE:.tex=.pdf)
        </div></tt>
      </p><p>
        <a id="code-end-Makefile.inc-vars-13"></a>
      </p></font>
    </p>
    <p>
      We run pdflatex twice to be sure that the contents and aux files are up
      to date. We certainly are <em>required</em> to run pdflatex at least
      twice if these files do not exist.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-9"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-9">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[9]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-Makefile.inc-targets-8">27e</a> <a href="#code-ref-Makefile.inc-targets-10">28d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>28  </tt>$(FANGLE_PDF): $(TEX_SOURCE)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>29  </tt>&#x21A6;pdflatex $&lt; &amp;&amp; pdflatex $&lt;
<tt>30  </tt>
<tt>31  </tt>clean_pdf:
<tt>32  </tt>&#x21A6;rm -f -- $(FANGLE_PDF) $(TEX_SOURCE:.tex=.toc) \</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>33  </tt>&#x21A6;  $(TEX_SOURCE:.tex=.log)
            $(TEX_SOURCE:.tex=.aux)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-9"></a>
      </p></font>
    </p>
    <h3 id="auto-32">6.5.2<span style="margin-left: 1em"></span>Formatting TeXmacs</h3>
    <p>
      TeXmacs can produce a PDF file directly.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-14"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-14">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[14]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-13">28a</a> <a href="#code-ref-Makefile.inc-vars-15">28e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>31  </tt>FANGLE_PDF=$(TEX_SOURCE:.tm=.pdf)
        </div></tt>
      </p><p>
        <a id="code-end-Makefile.inc-vars-14"></a>
      </p></font>
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: <p>
          Outputting the PDF may not be enough to update the links and page
          references. I think
        </p><p>
          we need to update twice, generate a pdf, update twice mode and
          generate a new PDF.
        </p><p>
          Basically the PDF export of TeXmacs is pretty rotten and doesn't
          work properly from the CLI
        </p></td>
      </tr></tbody>
    </table>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-10"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-10">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[10]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-targets-9">28b</a> <a href="#code-ref-Makefile.inc-targets-11">28f</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>34  </tt>$(FANGLE_PDF): $(TEXMACS_SOURCE)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>35  </tt>&#x21A6;texmacs -c $(TEXMACS_SOURCE) $&lt; -q
<tt>36  </tt>
<tt>37  </tt>clean_pdf:</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>38  </tt>&#x21A6;rm -f &ndash; $(FANGLE_PDF)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-10"></a>
      </p></font>
    </p>
    <h3 id="auto-33">6.5.3<span style="margin-left: 1em"></span>Building the Documentation as a
    Whole</h3>
    <p>
      Currently we only build pdf as a final format, but <tt class="verbatim">FANGLE_DOCS</tt>
      may later hold other output formats.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-vars-15"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-vars-15">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-vars"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-vars</font>[15]() &uArr;<a href="#code-ref-Makefile.inc-vars-1">23b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-vars-14">28c</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>32  </tt>FANGLE_DOCS=$(FANGLE_PDF)
        </div></tt>
      </p><table style="width: 100%" id="code-end-Makefile.inc-vars-15">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We also define <tt class="verbatim">fangle_docs</tt> as a convenient phony target.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-11"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-11">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[11]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-targets-10">28d</a> <a href="#code-ref-Makefile.inc-targets-12">28g</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>39  </tt>.PHONY: fangle_docs
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>40  </tt>fangle_docs: $(FANGLE_DOCS)</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>41  </tt>docs: fangle_docs
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-Makefile.inc-targets-11"></a>
      </p></font>
    </p>
    <p>
      And define a convenient <tt class="verbatim">clean_fangle_docs</tt> which we add
      to the regular clean target
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-Makefile.inc-targets-12"></a>
        <table style="width: 100%" id="code-ref-Makefile.inc-targets-12">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Makefile.inc-targets"></a><font size="-1"><div class="left-tab">
              <font color="blue">Makefile.inc-targets</font>[12]() &uArr;<a href="#code-ref-Makefile.inc-targets-1">24b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-Makefile.inc-targets-11">28f</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>42  </tt>.PHONEY: clean_fangle_docs
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>43  </tt>clean_fangle_docs: clean_tex clean_pdf
<tt>44  </tt>clean: clean_fangle_docs
<tt>45  </tt>
<tt>46  </tt>distclean_fangle_docs: clean_tex clean_fangle_docs</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>47  </tt>distclean: clean distclean_fangle_docs
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-Makefile.inc-targets-12">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-34">6.6<span style="margin-left: 1em"></span>Other helpers</h2>
    <p>
      If <tt class="verbatim">Makefile.inc</tt> is included into <tt class="verbatim">Makefile</tt>,
      then extracted files can be updated with this command:
    </p>
    <pre class="verbatim" xml:space="preserve">
make fangle_sources</pre>
    <p>
      otherwise, with:
    </p>
    <pre class="verbatim" xml:space="preserve">
make -f Makefile.inc fangle_sources</pre>
    <h2 id="auto-35">6.7<span style="margin-left: 1em"></span>Boot-strapping the extraction</h2>
    <p>
      As well as having the makefile extract or update the source files as
      part of it's operation, it also seems convenient to have the makefile
      re-extracted itself from <em>this</em> document.
    </p>
    <p>
      It would also be convenient to have the code that extracts the makefile
      from this document to also be part of this document, however we have to
      start somewhere and this unfortunately requires us to type at least a
      few words by hand to start things off.
    </p>
    <p>
      Therefore we will have a minimal root fragment, which, when extracted,
      can cope with extracting the rest of the source. This shell script
      fragment can do that. It's name is <tt class="verbatim">*</tt> <class style="font-family: Times New Roman">&mdash;</class>
      out of regard for <class style="font-variant: small-caps">Noweb</class>, but when extracted might
      better be called <tt class="verbatim">autoupdate</tt>.
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: De-lyxify</td>
      </tr></tbody>
    </table>
    <p>
      <font size="-1"><p>
        <a id="code-label-*-1"></a>
        <table style="width: 100%" id="code-ref-*-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="*"></a><font size="-1"><font color="blue">*</font>[1](),
            lang=<font color="blue">sh</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>#! /bin/sh
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>
<tt>3  </tt>MAKE_SRC=&quot;${1:-${NW_LYX:-../../noweb-lyx/noweb-lyx3.lyx}}&quot;
<tt>4  </tt>MAKE_SRC=&lsquo;dirname &quot;$MAKE_SRC&quot;&lsquo;/&lsquo;basename &quot;$MAKE_SRC&quot; .lyx&lsquo;
<tt>5  </tt>NOWEB_SRC=&quot;${2:-${NOWEB_SRC:-$MAKE_SRC.lyx}}&quot;
<tt>6  </tt>lyx -e latex $MAKE_SRC
<tt>7  </tt>
<tt>8  </tt>fangle -R./Makefile.inc ${MAKE_SRC}.tex \
<tt>9  </tt>  | sed &quot;/FANGLE_SOURCE=/s/^/#/;T;aNOWEB_SOURCE=$FANGLE_SRC&quot; \
<tt>10  </tt>  | cpif ./Makefile.inc
<tt>11  </tt></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>12  </tt>make -f ./Makefile.inc fangle_sources
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-*-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      The general Makefile can be invoked with <tt class="verbatim">./autoboot</tt> and
      can also be included into any automake file to automatically re-generate
      the source files.
    </p>
    <p>
      The <em>autoboot</em> can be extracted with this command:
    </p>
    <pre class="verbatim" xml:space="preserve">
lyx -e latex fangle.lyx &amp;&amp; \
  fangle fangle.lyx &gt; ./autoboot</pre>
    <p>
      This looks simple enough, but as mentioned, fangle has to be had from
      somewhere before it can be extracted.
    </p>
    <p>
      On a unix system this will extract <tt class="verbatim">fangle.module</tt> and the
      <tt class="verbatim">fangle</tt> awk script, and run some basic tests. 
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: cross-ref to test chapter when it is a
        chapter all on its own</td>
      </tr></tbody>
    </table>
    <h2 id="auto-36">6.8<span style="margin-left: 1em"></span>Incorporating Makefile.inc into existing
    projects</h2>
    <p>
      If you are writing a literate module of an existing non-literate program
      you may find it easier to use a slight recursive make instead of
      directly including <tt class="verbatim">Makefile.inc</tt> in the projects
      makefile. 
    </p>
    <p>
      This way there is less chance of definitions in <tt class="verbatim">Makefile.inc</tt>
      interfering with definitions in the main makefile, or with definitions
      in other <tt class="verbatim">Makefile.inc</tt> from other literate modules of the
      same project.
    </p>
    <p>
      To do this we add some <em>glue</em> to the project makefile that
      invokes Makefile.inc in the right way. The glue works by adding a <tt
      class="verbatim">.PHONY</tt> target to call the recursive make, and adding this
      target as an additional pre-requisite to the existing targets.
    </p>
    <p>
      <a id="auto-37"></a><h5>Example</h5>Sub-module of existing system
    </p>
    <p>
      In this example, we are building <tt class="verbatim">module.so</tt> as a literate
      module of a larger project.
    </p>
    <p>
      We will show the sort glue that can be inserted into the projects
      Makefile <class style="font-family: Times New Roman">&mdash;</class> or more likely <class style="font-family: Times New Roman">&mdash;</class>
      a regular Makefile included in or invoked by the projects Makefile.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-makefile-glue-1"></a>
        <table style="width: 100%" id="code-ref-makefile-glue-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="makefile-glue"></a><font size="-1"><div class="left-tab">
              <font color="blue">makefile-glue</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-makefile-glue-2">30b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>module_srcdir=modules/module
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>MODULE_SOURCE=module.tm</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>MODULE_STAMP=$(MODULE_SOURCE).stamp
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-makefile-glue-1"></a>
      </p></font>
    </p>
    <p>
      The existing build system may already have a build target for
      <tt class="verbatim">module.o</tt>
      , but we just add another pre-requisite to that. In this case we use
      <tt class="verbatim">module.tm.stamp</tt>
      as a pre-requisite, the stamp file's modified time indicating when all
      sources were extracted
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . If the projects build system does not know how to build the
                module from the extracted sources, then just add build actions
                here as normal.
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-6"></a>
      <sup><a href="#footnote-6">6</a></sup>
      .
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-makefile-glue-2"></a>
        <table style="width: 100%" id="code-ref-makefile-glue-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="makefile-glue"></a><font size="-1"><div class="left-tab">
              <font color="blue">makefile-glue</font>[2]() &uArr;<a href="#code-ref-makefile-glue-1">30a</a>,
              lang=<font color="blue">make</font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-makefile-glue-1">30a</a> <a href="#code-ref-makefile-glue-3">30c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>4  </tt>$(module_srcdir)/module.o:
          $(module_srcdir)/$(MODULE_STAMP)
        </div></tt>
      </p><p>
        <a id="code-end-makefile-glue-2"></a>
      </p></font>
    </p>
    <p>
      The target for this new pre-requisite will be generated by a recursive
      make using <tt class="verbatim">Makefile.inc</tt> which will make sure that the
      source is up to date, before it is built by the main projects makefile.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-makefile-glue-3"></a>
        <table style="width: 100%" id="code-ref-makefile-glue-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="makefile-glue"></a><font size="-1"><div class="left-tab">
              <font color="blue">makefile-glue</font>[3]() &uArr;<a href="#code-ref-makefile-glue-1">30a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-makefile-glue-2">30b</a> <a href="#code-ref-makefile-glue-4">30d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>$(module_srcdir)/$(MODULE_STAMP):
            $(module_srcdir)/$(MODULE_SOURCE)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>&#x21A6;$(MAKE) -C $(module_srcdir) -f Makefile.inc
            fangle_sources LITERATE_SOURCE=$(MODULE_SOURCE)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-makefile-glue-3"></a>
      </p></font>
    </p>
    <p>
      We can do similar glue for the docs, clean and distclean targets. In
      this example the main prject was using a double colon for these targets,
      so we must use the same in our glue.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-makefile-glue-4"></a>
        <table style="width: 100%" id="code-ref-makefile-glue-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="makefile-glue"></a><font size="-1"><div class="left-tab">
              <font color="blue">makefile-glue</font>[4]() &uArr;<a href="#code-ref-makefile-glue-1">30a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-makefile-glue-3">30c</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>docs:: docs_module
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>8  </tt>.PHONY: docs_module
<tt>9  </tt>docs_module:
<tt>10  </tt>&#x21A6;$(MAKE) -C $(module_srcdir) -f Makefile.inc docs LITERATE_SOURCE=$(MODULE_SOURCE)
<tt>11  </tt>
<tt>12  </tt>clean:: clean_module
<tt>13  </tt>.PHONEY: clean_module
<tt>14  </tt>clean_module:
<tt>15  </tt>&#x21A6;$(MAKE) -C $(module_srcdir) -f Makefile.inc clean LITERATE_SOURCE=$(MODULE_SOURCE)
<tt>16  </tt>
<tt>17  </tt>distclean:: distclean_module
<tt>18  </tt>.PHONY: distclean_module
<tt>19  </tt>distclean_module:</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>20  </tt>&#x21A6;$(MAKE) -C $(module_srcdir) -f Makefile.inc
            distclean LITERATE_SOURCE=$(MODULE_SOURCE)
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-makefile-glue-4">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We could do similarly for install targets to install the generated docs.
    </p>
    <p style="margin-top: 25%; margin-bottom: 10%">
      <a id="auto-38"></a><br></br><b><font size="+5"><div class="center-tab">
        Part II
      </div><div class="right-tab">
        <br></br>Source Code
      </div></font></b>
    </p>
    <h1 id="auto-39">Chapter 7<br></br>Fangle awk source code</h1>
    <p>
      We use the copyright notice from chapter <a href="#License">2</a>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle-1"></a>
        <table style="width: 100%" id="code-ref-./fangle-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle</font>[1](), lang=<font color="blue">awk</font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-./fangle-2">33b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>#! /usr/bin/awk -f
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt># gpl3-copyright <a href="#code-ref-gpl3-copyright-1">4a</a>
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle-1"></a>
      </p></font>
    </p>
    <p>
      We also use code from <class style="font-variant: small-caps">Arnold Robbins</class> public domain
      getopt (1993 revision) defined in <a href="#getopt">73a</a>, and naturally want
      to attribute this appropriately.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle-2"></a>
        <table style="width: 100%" id="code-ref-./fangle-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle</font>[2]() &uArr;<a href="#code-ref-./fangle-1">33a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle-1">33a</a> <a href="#code-ref-./fangle-3">33c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt># NOTE: Arnold Robbins public domain getopt for awk is
            also used:
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>4  </tt>getopt.awk-header <a href="#code-ref-getopt.awk-header-1">71a</a>
<tt>5  </tt>getopt.awk-getopt() <a href="#code-ref-getopt.awk-getopt()-1">71c</a></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle-2"></a>
      </p></font>
    </p>
    <p>
      And include the following chunks (which are explained further on) to
      make up the program:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle-3"></a>
        <table style="width: 100%" id="code-ref-./fangle-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle</font>[3]() &uArr;<a href="#code-ref-./fangle-1">33a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle-2">33b</a> <a href="#code-ref-./fangle-4">36a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>helper-functions <a href="#code-ref-helper-functions-1">34d</a>
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>8  </tt>mode-tracker <a href="#code-ref-mode-tracker-1">52a</a>
<tt>9  </tt>parse_chunk_args <a href="#code-ref-parse_chunk_args-1">38a</a>
<tt>10  </tt>chunk-storage-functions <a href="#code-ref-chunk-storage-functions-1">69b</a>
<tt>11  </tt>output_chunk_names() <a href="#code-ref-output_chunk_names()-1">63d</a>
<tt>12  </tt>output_chunks() <a href="#code-ref-output_chunks()-1">63e</a>
<tt>13  </tt>write_chunk() <a href="#code-ref-write_chunk()-1">64a</a>
<tt>14  </tt>expand_chunk_args() <a
        href="#code-ref-expand_chunk_args()-1">38b</a>
<tt>15  </tt>
<tt>16  </tt>begin <a href="#code-ref-begin-1">61d</a>
<tt>17  </tt>recognize-chunk <a href="#code-ref-recognize-chunk-1">55a</a></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>end <a href="#code-ref-end-1">63c</a>
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle-3"></a>
      </p></font>
    </p>
    <h2 id="auto-40">7.1<span style="margin-left: 1em"></span>AWK tricks</h2>
    <p>
      The portable way to erase an array in awk is to split the empty string,
      so we define a fangle macro that can split an array, like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-awk-delete-array-1"></a>
        <table style="width: 100%" id="code-ref-awk-delete-array-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="awk-delete-array"></a><font size="-1"><font color="blue">awk-delete-array</font>[1](<font
            color="blue">ARRAY</font>), lang=<font color="blue">awk</font>
            &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>split(&quot;&quot;, <font color="#008000">ARRAY</font>);
        </div></tt>
      </p><table style="width: 100%" id="code-end-awk-delete-array-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      For debugging it is sometimes convenient to be able to dump the contents
      of an array to <tt class="verbatim">stderr</tt>, and so this macro is also useful.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-dump-array-1"></a>
        <table style="width: 100%" id="code-ref-dump-array-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="dump-array"></a><font size="-1"><font color="blue">dump-array</font>[1](<font
            color="blue">ARRAY</font>), lang=<font color="blue">awk</font>
            &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>print &quot;\nDump: <font color="#008000">ARRAY</font>\n&ndash;&ndash;&ndash;&ndash;\n&quot;
            &gt; &quot;/dev/stderr&quot;;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>for (_x in <font color="#008000">ARRAY</font>) {
<tt>3  </tt>  print _x &quot;=&quot; <font color="#008000">ARRAY</font>[_x] &quot;\n&quot; &gt; &quot;/dev/stderr&quot;;
<tt>4  </tt>}</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>print &quot;========\n&quot; &gt;
            &quot;/dev/stderr&quot;;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-dump-array-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-41">7.2<span style="margin-left: 1em"></span>Catching errors</h2>
    <p>
      Fatal errors are issued with the error function:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-error()-1"></a>
        <table style="width: 100%" id="code-ref-error()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="error()"></a><font size="-1"><div class="left-tab">
              <font color="blue">error()</font>[1](), lang=<font color="blue">awk</font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-error()-2">34b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function error(message)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>{
<tt>3  </tt>  print &quot;ERROR: &quot; FILENAME &quot;:&quot; FNR &quot; &quot; message &gt; &quot;/dev/stderr&quot;;
<tt>4  </tt>  exit 1;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-error()-1"></a>
      </p></font>
    </p>
    <p>
      and likewise for non-fatal warnings:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-error()-2"></a>
        <table style="width: 100%" id="code-ref-error()-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="error()"></a><font size="-1"><div class="left-tab">
              <font color="blue">error()</font>[2]() &uArr;<a href="#code-ref-error()-1">34a</a>,
              lang=<font color="blue">awk</font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-error()-1">34a</a> <a href="#code-ref-error()-3">34c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>function warning(message)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>7  </tt>{
<tt>8  </tt>  print &quot;WARNING: &quot; FILENAME &quot;:&quot; FNR &quot; &quot; message &gt; &quot;/dev/stderr&quot;;
<tt>9  </tt>  warnings++;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-error()-2"></a>
      </p></font>
    </p>
    <p>
      and debug output too:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-error()-3"></a>
        <table style="width: 100%" id="code-ref-error()-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="error()"></a><font size="-1"><div class="left-tab">
              <font color="blue">error()</font>[3]() &uArr;<a href="#code-ref-error()-1">34a</a>,
              lang=<font color="blue">awk</font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-error()-2">34b</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>11  </tt>function debug_log(message)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>12  </tt>{
<tt>13  </tt>  print &quot;DEBUG: &quot; FILENAME &quot;:&quot; FNR &quot; &quot; message &gt; &quot;/dev/stderr&quot;;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>14  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-error()-3">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: append=helper-functions</td>
      </tr></tbody>
    </table>
    <p>
      <font size="-1"><p>
        <a id="code-label-helper-functions-1"></a>
        <table style="width: 100%" id="code-ref-helper-functions-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="helper-functions"></a><font size="-1"><font color="blue">helper-functions</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>error() <a href="#code-ref-error()-1">34a</a>
        </div></tt>
      </p><table style="width: 100%" id="code-end-helper-functions-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-42">Chapter 8<br></br>LaTeX and lstlistings</h1>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: Split LyX and TeXmacs parts</td>
      </tr></tbody>
    </table>
    <p>
      For L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X and LaTeX, the <tt
      class="verbatim">lstlistings</tt> package is used to format the lines of code
      chunks. You may recal from chapter XXX that arguments to a chunk
      definition are pure LaTeX code. This means that fangle needs to be able
      to parse LaTeX a little.
    </p>
    <p>
      LaTeX arguments to <tt class="verbatim">lstlistings</tt> macros are a comma
      seperated list of key-value pairs, and values containing commas are
      enclosed in <tt class="verbatim">{</tt> braces <tt class="verbatim">}</tt> (which is to be
      expected for LaTeX).
    </p>
    <p>
      A sample expressions is:
    </p>
    <pre class="verbatim" xml:space="preserve">
name=thomas, params={a, b}, something, something-else</pre>
    <p>
      but we see that this is just a simpler form of this expression:
    </p>
    <pre class="verbatim" xml:space="preserve">
name=freddie, foo={bar=baz, quux={quirk, a=fleeg}}, etc</pre>
    <p>
      We may consider that we need a function that can parse such LaTeX
      expressions and assign the values to an AWK associated array, perhaps
      using a recursive parser into a multi-dimensional hash
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . as AWK doesn't have nested-hash support
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-1"></a>
      <sup><a href="#footnote-1">1</a></sup>
      , resulting in:
    </p>
    <table style="display: inline; vertical-align: -3.3em">
      <tbody><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">key</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">value</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">a[name]</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">freddie</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">a[foo, bar]</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">baz</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">a[foo, quux, quirk]</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid"></td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">a[foo, quux, a]</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">fleeg</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">a[etc]</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid"></td>
      </tr></tbody>
    </table>
    <p>
      Yet, also, on reflection it seems that sometimes such nesting is not
      desirable, as the braces are also used to delimit values that contain
      commas &ndash;- we may consider that
    </p>
    <pre class="verbatim" xml:space="preserve">
name={williamson, freddie}</pre>
    <p>
      should assign <tt class="verbatim">williamson, freddie</tt> to <tt class="verbatim">name</tt>.
    </p>
    <p>
      In fact we are not so interested in the detail so as to be bothered by
      this, which turns out to be a good thing for two reasons. Firstly TeX
      has a malleable parser with no strict syntax, and secondly whether or
      not <tt class="verbatim">williamson</tt> and <tt class="verbatim">freddie</tt> should count
      as two items will be context dependant anyway.
    </p>
    <p>
      We need to parse this latex for only one reason; which is that we are
      extending lstlistings to add some additional arguments which will be
      used to express chunk parameters and other chunk options.
    </p>
    <h2 id="auto-43">8.1<span style="margin-left: 1em"></span>Additional lstlstings parameters</h2>
    <p>
      Further on we define a <tt class="verbatim">\Chunk</tt> LaTeX macro whose
      arguments will consist of a the chunk name, optionally followed by a
      comma and then a comma separated list of arguments. In fact we will just
      need to prefix <tt class="verbatim">name=</tt> to the arguments to in order to
      create valid lstlistings arguments. 
    </p>
    <p>
      There will be other arguments supported too; 
    </p>
    <dl>
      <dt>
        params
      </dt>
      <dd>
        <p>
          As an extension to many literate-programming styles, fangle permits
          code chunks to take parameters and thus operate somewhat like C
          pre-processor macros, or like C++ templates. Chunk parameters are
          declared with a chunk argument called params, which holds a
          semi-colon separated list of parameters, like this:
        </p>
        <pre class="verbatim" xml:space="preserve">
achunk,language=C,params=name;address</pre>
      </dd>
      <dt>
        addto
      </dt>
      <dd>
        a named chunk that this chunk is to be included into. This saves the
        effort of having to declare another listing of the named chunk merely
        to include this one.
      </dd>
    </dl>
    <p>
      Function get_chunk_args() will accept two paramters, text being the text
      to parse, and values being an array to receive the parsed values as
      described above. The optional parameter path is used during recursion to
      build up the multi-dimensional array path.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle-4"></a>
        <table style="width: 100%" id="code-ref-./fangle-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle</font>[4]() &uArr;<a href="#code-ref-./fangle-1">33a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-./fangle-3">33c</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>19  </tt>=&lt;\chunkref{get_chunk_args()}&gt;
        </div></tt>
      </p><table style="width: 100%" id="code-end-./fangle-4">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-get_chunk_args()-1"></a>
        <table style="width: 100%" id="code-ref-get_chunk_args()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="get_chunk_args()"></a><font size="-1"><div class="left-tab">
              <font color="blue">get_chunk_args()</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-get_chunk_args()-2">36c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function get_chunk_args(text, values,
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  # optional parameters
<tt>3  </tt>  path, # hierarchical precursors
<tt>4  </tt>  # local vars</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>  a, name)
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-get_chunk_args()-1"></a>
      </p></font>
    </p>
    <p>
      The strategy is to parse the name, and then look for a value. If the
      value begins with a brace <tt class="verbatim">{</tt>, then we recurse and consume
      as much of the text as necessary, returning the remaining text when we
      encounter a leading close-brace <tt class="verbatim">}</tt>. This being the
      strategy &ndash;- and executed in a loop &ndash;- we realise that we
      must first look for the closing brace (perhaps preceded by white space)
      in order to terminate the recursion, and returning remaining text.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-get_chunk_args()-2"></a>
        <table style="width: 100%" id="code-ref-get_chunk_args()-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="get_chunk_args()"></a><font size="-1"><div class="left-tab">
              <font color="blue">get_chunk_args()</font>[2]() &uArr;<a href="#code-ref-get_chunk_args()-1">36b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-get_chunk_args()-1">36b</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>{
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>7  </tt>  split(&quot;&quot;, next_chunk_args);
<tt>8  </tt>  while(length(text)) {
<tt>9  </tt>    if (match(text, &quot;^ *}(.*)&quot;, a)) {
<tt>10  </tt>      return a[1];
<tt>11  </tt>    }
<tt>12  </tt>    =&lt;\chunkref{parse-chunk-args}&gt;
<tt>13  </tt>  }
<tt>14  </tt>  return text;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>15  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-get_chunk_args()-2">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We can see that the text could be inspected with this regex:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-parse-chunk-args-1"></a>
        <table style="width: 100%" id="code-ref-parse-chunk-args-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="parse-chunk-args"></a><font size="-1"><div class="left-tab">
              <font color="blue">parse-chunk-args</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-parse-chunk-args-2">37a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (! match(text, &quot; *([^,=]*[^,= ]) *(([,=])
            *(([^,}]*) *,* *(.*))|)$&quot;, a)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  return text;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-parse-chunk-args-1"></a>
      </p></font>
    </p>
    <p>
      and that <tt class="verbatim">a</tt> will have the following values:
    </p>
    <table style="display: inline; vertical-align: -3.85em">
      <tbody><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">a[n]</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">assigned text</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">1</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">freddie</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">2</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">=freddie, foo={bar=baz, quux={quirk, a=fleeg}}, etc</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">3</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">=</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">4</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">freddie, foo={bar=baz, quux={quirk, a=fleeg}}, etc</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">5</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">freddie</td>
      </tr><tr>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">6</td>
        <td style="border-left: 0.5pt solid; border-right: 0.5pt solid; border-bottom: 0.5pt solid; border-top: 0.5pt solid">, foo={bar=baz, quux={quirk, a=fleeg}}, etc</td>
      </tr></tbody>
    </table>
    <p>
      <tt class="verbatim">a[3]</tt> will be either <tt class="verbatim">=</tt> or <tt class="verbatim">,</tt>
      and signify whether the option named in <tt class="verbatim">a[1]</tt> has a value
      or not (respectively).
    </p>
    <p>
      If the option does have a value, then if the expression <tt class="verbatim">substr(a[4],1,1)</tt>
      returns a brace <tt class="verbatim">{</tt> it will signify that we need to
      recurse:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-parse-chunk-args-2"></a>
        <table style="width: 100%" id="code-ref-parse-chunk-args-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="parse-chunk-args"></a><font size="-1"><div class="left-tab">
              <font color="blue">parse-chunk-args</font>[2]() &uArr;<a href="#code-ref-parse-chunk-args-1">36d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-parse-chunk-args-1">36d</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>name=a[1];
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>5  </tt>if (a[3] == &quot;=&quot;) {
<tt>6  </tt>  if (substr(a[4],1,1) == &quot;{&quot;) {
<tt>7  </tt>    text = get_chunk_args(substr(a[4],2), values, path name SUBSEP);
<tt>8  </tt>  } else {
<tt>9  </tt>    values[path name]=a[5];
<tt>10  </tt>    text = a[6];
<tt>11  </tt>  }
<tt>12  </tt>} else {
<tt>13  </tt>  values[path name]=&quot;&quot;;
<tt>14  </tt>  text = a[2];</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>15  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-parse-chunk-args-2">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We can test this function like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-gca-test.awk-1"></a>
        <table style="width: 100%" id="code-ref-gca-test.awk-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="gca-test.awk"></a><font size="-1"><font color="blue">gca-test.awk</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{get_chunk_args()}&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>BEGIN {
<tt>3  </tt>  SUBSEP=&quot;.&quot;;
<tt>4  </tt>
<tt>5  </tt>  print get_chunk_args(&quot;name=freddie, foo={bar=baz, quux={quirk, a=fleeg}}, etc&quot;, a);
<tt>6  </tt>  for (b in a) {
<tt>7  </tt>    print &quot;a[&quot; b &quot;] =&gt; &quot; a[b];
<tt>8  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>9  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-gca-test.awk-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      which should give this output:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-gca-test.awk-results-1"></a>
        <table style="width: 100%" id="code-ref-gca-test.awk-results-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="gca-test.awk-results"></a><font size="-1"><font color="blue">gca-test.awk-results</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>a[foo.quux.quirk] =&gt; 
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>a[foo.quux.a] =&gt; fleeg
<tt>3  </tt>a[foo.bar] =&gt; baz
<tt>4  </tt>a[etc] =&gt; </div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>a[name] =&gt; freddie
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-gca-test.awk-results-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-44"><a id="Chunk Arguments"></a>8.2<span style="margin-left: 1em"></span>Parsing chunk arguments</h2>
    <p>
      Arguments to paramterized chunks are expressed in round brackets as a
      comma separated list of optional arguments. For example, a chunk that is
      defined with:
    </p>
    <pre class="verbatim" xml:space="preserve">
\Chunk{achunk, params=name ; address}</pre>
    <p>
      could be invoked as:
    </p>
    <pre class="verbatim" xml:space="preserve">
\chunkref{achunk}(John Jones, jones@example.com)</pre>
    <p>
      An argument list may be as simple as in <tt class="verbatim">\chunkref{pull}(thing,
      otherthing)</tt> or as complex as:
    </p>
    <pre class="verbatim" xml:space="preserve">
\chunkref{pull}(things[x, y], get_other_things(a, &quot;(all)&quot;))</pre>
    <p>
      &ndash;- which for all it's commas and quotes and parenthesis represents
      only two parameters: <tt class="verbatim">things[x, y]</tt> and <tt class="verbatim">get_other_things(a,
      &quot;(all)&quot;)</tt>.
    </p>
    <p>
      If we simply split parameter list on commas, then the comma in <tt
      class="verbatim">things[x,y]</tt> would split into two seperate arguments: <tt
      class="verbatim">things[x</tt> and <tt class="verbatim">y]</tt>&ndash;- neither of which
      make sense on their own.
    </p>
    <p>
      One way to prevent this would be by refusing to split text between
      matching delimiters, such as
      <tt class="verbatim">[</tt>
      ,
      <tt class="verbatim">]</tt>
      ,
      <tt class="verbatim">(</tt>
      ,
      <tt class="verbatim">)</tt>
      ,
      <tt class="verbatim">{</tt>
      ,
      <tt class="verbatim">}</tt>
      and most likely also
      <tt class="verbatim">&quot;</tt>
      ,
      <tt class="verbatim">&quot;</tt>
      and
      <tt class="verbatim">'</tt>
      ,
      <tt class="verbatim">'</tt>
      . Of course this also makes it impossible to pass such mis-matched code
      fragments as parameters, but I think that it would be hard for readers
      to cope with authors who would pass such code unbalanced fragments as
      chunk parameters
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . I know that I couldn't cope with users doing such things,
                and although the GPL3 license prevents me from actually
                forbidding anyone from trying, if they want it to work they'll
                have to write the code themselves and not expect any support
                from me.
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-2"></a>
      <sup><a href="#footnote-2">2</a></sup>
      .
    </p>
    <p>
      Unfortunately, the full set of matching delimiters may vary from
      language to language. In certain C++ template contexts, <tt class="verbatim">&lt;</tt>
      and <tt class="verbatim">&gt;</tt> would count as delimiters, and yet in other
      contexts they would not.
    </p>
    <p>
      This puts me in the unfortunate position of having to parse-somewhat all
      programming languages without knowing what they are!
    </p>
    <p>
      However, if this universal mode-tracking is possible, then parsing the
      arguments would be trivial. Such a mode tracker is described in chapter
      <a href="#modes">9</a> and used here with simplicity.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-parse_chunk_args-1"></a>
        <table style="width: 100%" id="code-ref-parse_chunk_args-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="parse_chunk_args"></a><font size="-1"><font color="blue">parse_chunk_args</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function parse_chunk_args(language, text, values,
            mode,
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  # local vars
<tt>3  </tt>  c, context, rest)
<tt>4  </tt>{
<tt>5  </tt>  =&lt;\chunkref{new-mode-tracker}(context, language, mode)&gt;
<tt>6  </tt>  rest = mode_tracker(context, text, values);
<tt>7  </tt>  # extract values
<tt>8  </tt>  for(c=1; c &lt;= context[0, &quot;values&quot;]; c++) {
<tt>9  </tt>    values[c] = context[0, &quot;values&quot;, c];
<tt>10  </tt>  }
<tt>11  </tt>  return rest;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>12  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-parse_chunk_args-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-45">8.3<span style="margin-left: 1em"></span>Expanding parameters in the text</h2>
    <p>
      Within the body of the chunk, the parameters are referred to with: <tt
      class="verbatim">${name}</tt> and <tt class="verbatim">${address}</tt>. There is a strong
      case that a LaTeX style notation should be used, like <tt class="verbatim">\param{name}</tt>
      which would be expressed in the listing as <tt class="verbatim">=&lt;\param{name}&gt;</tt>
      and be rendered as <tt class="verbatim"><font color="#008000">name</font></tt>. Such
      notation would make me go blind, but I do intend to adopt it.
    </p>
    <p>
      We therefore need a function <tt class="verbatim">expand_chunk_args</tt> which
      will take a block of text, a list of permitted parameters, and the
      arguments which must substitute for the parameters. 
    </p>
    <p>
      Here we split the text on <tt class="verbatim">${</tt> which means that all parts
      except the first will begin with a parameter name which will be
      terminated by <tt class="verbatim">}</tt>. The split function will consume the
      literal <tt class="verbatim">${</tt> in each case.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-expand_chunk_args()-1"></a>
        <table style="width: 100%" id="code-ref-expand_chunk_args()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="expand_chunk_args()"></a><font size="-1"><font color="blue">expand_chunk_args()</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function expand_chunk_args(text, params, args,  
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  p, text_array, next_text, v, t, l)
<tt>3  </tt>{
<tt>4  </tt>  if (split(text, text_array, &quot;\\${&quot;)) {
<tt>5  </tt>    substitute-chunk-args <a href="#code-ref-substitute-chunk-args-1">39a</a>
<tt>6  </tt>  }
<tt>7  </tt>
<tt>8  </tt>  return text;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>9  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-expand_chunk_args()-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      First, we produce an associative array of substitution values indexed by
      parameter names. This will serve as a cache, allowing us to look up the
      replacement values as we extract each name.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-substitute-chunk-args-1"></a>
        <table style="width: 100%" id="code-ref-substitute-chunk-args-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="substitute-chunk-args"></a><font size="-1"><div class="left-tab">
              <font color="blue">substitute-chunk-args</font>[1](), lang=<font
              color="blue"></font> &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-substitute-chunk-args-2">39b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>for(p in params) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  v[params[p]]=args[p];</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-substitute-chunk-args-1"></a>
      </p></font>
    </p>
    <p>
      We accumulate substituted text in the variable text. As the first part
      of the split function is the part before the delimiter &ndash;- which is
      <tt class="verbatim">${</tt> in our case &ndash;- this part will never contain a
      parameter reference, so we assign this directly to the result kept in
      <tt class="verbatim">$text</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-substitute-chunk-args-2"></a>
        <table style="width: 100%" id="code-ref-substitute-chunk-args-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="substitute-chunk-args"></a><font size="-1"><div class="left-tab">
              <font color="blue">substitute-chunk-args</font>[2]() &uArr;<a href="#code-ref-substitute-chunk-args-1">39a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-substitute-chunk-args-1">39a</a> <a href="#code-ref-substitute-chunk-args-3">39c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>4  </tt>text=text_array[1];
        </div></tt>
      </p><p>
        <a id="code-end-substitute-chunk-args-2"></a>
      </p></font>
    </p>
    <p>
      We then iterate over the remaining values in the array
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . I don't know why I think that it will enumerate the array in
                order, but it seems to work
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-3"></a>
      <sup><a href="#footnote-3">3</a></sup>
      <table style="display: inline; vertical-align: -0.55em">
        <tbody><tr>
          <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: fix or prove it</td>
        </tr></tbody>
      </table>
      , and substitute each reference for it's argument.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-substitute-chunk-args-3"></a>
        <table style="width: 100%" id="code-ref-substitute-chunk-args-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="substitute-chunk-args"></a><font size="-1"><div class="left-tab">
              <font color="blue">substitute-chunk-args</font>[3]() &uArr;<a href="#code-ref-substitute-chunk-args-1">39a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-substitute-chunk-args-2">39b</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>for(t=2; t in text_array; t++) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>6  </tt>  =&lt;\chunkref{substitute-chunk-arg}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-substitute-chunk-args-3">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      After the split on <tt class="verbatim">${</tt> a valid parameter reference will
      consist of valid parameter name terminated by a close-brace <tt class="verbatim">}</tt>.
      A valid character name begins with the underscore or a letter, and may
      contain letters, digits or underscores.
    </p>
    <p>
      A valid looking reference that is not actually the name of a parameter
      will be and not substituted. This is good because there is nothing to
      substitute anyway, and it avoids clashes when writing code for languages
      where <tt class="verbatim">${...}</tt> is a valid construct &ndash;- such
      constructs will not be interfered with unless the parameter name also
      matches.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-substitute-chunk-arg-1"></a>
        <table style="width: 100%" id="code-ref-substitute-chunk-arg-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="substitute-chunk-arg"></a><font size="-1"><font color="blue">substitute-chunk-arg</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (match(text_array[t],
            &quot;^([a-zA-Z_][a-zA-Z0-9_]*)}&quot;, l) &amp;&amp;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>    l[1] in v) 
<tt>3  </tt>{
<tt>4  </tt>  text = text v[l[1]] substr(text_array[t], length(l[1])+2);
<tt>5  </tt>} else {
<tt>6  </tt>  text = text &quot;${&quot; text_array[t];</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-substitute-chunk-arg-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-46"><a id="modes"></a>Chapter 9<br></br>Language Modes &amp; Quoting</h1>
    <h2 id="auto-47">9.1<span style="margin-left: 1em"></span>Modes</h2>
    <p>
      <tt class="verbatim">lstlistings</tt> and <tt class="verbatim">fangle</tt> both recognize
      source languages, and perform some basic parsing. <tt class="verbatim">lstlistings</tt>
      can detect strings and comments within a language definition and perform
      suitable rendering, such as italics for comments, and visible-spaces
      within strings.
    </p>
    <p>
      Fangle similarly can recognize strings, and comments, etc, within a
      language, so that any chunks included with <tt class="verbatim">\chunkref</tt> can
      be suitably escape or quoted.
    </p>
    <h3 id="auto-48">9.1.1<span style="margin-left: 1em"></span>Modes to keep code together</h3>
    <p>
      As an example, in the C language there are a few parse modes, affecting
      the interpretation of characters.
    </p>
    <p>
      One parse mode is the strings mode. The string mode is commenced by an
      un-escaped quotation mark <tt class="verbatim">&quot;</tt> and terminated by the
      same. Within the string mode, only one additional mode can be commenced,
      it is the backslash mode <tt class="verbatim">\</tt>, which is always terminated
      after the folloing character.
    </p>
    <p>
      Another mode is <tt class="verbatim">[</tt> which is terminated by a <tt class="verbatim">]</tt>
      (unless it occurs in a string).
    </p>
    <p>
      Consider this fragment of C code:
    </p>
    <p>
      
    </p>
    <p>
      things([<var>x</var>,
      <var>y</var>])<sup>&amp;wide-overbrace;</sup><sup>1. [ mode</sup>,
      get_other_things((<var>a</var>, <sub>3. "
      mode</sub>))<sup>&amp;wide-overbrace;</sup><sup>2. ( mode</sup>
    </p>
    <p>
      
    </p>
    <p>
      Mode nesting prevents the close parenthesis in the quoted string (part
      3) from terminating the parenthesis mode (part 2).
    </p>
    <p>
      Each language has a set of modes, the default mode being the null mode.
      Each mode can lead to other modes.
    </p>
    <h3 id="auto-49">9.1.2<span style="margin-left: 1em"></span>Modes affect included chunks</h3>
    <p>
      For instance, consider this chunk with language=perl:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-example-perl-1"></a>
        <table style="width: 100%" id="code-ref-example-perl-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="example-perl"></a><font size="-1"><font color="blue">example-perl</font>[1](),
            lang=<font color="blue">perl</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          print &quot;hello world $0\n&quot;;
        </div></tt>
      </p><table style="width: 100%" id="code-end-example-perl-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      If it were included in a chunk with <tt class="verbatim">language=sh</tt>, like
      this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-example-sh-1"></a>
        <table style="width: 100%" id="code-ref-example-sh-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="example-sh"></a><font size="-1"><font color="blue">example-sh</font>[1](),
            lang=<font color="blue">sh</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          perl -e &quot;=&lt;\chunkref{example-perl}&gt;&quot;
        </div></tt>
      </p><table style="width: 100%" id="code-end-example-sh-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      fangle would <em>want</em> to generate output like this:
    </p>
    <pre class="verbatim" xml:space="preserve">
perl -e &quot;print \&quot;hello world \$0\\n\&quot;;&quot; </pre>
    <p>
      See that the double quote <tt class="verbatim">&quot;</tt>, back-slash <tt class="verbatim">\</tt>
      and <tt class="verbatim">$</tt> have been quoted with a back-slash to protect them
      from shell interpretation.
    </p>
    <p>
      If that were then included in a chunk with language=make, like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-example-makefile-1"></a>
        <table style="width: 100%" id="code-ref-example-makefile-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="example-makefile"></a><font size="-1"><font color="blue">example-makefile</font>[1](),
            lang=<font color="blue">make</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>target: pre-req
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <div class="left-tab">
              <tt>2  </tt>
            </div>
            <div class="right-tab">
              =&lt;\chunkref{example-sh}&gt;
            </div>
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-example-makefile-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We would need the output to look like this &ndash;- note the <tt class="verbatim">$$</tt>:
    </p>
    <pre class="verbatim" xml:space="preserve">
target: pre-req
        perl -e &quot;print \&quot;hello world \$$0\\n\&quot;;&quot;</pre>
    <p>
      In order to make this work, we need to define a mode-tracker supporting
      each language, that can detect the various quoting modes, and provide a
      transformation that must be applied to any included text so that
      included text will be interpreted correctly after any interpolation that
      it may be subject to at run-time.
    </p>
    <p>
      For example, the sed transformation for text to be inserted into shell
      double-quoted strings would be something like:
    </p>
    <pre class="verbatim" xml:space="preserve">
s/\\/\\\\/g;s/$/\\$/g;s/&quot;/\\&quot;/g;</pre>
    <p>
      which protects <tt class="verbatim">\ $ &quot;</tt>.
    </p>
    <p>
      <table style="display: inline; vertical-align: -0.55em">
        <tbody><tr>
          <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: I don't think this example is true</td>
        </tr></tbody>
      </table>
      The mode tracker must also track nested mode-changes, as in this sh
      example.
    </p>
    <pre class="verbatim" xml:space="preserve">
echo &quot;hello &lsquo;id ...&lsquo;&quot;</pre>
    <p>
      &uarr;
    </p>
    <p>
      Any characters inserted at the point marked &uarr; would need to be
      escaped, including <tt class="verbatim">&lsquo;</tt> <tt class="verbatim">|</tt> <tt class="verbatim">*</tt>
      among others. First it would need escaping for the back-ticks <tt class="verbatim">&lsquo;</tt>,
      and then for the double-quotes <tt class="verbatim">&quot;</tt>.
    </p>
    <p>
      <table style="display: inline; vertical-align: -0.55em">
        <tbody><tr>
          <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: MAYBE</td>
        </tr></tbody>
      </table>
      Escaping need not occur if the format and mode of the included chunk
      matches that of the including chunk.
    </p>
    <p>
      As each chunk is output a new mode tracker for that language is
      initialized in it's normal state. As text is output for that chunk the
      output mode is tracked. When a new chunk is included, a transformation
      appropriate to that mode is selected and pushed onto a stack of
      transformations. Any text to be output is first passed through this
      stack of transformations.
    </p>
    <p>
      It remains to consider if the chunk-include function should return it's
      generated text so that the caller can apply any transformations (and
      formatting), or if it should apply the stack of transformations itself.
    </p>
    <p>
      Note that the transformed text should have the property of not being
      able to change the mode in the current chunk.
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: Note chunk parameters should probably also
        be transformed</td>
      </tr></tbody>
    </table>
    <h2 id="auto-50">9.2<span style="margin-left: 1em"></span>Language Mode Definitions</h2>
    <p>
      All modes are stored in a single multi-dimensional hash. The first index
      is the language, and the second index is the mode-identifier. The third
      indexes are terminators, and optionally, submodes, and delimiters.
    </p>
    <p>
      A useful set of mode definitions for a nameless general C-type language
      is shown here. (Don't be confused by the double backslash escaping
      needed in awk. One set of escaping is for the string, and the second set
      of escaping is for the regex).
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: <p>
          TODO: Add =&lt;\mode{}&gt; command which will allow us to signify
          that a string is
        </p><p>
          regex and thus fangle will quote it for us.
        </p></td>
      </tr></tbody>
    </table>
    <p>
      Submodes are entered by the characters  <tt class="verbatim">&quot;</tt> <tt
      class="verbatim">'</tt> <tt class="verbatim">{</tt> <tt class="verbatim">(</tt> <tt class="verbatim">[</tt> <tt
      class="verbatim">/*</tt>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-common-mode-definitions-1"></a>
        <table style="width: 100%" id="code-ref-common-mode-definitions-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="common-mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">common-mode-definitions</font>[1](<font color="blue">language</font>),
              lang=<font color="blue"></font> &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-common-mode-definitions-2">43b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>modes[${language}, &quot;&quot;, 
          &quot;submodes&quot;]=&quot;\\\\|\&quot;|'|{|\\(|\\[&quot;;
        </div></tt>
      </p><p>
        <a id="code-end-common-mode-definitions-1"></a>
      </p></font>
    </p>
    <p>
      In the default mode, a comma surrounded by un-important white space is a
      delimiter of language items
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . whatever a <em>language item</em> might be
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-1"></a>
      <sup><a href="#footnote-1">1</a></sup>
      .
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-common-mode-definitions-2"></a>
        <table style="width: 100%" id="code-ref-common-mode-definitions-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="common-mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">common-mode-definitions</font>[2](language)
              &uArr;<a href="#code-ref-common-mode-definitions-1">43a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-common-mode-definitions-1">43a</a> <a href="#code-ref-common-mode-definitions-3">43d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>2  </tt>modes[${language}, &quot;&quot;, 
          &quot;delimiters&quot;]=&quot; *, *&quot;;
        </div></tt>
      </p><p>
        <a id="code-end-common-mode-definitions-2"></a>
      </p></font>
    </p>
    <p>
      and should pass this test:
      <table style="display: inline; vertical-align: -0.55em">
        <tbody><tr>
          <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: Why do the tests run in ?(? mode and not
          ?? mode</td>
        </tr></tbody>
      </table>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:mode-definitions-1"></a>
        <table style="width: 100%" id="code-ref-test:mode-definitions-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">test:mode-definitions</font>[1](), lang=<font
              color="blue"></font> &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-test:mode-definitions-2">44g</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>parse_chunk_args(&quot;c-like&quot;,
            &quot;1,2,3&quot;, a, &quot;&quot;);
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>if (a[1] != &quot;1&quot;) e++;
<tt>3  </tt>if (a[2] != &quot;2&quot;) e++;
<tt>4  </tt>if (a[3] != &quot;3&quot;) e++;
<tt>5  </tt>if (length(a) != 3) e++;
<tt>6  </tt>=&lt;\chunkref{pca-test.awk:summary}&gt;
<tt>7  </tt>
<tt>8  </tt>parse_chunk_args(&quot;c-like&quot;, &quot;joe, red&quot;, a, &quot;&quot;);
<tt>9  </tt>if (a[1] != &quot;joe&quot;) e++;
<tt>10  </tt>if (a[2] != &quot;red&quot;) e++;
<tt>11  </tt>if (length(a) != 2) e++;
<tt>12  </tt>=&lt;\chunkref{pca-test.awk:summary}&gt;
<tt>13  </tt>
<tt>14  </tt>parse_chunk_args(&quot;c-like&quot;, &quot;${colour}&quot;, a, &quot;&quot;);
<tt>15  </tt>if (a[1] != &quot;${colour}&quot;) e++;
<tt>16  </tt>if (length(a) != 1) e++;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>17  </tt>=&lt;\chunkref{pca-test.awk:summary}&gt;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-test:mode-definitions-1"></a>
      </p></font>
    </p>
    <p>
      Nested modes are identified by a backslash, a double or single quote,
      various bracket styles or a <tt class="verbatim">/*</tt> comment.
    </p>
    <p>
      For each of these sub-modes modes we must also identify at a mode
      terminator, and any sub-modes or delimiters that may be entered
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . Because we are using the sub-mode characters as the mode
                identifier it means we can't currently have a mode character
                dependant on it's context; i.e. <tt class="verbatim">{</tt> can't behave
                differently when it is inside <tt class="verbatim">[</tt>.
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-2"></a>
      <sup><a href="#footnote-2">2</a></sup>
      .
    </p>
    <h3 id="auto-51">9.2.1<span style="margin-left: 1em"></span>Backslash</h3>
    <p>
      The backslash mode has no submodes or delimiters, and is terminated by
      any character. Note that we are not so much interested in evaluating or
      interpolating content as we are in delineating content. It is no matter
      that a double backslash (<tt class="verbatim">\\</tt>) may represent a single
      backslash while a backslash-newline may represent white space, but it
      does matter that the newline in a backslash newline should not be able
      to terminate a C pre-processor statement; and so the newline will be
      consumed by the backslash however it is to be interpreted.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-common-mode-definitions-3"></a>
        <table style="width: 100%" id="code-ref-common-mode-definitions-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="common-mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">common-mode-definitions</font>[3](language)
              &uArr;<a href="#code-ref-common-mode-definitions-1">43a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-common-mode-definitions-2">43b</a> <a href="#code-ref-common-mode-definitions-4">44f</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>3  </tt>modes[${language}, &quot;\\&quot;,
          &quot;terminators&quot;]=&quot;.&quot;;
        </div></tt>
      </p><p>
        <a id="code-end-common-mode-definitions-3"></a>
      </p></font>
    </p>
    <h3 id="auto-52">9.2.2<span style="margin-left: 1em"></span>Strings</h3>
    <p>
      Common languages support two kinds of strings quoting, double quotes and
      single quotes.
    </p>
    <p>
      In a string we have one special mode, which is the backslash. This may
      escape an embedded quote and prevent us thinking that it should
      terminate the string.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:common-string-1"></a>
        <table style="width: 100%" id="code-ref-mode:common-string-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:common-string"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode:common-string</font>[1](<font color="blue">language</font>,
              <font color="blue">quote</font>), lang=<font color="blue"></font> &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-mode:common-string-2">44b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>modes[${language}, ${quote},
          &quot;submodes&quot;]=&quot;\\\\&quot;;
        </div></tt>
      </p><p>
        <a id="code-end-mode:common-string-1"></a>
      </p></font>
    </p>
    <p>
      Otherwise, the string will be terminated by the same character that
      commenced it.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:common-string-2"></a>
        <table style="width: 100%" id="code-ref-mode:common-string-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:common-string"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode:common-string</font>[2](language, quote)
              &uArr;<a href="#code-ref-mode:common-string-1">44a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode:common-string-1">44a</a> <a href="#code-ref-mode:common-string-3">44c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>2  </tt>modes[${language}, ${quote},
          &quot;terminators&quot;]=${quote};
        </div></tt>
      </p><p>
        <a id="code-end-mode:common-string-2"></a>
      </p></font>
    </p>
    <p>
      In C type languages, certain escape sequences exist in strings. We need
      to define mechanism to enclode any chunks included in this mode using
      those escape sequences. These are expressed in two parts, s meaning
      search, and r meaning replace.
    </p>
    <p>
      The first substitution is to replace a backslash with a double
      backslash. We do this first as other substitutions may introduce a
      backslash which we would not then want to escape again here.
    </p>
    <p>
      Note: Backslashes need double-escaping in the search pattern but not in
      the replacement string, hence we are replacing a literal <tt class="verbatim">\</tt>
      with a literal <tt class="verbatim">\\</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:common-string-3"></a>
        <table style="width: 100%" id="code-ref-mode:common-string-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:common-string"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode:common-string</font>[3](language, quote)
              &uArr;<a href="#code-ref-mode:common-string-1">44a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode:common-string-2">44b</a> <a href="#code-ref-mode:common-string-4">44d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>escapes[${language}, ${quote}, ++escapes[${language},
            ${quote}], &quot;s&quot;]=&quot;\\\\&quot;;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>escapes[${language}, ${quote},   escapes[${language},
            ${quote}], &quot;r&quot;]=&quot;\\\\&quot;;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode:common-string-3"></a>
      </p></font>
    </p>
    <p>
      If the quote character occurs in the text, it should be preceded by a
      backslash, otherwise it would terminate the string unexpectedly.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:common-string-4"></a>
        <table style="width: 100%" id="code-ref-mode:common-string-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:common-string"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode:common-string</font>[4](language, quote)
              &uArr;<a href="#code-ref-mode:common-string-1">44a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode:common-string-3">44c</a> <a href="#code-ref-mode:common-string-5">44e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>escapes[${language}, ${quote}, ++escapes[${language},
            ${quote}], &quot;s&quot;]=${quote};
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>escapes[${language}, ${quote},   escapes[${language},
            ${quote}], &quot;r&quot;]=&quot;\\&quot; ${quote};
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode:common-string-4"></a>
      </p></font>
    </p>
    <p>
      Any newlines in the string, must be replaced by <tt class="verbatim">\n</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:common-string-5"></a>
        <table style="width: 100%" id="code-ref-mode:common-string-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:common-string"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode:common-string</font>[5](language, quote)
              &uArr;<a href="#code-ref-mode:common-string-1">44a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode:common-string-4">44d</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>escapes[${language}, ${quote}, ++escapes[${language},
            ${quote}], &quot;s&quot;]=&quot;\n&quot;;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>8  </tt>escapes[${language}, ${quote},   escapes[${language},
            ${quote}], &quot;r&quot;]=&quot;\\n&quot;;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:common-string-5">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      For the common modes, we define this string handling for double and
      single quotes.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-common-mode-definitions-4"></a>
        <table style="width: 100%" id="code-ref-common-mode-definitions-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="common-mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">common-mode-definitions</font>[4](language)
              &uArr;<a href="#code-ref-common-mode-definitions-1">43a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-common-mode-definitions-3">43d</a> <a href="#code-ref-common-mode-definitions-5">45b</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>=&lt;\chunkref{mode:common-string}(${language},
            &quot;\textbackslash{}&quot;&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>=&lt;\chunkref{mode:common-string}(${language},
            &quot;'&quot;)&gt;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-common-mode-definitions-4"></a>
      </p></font>
    </p>
    <p>
      Working strings should pass this test:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:mode-definitions-2"></a>
        <table style="width: 100%" id="code-ref-test:mode-definitions-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">test:mode-definitions</font>[2]() &uArr;<a href="#code-ref-test:mode-definitions-1">43c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-test:mode-definitions-1">43c</a> <a href="#code-ref-test:mode-definitions-3">47d</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>parse_chunk_args(&quot;c-like&quot;, &quot;say
            \&quot;I said, \\\&quot;Hello, how are you\\\&quot;.\&quot;, for
            me&quot;, a, &quot;&quot;);
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>19  </tt>if (a[1] != &quot;say \&quot;I said, \\\&quot;Hello, how are you\\\&quot;.\&quot;&quot;) e++;
<tt>20  </tt>if (a[2] != &quot;for me&quot;) e++;
<tt>21  </tt>if (length(a) != 2) e++;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>22  </tt>=&lt;\chunkref{pca-test.awk:summary}&gt;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-test:mode-definitions-2"></a>
      </p></font>
    </p>
    <h3 id="auto-53">9.2.3<span style="margin-left: 1em"></span>Parentheses, Braces and Brackets</h3>
    <p>
      Where quotes are closed by the same character, parentheses, brackets and
      braces are closed by an alternate character.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:common-brackets-1"></a>
        <table style="width: 100%" id="code-ref-mode:common-brackets-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:common-brackets"></a><font size="-1"><font color="blue">mode:common-brackets</font>[1](<font
            color="blue">language</font>, <font color="blue">open</font>, <font color="blue">close</font>),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>modes[<font color="#008000">language</font>, <font color="#008000">open</font>,
            &quot;submodes&quot; ]=&quot;\\\\|\&quot;|{|\\(|\\[|'|/\\*&quot;;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>modes[<font color="#008000">language</font>, <font color="#008000">open</font>,  &quot;delimiters&quot;]=&quot; *, *&quot;;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>modes[<font color="#008000">language</font>, <font color="#008000">open</font>,
            &quot;terminators&quot;]=<font color="#008000">close</font>;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:common-brackets-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      Note that the open is NOT a regex but the close token IS.
      <table style="display: inline; vertical-align: -0.55em">
        <tbody><tr>
          <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: When we can quote regex we won't have to
          put the slashes in here</td>
        </tr></tbody>
      </table>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-common-mode-definitions-5"></a>
        <table style="width: 100%" id="code-ref-common-mode-definitions-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="common-mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">common-mode-definitions</font>[5](language)
              &uArr;<a href="#code-ref-common-mode-definitions-1">43a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-common-mode-definitions-4">44f</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>=&lt;\chunkref{mode:common-brackets}(${language},
            &quot;{&quot;, &quot;}&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>7  </tt>=&lt;\chunkref{mode:common-brackets}(${language}, &quot;[&quot;, &quot;\textbackslash{}\textbackslash{}]&quot;)&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>8  </tt>=&lt;\chunkref{mode:common-brackets}(${language},
            &quot;(&quot;, &quot;\textbackslash{}\textbackslash{})&quot;)&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-common-mode-definitions-5">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h3 id="auto-54">9.2.4<span style="margin-left: 1em"></span>Customizing Standard Modes</h3>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:add-submode-1"></a>
        <table style="width: 100%" id="code-ref-mode:add-submode-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:add-submode"></a><font size="-1"><font color="blue">mode:add-submode</font>[1](<font
            color="blue">language</font>, <font color="blue">mode</font>, <font color="blue">submode</font>),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>modes[${language}, ${mode}, &quot;submodes&quot;] =
          modes[${language}, ${mode}, &quot;submodes&quot;] &quot;|&quot;
          ${submode};
        </div></tt>
      </p><table style="width: 100%" id="code-end-mode:add-submode-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:add-escapes-1"></a>
        <table style="width: 100%" id="code-ref-mode:add-escapes-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:add-escapes"></a><font size="-1"><font color="blue">mode:add-escapes</font>[1](<font
            color="blue">language</font>, <font color="blue">mode</font>, <font color="blue">search</font>,
            <font color="blue">replace</font>), lang=<font color="blue"></font>
            &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>escapes[${language}, ${mode}, ++escapes[${language},
            ${mode}], &quot;s&quot;]=${search};
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>escapes[${language}, ${mode},   escapes[${language},
            ${mode}], &quot;r&quot;]=${replace};
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:add-escapes-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      
    </p>
    <h3 id="auto-55">9.2.5<span style="margin-left: 1em"></span>Comments</h3>
    <p>
      We can define <tt class="verbatim">/* comment */</tt> style comments and <tt
      class="verbatim">//comment</tt> style comments to be added to any language:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:multi-line-comments-1"></a>
        <table style="width: 100%" id="code-ref-mode:multi-line-comments-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:multi-line-comments"></a><font size="-1"><font color="blue">mode:multi-line-comments</font>[1](<font
            color="blue">language</font>), lang=<font color="blue"></font>
            &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{mode:add-submode}(${language},
            &quot;&quot;, &quot;/\textbackslash{}\textbackslash{}*&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>modes[${language}, &quot;/*&quot;,
            &quot;terminators&quot;]=&quot;\\*/&quot;;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:multi-line-comments-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:single-line-slash-comments-1"></a>
        <table style="width: 100%" id="code-ref-mode:single-line-slash-comments-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:single-line-slash-comments"></a><font size="-1"><font color="blue">mode:single-line-slash-comments</font>[1](language),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{mode:add-submode}(${language},
            &quot;&quot;, &quot;//&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>modes[${language}, &quot;//&quot;, &quot;terminators&quot;]=&quot;\n&quot;;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>=&lt;\chunkref{mode:add-escapes}(${language},
            &quot;//&quot;, &quot;\textbackslash{}n&quot;,
            &quot;\textbackslash{}n//&quot;)&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:single-line-slash-comments-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We can also define <tt class="verbatim"># comment</tt> style comments (as used in
      awk and shell scripts) in a similar manner.
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: I'm having to use # for hash and
        &macr;extbackslash{} for  and have hacky work-arounds in the parser
        for now</td>
      </tr></tbody>
    </table>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:add-hash-comments-1"></a>
        <table style="width: 100%" id="code-ref-mode:add-hash-comments-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:add-hash-comments"></a><font size="-1"><font color="blue">mode:add-hash-comments</font>[1](<font
            color="blue">language</font>), lang=<font color="blue"></font>
            &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{mode:add-submode}(${language},
            &quot;&quot;, &quot;\#&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>modes[${language}, &quot;#&quot;, &quot;terminators&quot;]=&quot;\n&quot;;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>=&lt;\chunkref{mode:add-escapes}(${language},
            &quot;\#&quot;, &quot;\textbackslash{}n&quot;,
            &quot;\textbackslash{}n\#&quot;)&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:add-hash-comments-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      In C, the <tt class="verbatim">#</tt> denotes pre-processor directives which can
      be multi-line
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:add-hash-defines-1"></a>
        <table style="width: 100%" id="code-ref-mode:add-hash-defines-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:add-hash-defines"></a><font size="-1"><font color="blue">mode:add-hash-defines</font>[1](<font
            color="blue">language</font>), lang=<font color="blue"></font>
            &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{mode:add-submode}(${language},
            &quot;&quot;, &quot;\#&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>modes[${language}, &quot;#&quot;, &quot;submodes&quot; ]=&quot;\\\\&quot;;
<tt>3  </tt>modes[${language}, &quot;#&quot;, &quot;terminators&quot;]=&quot;\n&quot;;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>=&lt;\chunkref{mode:add-escapes}(${language},
            &quot;\#&quot;, &quot;\textbackslash{}n&quot;,
            &quot;\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}n&quot;)&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:add-hash-defines-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:quote-dollar-escape-1"></a>
        <table style="width: 100%" id="code-ref-mode:quote-dollar-escape-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:quote-dollar-escape"></a><font size="-1"><font color="blue">mode:quote-dollar-escape</font>[1](<font
            color="blue">language</font>, <font color="blue">quote</font>), lang=<font
            color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>escapes[${language}, ${quote}, ++escapes[${language},
            ${quote}], &quot;s&quot;]=&quot;\\$&quot;;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>escapes[${language}, ${quote},   escapes[${language},
            ${quote}], &quot;r&quot;]=&quot;\\$&quot;;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:quote-dollar-escape-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We can add these definitions to various languages
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode-definitions-1"></a>
        <table style="width: 100%" id="code-ref-mode-definitions-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode-definitions</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-mode-definitions-2">47b</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>common-mode-definitions(<font color="blue">&quot;c-like&quot;</font>)
            <a href="#code-ref-common-mode-definitions-1">43a</a>
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>
<tt>3  </tt>common-mode-definitions(<font color="blue">&quot;c&quot;</font>) <a href="#code-ref-common-mode-definitions-1">43a</a>
<tt>4  </tt>=&lt;\chunkref{mode:multi-line-comments}(&quot;c&quot;)&gt;
<tt>5  </tt>=&lt;\chunkref{mode:single-line-slash-comments}(&quot;c&quot;)&gt;
<tt>6  </tt>=&lt;\chunkref{mode:add-hash-defines}(&quot;c&quot;)&gt;
<tt>7  </tt>
<tt>8  </tt>=&lt;\chunkref{common-mode-definitions}(&quot;awk&quot;)&gt;
<tt>9  </tt>=&lt;\chunkref{mode:add-hash-comments}(&quot;awk&quot;)&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10 
            </tt>=&lt;\chunkref{mode:add-naked-regex}(&quot;awk&quot;)&gt;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode-definitions-1"></a>
      </p></font>
    </p>
    <p>
      The awk definitions should allow a comment block like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:comment-quote-1"></a>
        <table style="width: 100%" id="code-ref-test:comment-quote-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:comment-quote"></a><font size="-1"><font color="blue">test:comment-quote</font>[1](),
            lang=<font color="blue">awk</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt># Comment: =&lt;\chunkref{test:comment-text}&gt;
        </div></tt>
      </p><table style="width: 100%" id="code-end-test:comment-quote-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:comment-text-1"></a>
        <table style="width: 100%" id="code-ref-test:comment-text-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:comment-text"></a><font size="-1"><font color="blue">test:comment-text</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>Now is the time for
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>the quick brown fox to bring lemonade</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>to the party
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:comment-text-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      to come out like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:comment-quote:result-1"></a>
        <table style="width: 100%" id="code-ref-test:comment-quote:result-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:comment-quote:result"></a><font size="-1"><font color="blue">test:comment-quote:result</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt># Comment: Now is the time for
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>#the quick brown fox to bring lemonade</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>#to the party
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:comment-quote:result-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      The C definition for such a block should have it come out like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:comment-quote:C-result-1"></a>
        <table style="width: 100%" id="code-ref-test:comment-quote:C-result-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:comment-quote:C-result"></a><font size="-1"><font color="blue">test:comment-quote:C-result</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt># Comment: Now is the time for\
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>the quick brown fox to bring lemonade\</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>to the party
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:comment-quote:C-result-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h3 id="auto-56">9.2.6<span style="margin-left: 1em"></span>Regex</h3>
    <p>
      This pattern is incomplete, but meant to detect naked regular
      expressions in awk and perl; e.g. <tt class="verbatim">/.*$/</tt>, however
      required capabilities are not present.
    </p>
    <p>
      Current it only detects regexes anchored with ^ as used in fangle.
    </p>
    <p>
      For full regex support, modes need to be named not after their starting
      character, but some other more fully qualified name.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode:add-naked-regex-1"></a>
        <table style="width: 100%" id="code-ref-mode:add-naked-regex-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode:add-naked-regex"></a><font size="-1"><font color="blue">mode:add-naked-regex</font>[1](<font
            color="blue">language</font>), lang=<font color="blue"></font>
            &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{mode:add-submode}(${language},
            &quot;&quot;, &quot;/\textbackslash{}\textbackslash{}\^&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>modes[${language}, &quot;/^&quot;,
            &quot;terminators&quot;]=&quot;/&quot;;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode:add-naked-regex-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h3 id="auto-57">9.2.7<span style="margin-left: 1em"></span>Perl</h3>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode-definitions-2"></a>
        <table style="width: 100%" id="code-ref-mode-definitions-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode-definitions</font>[2]() &uArr;<a href="#code-ref-mode-definitions-1">46c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-mode-definitions-1">46c</a> <a href="#code-ref-mode-definitions-3">47c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>11 
            </tt>=&lt;\chunkref{common-mode-definitions}(&quot;perl&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>12  </tt>=&lt;\chunkref{mode:multi-line-comments}(&quot;perl&quot;)&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>13 
            </tt>=&lt;\chunkref{mode:add-hash-comments}(&quot;perl&quot;)&gt;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode-definitions-2"></a>
      </p></font>
    </p>
    <p>
      Still need to add add <tt class="verbatim">s/</tt>, submode <tt class="verbatim">/</tt>,
      terminate both with <tt class="verbatim">//</tt>. This is likely to be impossible
      as perl regexes can contain perl.
    </p>
    <h3 id="auto-58">9.2.8<span style="margin-left: 1em"></span>sh</h3>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode-definitions-3"></a>
        <table style="width: 100%" id="code-ref-mode-definitions-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode-definitions</font>[3]() &uArr;<a href="#code-ref-mode-definitions-1">46c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode-definitions-2">47b</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>14 
            </tt>=&lt;\chunkref{common-mode-definitions}(&quot;sh&quot;)&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>15  </tt>#&lt;\chunkref{mode:common-string}(&quot;sh&quot;, &quot;\textbackslash{}&quot;&quot;)&gt;
<tt>16  </tt>#&lt;\chunkref{mode:common-string}(&quot;sh&quot;, &quot;'&quot;)&gt;
<tt>17  </tt>=&lt;\chunkref{mode:add-hash-comments}(&quot;sh&quot;)&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18 
            </tt>=&lt;\chunkref{mode:quote-dollar-escape}(&quot;sh&quot;,
            &quot;\&quot;&quot;)&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode-definitions-3">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-59">9.3<span style="margin-left: 1em"></span>Some tests</h2>
    <p>
      Also, the parser must return any spare text at the end that has not been
      processed due to a mode terminator being found.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:mode-definitions-3"></a>
        <table style="width: 100%" id="code-ref-test:mode-definitions-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">test:mode-definitions</font>[3]() &uArr;<a href="#code-ref-test:mode-definitions-1">43c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-test:mode-definitions-2">44g</a> <a href="#code-ref-test:mode-definitions-4">47e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>23  </tt>rest = parse_chunk_args(&quot;c-like&quot;, &quot;1,
            2, 3) spare&quot;, a, &quot;(&quot;);
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>24  </tt>if (a[1] != 1) e++;
<tt>25  </tt>if (a[2] != 2) e++;
<tt>26  </tt>if (a[3] != 3) e++;
<tt>27  </tt>if (length(a) != 3) e++;
<tt>28  </tt>if (rest != &quot; spare&quot;) e++;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>29  </tt>=&lt;\chunkref{pca-test.awk:summary}&gt;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-test:mode-definitions-3"></a>
      </p></font>
    </p>
    <p>
      We must also be able to parse the example given earlier.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:mode-definitions-4"></a>
        <table style="width: 100%" id="code-ref-test:mode-definitions-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:mode-definitions"></a><font size="-1"><div class="left-tab">
              <font color="blue">test:mode-definitions</font>[4]() &uArr;<a href="#code-ref-test:mode-definitions-1">43c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-test:mode-definitions-3">47d</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>30  </tt>parse_chunk_args(&quot;c-like&quot;, &quot;things[x,
            y], get_other_things(a, \&quot;(all)\&quot;), 99&quot;, a,
            &quot;(&quot;);
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>31  </tt>if (a[1] != &quot;things[x, y]&quot;) e++;
<tt>32  </tt>if (a[2] != &quot;get_other_things(a, \&quot;(all)\&quot;)&quot;) e++;
<tt>33  </tt>if (a[3] != &quot;99&quot;) e++;
<tt>34  </tt>if (length(a) != 3) e++;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>35  </tt>=&lt;\chunkref{pca-test.awk:summary}&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:mode-definitions-4">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-60">9.4<span style="margin-left: 1em"></span>A non-recursive mode tracker</h2>
    <h3 id="auto-61">9.4.1<span style="margin-left: 1em"></span>Constructor</h3>
    <p>
      The mode tracker holds its state in a stack based on a numerically
      indexed hash. This function, when passed an empty hash, will intialize
      it.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-new_mode_tracker()-1"></a>
        <table style="width: 100%" id="code-ref-new_mode_tracker()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="new_mode_tracker()"></a><font size="-1"><font color="blue">new_mode_tracker()</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function new_mode_tracker(context, language, mode) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  context[&quot;&quot;] = 0;
<tt>3  </tt>  context[0, &quot;language&quot;] = language;
<tt>4  </tt>  context[0, &quot;mode&quot;] = mode;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-new_mode_tracker()-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      Because awk functions cannot return an array, we must create the array
      first and pass it in, so we have a fangle macro to do this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-new-mode-tracker-1"></a>
        <table style="width: 100%" id="code-ref-new-mode-tracker-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="new-mode-tracker"></a><font size="-1"><font color="blue">new-mode-tracker</font>[1](<font
            color="blue">context</font>, <font color="blue">language</font>, <font color="blue">mode</font>),
            lang=<font color="blue">awk</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>awk-delete-array(<font color="blue">context</font>) <a href="#code-ref-awk-delete-array-1">33d</a>
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>new_mode_tracker(${context}, ${language}, ${mode});
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-new-mode-tracker-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h3 id="auto-62">9.4.2<span style="margin-left: 1em"></span>Management</h3>
    <p>
      And for tracking modes, we dispatch to a mode-tracker action based on
      the current language
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker-1"></a>
        <table style="width: 100%" id="code-ref-mode_tracker-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker</font>[1](), lang=<font color="blue">awk</font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-mode_tracker-2">48d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function push_mode_tracker(context, language, mode,
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  # local vars
<tt>3  </tt>  top)
<tt>4  </tt>{
<tt>5  </tt>  if (! (&quot;&quot; in context)) {
<tt>6  </tt>    new-mode-tracker(<font color="blue">context</font>, <font color="blue">language</font>, <font color="blue">mode</font>) <a href="#code-ref-new-mode-tracker-1">48b</a>
<tt>7  </tt>  } else {
<tt>8  </tt>    top = context[&quot;&quot;];
<tt>9  </tt>    if (context[top, &quot;language&quot;] == language &amp;&amp; mode==&quot;&quot;) mode = context[top, &quot;mode&quot;];
<tt>10  </tt>    top++;
<tt>11  </tt>    context[top, &quot;language&quot;] = language;
<tt>12  </tt>    context[top, &quot;mode&quot;] = mode;
<tt>13  </tt>    context[&quot;&quot;] = top;
<tt>14  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>15  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker-1"></a>
      </p></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker-2"></a>
        <table style="width: 100%" id="code-ref-mode_tracker-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker</font>[2]() &uArr;<a href="#code-ref-mode_tracker-1">48c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker-1">48c</a> <a href="#code-ref-mode_tracker-3">48e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>16  </tt>function dump_mode_tracker(context,  
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>17  </tt>  c, d)
<tt>18  </tt>{
<tt>19  </tt>  for(c=0; c &lt;= context[&quot;&quot;]; c++) {
<tt>20  </tt>    printf(&quot; %2d   %s:%s\n&quot;, c, context[c, &quot;language&quot;], context[c, &quot;mode&quot;]) &gt; &quot;/dev/stderr&quot;;
<tt>21  </tt>    for(d=1; ( (c, &quot;values&quot;, d) in context); d++) {
<tt>22  </tt>      printf(&quot;   %2d %s\n&quot;, d, context[c, &quot;values&quot;, d]) &gt; &quot;/dev/stderr&quot;;
<tt>23  </tt>    }
<tt>24  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>25  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker-2"></a>
      </p></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker-3"></a>
        <table style="width: 100%" id="code-ref-mode_tracker-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker</font>[3]() &uArr;<a href="#code-ref-mode_tracker-1">48c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker-2">48d</a> <a href="#code-ref-mode_tracker-4">53a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>26  </tt>function finalize_mode_tracker(context)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>27  </tt>{
<tt>28  </tt>  if ( (&quot;&quot; in context) &amp;&amp; context[&quot;&quot;] != 0) return 0;
<tt>29  </tt>  return 1;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>30  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker-3"></a>
      </p></font>
    </p>
    <p>
      This implies that any chunk must be syntactically whole; for instance,
      this is fine:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:whole-chunk-1"></a>
        <table style="width: 100%" id="code-ref-test:whole-chunk-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:whole-chunk"></a><font size="-1"><font color="blue">test:whole-chunk</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (1) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  =&lt;\chunkref{test:say-hello}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:whole-chunk-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:say-hello-1"></a>
        <table style="width: 100%" id="code-ref-test:say-hello-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:say-hello"></a><font size="-1"><font color="blue">test:say-hello</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>print &quot;hello&quot;;
        </div></tt>
      </p><table style="width: 100%" id="code-end-test:say-hello-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      But this is not fine; the chunk test:hidden-else <a href="#code-ref-test:hidden-else-1">49d</a> is not
      properly cromulent.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:partial-chunk-1"></a>
        <table style="width: 100%" id="code-ref-test:partial-chunk-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:partial-chunk"></a><font size="-1"><font color="blue">test:partial-chunk</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (1) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  =&lt;\chunkref{test:hidden-else}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:partial-chunk-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:hidden-else-1"></a>
        <table style="width: 100%" id="code-ref-test:hidden-else-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:hidden-else"></a><font size="-1"><font color="blue">test:hidden-else</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>  print &quot;I'm fine&quot;;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>} else {</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>  print &quot;I'm not&quot;;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:hidden-else-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      These tests will check for correct behaviour:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:cromulence-1"></a>
        <table style="width: 100%" id="code-ref-test:cromulence-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:cromulence"></a><font size="-1"><font color="blue">test:cromulence</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>echo Cromulence test
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>passtest $FANGLE -Rtest:whole-chunk $TEX_SRC &amp;&gt;/dev/null || ( echo &quot;Whole chunk failed&quot; &amp;&amp; exit 1 )</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>failtest $FANGLE -Rtest:partial-chunk $TEX_SRC
            &amp;&gt;/dev/null || ( echo &quot;Partial chunk failed&quot;
            &amp;&amp; exit 1 )
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:cromulence-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h3 id="auto-63">9.4.3<span style="margin-left: 1em"></span>Tracker</h3>
    <p>
      We must avoid recursion as a language construct because we intend to
      employ mode-tracking to track language mode of emitted code, and the
      code is emitted from a function which is itself recursive, so instead we
      implement psuedo-recursion using our own stack based on a hash.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-1"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[1](), lang=<font color="blue">awk</font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-mode_tracker()-2">49g</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function mode_tracker(context, text, values, 
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  # optional parameters
<tt>3  </tt>  # local vars
<tt>4  </tt>  mode, submodes, language,
<tt>5  </tt>  cindex, c, a, part, item, name, result, new_values, new_mode, 
<tt>6  </tt>  delimiters, terminators)</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>{
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker()-1"></a>
      </p></font>
    </p>
    <p>
      We could be re-commencing with a valid context, so we need to setup the
      state according to the last context.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-2"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[2]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker()-1">49f</a> <a href="#code-ref-mode_tracker()-3">50c</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>8  </tt>  cindex = context[&quot;&quot;] + 0;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>9  </tt>  mode = context[cindex, &quot;mode&quot;];</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>  language = context[cindex, &quot;language&quot; ];
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker()-2"></a>
      </p></font>
    </p>
    <p>
      First we construct a single large regex combining the possible sub-modes
      for the current mode along with the terminators for the current mode.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-parse_chunk_args-reset-modes-1"></a>
        <table style="width: 100%" id="code-ref-parse_chunk_args-reset-modes-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="parse_chunk_args-reset-modes"></a><font size="-1"><div class="left-tab">
              <font color="blue">parse_chunk_args-reset-modes</font>[1](),
              lang=<font color="blue"></font> &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-parse_chunk_args-reset-modes-2">50b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>  submodes=modes[language, mode,
            &quot;submodes&quot;];
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>
<tt>3  </tt>  if ((language, mode, &quot;delimiters&quot;) in modes) {
<tt>4  </tt>    delimiters = modes[language, mode, &quot;delimiters&quot;];
<tt>5  </tt>    if (length(submodes)&gt;0) submodes = submodes &quot;|&quot;;
<tt>6  </tt>    submodes=submodes delimiters;
<tt>7  </tt>  } else delimiters=&quot;&quot;;
<tt>8  </tt>  if ((language, mode, &quot;terminators&quot;) in modes) {
<tt>9  </tt>    terminators = modes[language, mode, &quot;terminators&quot;];
<tt>10  </tt>    if (length(submodes)&gt;0) submodes = submodes &quot;|&quot;;
<tt>11  </tt>    submodes=submodes terminators;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>12  </tt>  } else terminators=&quot;&quot;;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-parse_chunk_args-reset-modes-1"></a>
      </p></font>
    </p>
    <p>
      If we don't find anything to match on &ndash;- probably because the
      language is not supported &ndash;- then we return the entire text
      without matching anything.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-parse_chunk_args-reset-modes-2"></a>
        <table style="width: 100%" id="code-ref-parse_chunk_args-reset-modes-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="parse_chunk_args-reset-modes"></a><font size="-1"><div class="left-tab">
              <font color="blue">parse_chunk_args-reset-modes</font>[2]() &uArr;<a
              href="#code-ref-parse_chunk_args-reset-modes-1">50a</a>, lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-parse_chunk_args-reset-modes-1">50a</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>13  </tt> if (! length(submodes)) return text;
        </div></tt>
      </p><table style="width: 100%" id="code-end-parse_chunk_args-reset-modes-2">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-3"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[3]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-mode_tracker()-2">49g</a> <a href="#code-ref-mode_tracker()-4">50d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>11  </tt>=&lt;\chunkref{parse_chunk_args-reset-modes}&gt;
        </div></tt>
      </p><p>
        <a id="code-end-mode_tracker()-3"></a>
      </p></font>
    </p>
    <p>
      We then iterate the text (until there is none left) looking for
      sub-modes or terminators in the regex.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-4"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[4]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker()-3">50c</a> <a href="#code-ref-mode_tracker()-5">50e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>12  </tt>  while((cindex &gt;= 0) &amp;&amp; length(text)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>13  </tt>    if (match(text, &quot;(&quot; submodes
            &quot;)&quot;, a)) {
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker()-4"></a>
      </p></font>
    </p>
    <p>
      A bug that creeps in regularly during development is bad regexes of zero
      length which result in an infinite loop (as no text is consumed), so I
      catch that right away with this test.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-5"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[5]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker()-4">50d</a> <a href="#code-ref-mode_tracker()-6">50f</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>14  </tt>      if (RLENGTH&lt;1) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>15  </tt>        error(sprintf(&quot;Internal error, matched zero length submode, should be impossible - likely regex computation error\n&quot; \
<tt>16  </tt>                &quot;Language=%s\nmode=%s\nmatch=%s\n&quot;, language, mode, submodes));</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>17  </tt>      }
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker()-5"></a>
      </p></font>
    </p>
    <p>
      part is defined as the text up to the sub-mode or terminator, and this
      is appended to item &ndash;- which is the current text being gathered.
      If a mode has a delimiter, then item is reset each time a delimiter is
      found.
    </p>
    <p>
      (<tt class="verbatim">&quot;</tt><sub>item</sub>, <sub>item</sub><tt class="verbatim">&quot;</tt>)<sup>&amp;wide-overbrace;</sup><sup>item</sup>,
      he said.<sup class="wide">&amp;wide-overbrace;</sup><sup>item</sup>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-6"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-6">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[6]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker()-5">50e</a> <a href="#code-ref-mode_tracker()-7">50g</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>      part = substr(text, 1, RSTART -1);
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>19  </tt>      item = item part;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker()-6"></a>
      </p></font>
    </p>
    <p>
      We must now determine what was matched. If it was a terminator, then we
      must restore the previous mode.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-7"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-7">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[7]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker()-6">50f</a> <a href="#code-ref-mode_tracker()-8">51a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>20  </tt>      if (match(a[1], &quot;^&quot; terminators
            &quot;$&quot;)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>21  </tt>#printf(&quot;%2d EXIT  MODE [%s] by [%s] [%s]\n&quot;, cindex, mode, a[1], text) &gt; &quot;/dev/stderr&quot;
<tt>22  </tt>        context[cindex, &quot;values&quot;, ++context[cindex, &quot;values&quot;]] = item;
<tt>23  </tt>        delete context[cindex];
<tt>24  </tt>        context[&quot;&quot;] = --cindex;
<tt>25  </tt>        if (cindex&gt;=0) {
<tt>26  </tt>          mode = context[cindex, &quot;mode&quot;];
<tt>27  </tt>          language = context[cindex, &quot;language&quot;];
<tt>28  </tt>          =&lt;\chunkref{parse_chunk_args-reset-modes}&gt;
<tt>29  </tt>        }
<tt>30  </tt>        item = item a[1];
<tt>31  </tt>        text = substr(text, 1 + length(part) + length(a[1]));</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>32  </tt>      }
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker()-7"></a>
      </p></font>
    </p>
    <p>
      If a delimiter was matched, then we must store the current item in the
      parsed values array, and reset the item.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-8"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-8">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[8]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-mode_tracker()-7">50g</a> <a href="#code-ref-mode_tracker()-9">51b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>33  </tt>      else if (match(a[1], &quot;^&quot; delimiters
            &quot;$&quot;)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>34  </tt>        if (cindex==0) {
<tt>35  </tt>          context[cindex, &quot;values&quot;, ++context[cindex, &quot;values&quot;]] = item;
<tt>36  </tt>          item = &quot;&quot;;
<tt>37  </tt>        } else {
<tt>38  </tt>          item = item a[1];
<tt>39  </tt>        }
<tt>40  </tt>        text = substr(text, 1 + length(part) + length(a[1]));</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>41  </tt>      }
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker()-8"></a>
      </p></font>
    </p>
    <p>
      otherwise, if a new submode is detected (all submodes have terminators),
      we must create a nested parse context until we find the terminator for
      this mode.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-9"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-9">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[9]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker()-8">51a</a> <a href="#code-ref-mode_tracker()-10">51c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>42  </tt> else if ((language, a[1], &quot;terminators&quot;)
            in modes) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>43  </tt>        #check if new_mode is defined
<tt>44  </tt>        item = item a[1];
<tt>45  </tt>#printf(&quot;%2d ENTER MODE [%s] in [%s]\n&quot;, cindex, a[1], text) &gt; &quot;/dev/stderr&quot;
<tt>46  </tt>        text = substr(text, 1 + length(part) + length(a[1]));
<tt>47  </tt>        context[&quot;&quot;] = ++cindex;
<tt>48  </tt>        context[cindex, &quot;mode&quot;] = a[1];
<tt>49  </tt>        context[cindex, &quot;language&quot;] = language;
<tt>50  </tt>        mode = a[1];
<tt>51  </tt>        =&lt;\chunkref{parse_chunk_args-reset-modes}&gt;
<tt>52  </tt>      } else {
<tt>53  </tt>        error(sprintf(&quot;Submode '%s' set unknown mode in text: %s\nLanguage %s Mode %s\n&quot;, a[1], text, language, mode));
<tt>54  </tt>        text = substr(text, 1 + length(part) + length(a[1]));
<tt>55  </tt>      }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>56  </tt>    }
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker()-9"></a>
      </p></font>
    </p>
    <p>
      In the final case, we parsed to the end of the string. If the string was
      entire, then we should have no nested mode context, but if the string
      was just a fragment we may have a mode context which must be preserved
      for the next fragment. Todo: Consideration ought to be given if sub-mode
      strings are split over two fragments.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker()-10"></a>
        <table style="width: 100%" id="code-ref-mode_tracker()-10">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker()"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker()</font>[10]() &uArr;<a href="#code-ref-mode_tracker()-1">49f</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker()-9">51b</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>57  </tt>else {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>58  </tt>      context[cindex, &quot;values&quot;, ++context[cindex, &quot;values&quot;]] = item text;
<tt>59  </tt>      text = &quot;&quot;;
<tt>60  </tt>      item = &quot;&quot;;
<tt>61  </tt>    }
<tt>62  </tt>  }
<tt>63  </tt>
<tt>64  </tt>  context[&quot;item&quot;] = item;
<tt>65  </tt>
<tt>66  </tt>  if (length(item)) context[cindex, &quot;values&quot;, ++context[cindex, &quot;values&quot;]] = item;
<tt>67  </tt>  return text;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>68  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode_tracker()-10">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h4 id="auto-64">9.4.3.1<span style="margin-left: 1em"></span>One happy chunk</h4>
    <p>
      All the mode tracker chunks are referred to here:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode-tracker-1"></a>
        <table style="width: 100%" id="code-ref-mode-tracker-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode-tracker"></a><font size="-1"><font color="blue">mode-tracker</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>new_mode_tracker() <a href="#code-ref-new_mode_tracker()-1">48a</a>
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>mode_tracker() <a href="#code-ref-mode_tracker()-1">49f</a>
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode-tracker-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h4 id="auto-65">9.4.3.2<span style="margin-left: 1em"></span>Tests</h4>
    <p>
      We can test this function like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-pca-test.awk-1"></a>
        <table style="width: 100%" id="code-ref-pca-test.awk-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="pca-test.awk"></a><font size="-1"><font color="blue">pca-test.awk</font>[1](),
            lang=<font color="blue">awk</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{error()}&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>=&lt;\chunkref{mode-tracker}&gt;
<tt>3  </tt>=&lt;\chunkref{parse_chunk_args()}&gt;
<tt>4  </tt>BEGIN {
<tt>5  </tt>  SUBSEP=&quot;.&quot;;
<tt>6  </tt>  =&lt;\chunkref{mode-definitions}&gt;
<tt>7  </tt>
<tt>8  </tt>  =&lt;\chunkref{test:mode-definitions}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>9  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-pca-test.awk-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-pca-test.awk:summary-1"></a>
        <table style="width: 100%" id="code-ref-pca-test.awk:summary-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="pca-test.awk:summary"></a><font size="-1"><font color="blue">pca-test.awk:summary</font>[1](),
            lang=<font color="blue">awk</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (e) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  printf &quot;Failed &quot; e
<tt>3  </tt>  for (b in a) {
<tt>4  </tt>    print &quot;a[&quot; b &quot;] =&gt; &quot; a[b];
<tt>5  </tt>  }
<tt>6  </tt>} else {
<tt>7  </tt>  print &quot;Passed&quot;
<tt>8  </tt>}
<tt>9  </tt>split(&quot;&quot;, a);</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>e=0;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-pca-test.awk:summary-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      which should give this output:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-pca-test.awk-results-1"></a>
        <table style="width: 100%" id="code-ref-pca-test.awk-results-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="pca-test.awk-results"></a><font size="-1"><font color="blue">pca-test.awk-results</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>a[foo.quux.quirk] =&gt; 
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>a[foo.quux.a] =&gt; fleeg
<tt>3  </tt>a[foo.bar] =&gt; baz
<tt>4  </tt>a[etc] =&gt; </div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>a[name] =&gt; freddie
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-pca-test.awk-results-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-66">9.5<span style="margin-left: 1em"></span>Escaping and Quoting</h2>
    <p>
      For the time being and to get around TeXmacs inability to export a
      <kbd>TAB</kbd> character, the right arrow whose UTF-8 sequence is ...
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: complete</td>
      </tr></tbody>
    </table>
    <p>
      Another special character is used, the left-arrow with UTF-8 sequence
      0xE2 0x86 0xA4 is used to strip any preceding white space as a way of
      un-tabbing and removing indent that has been applied <class style="font-family: Times New Roman">&mdash;</class>
      this is important for bash here documents, and the like. It's a filthy
      hack.
    </p>
    <table style="display: inline; vertical-align: -0.55em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: remove the hack</td>
      </tr></tbody>
    </table>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker-4"></a>
        <table style="width: 100%" id="code-ref-mode_tracker-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker</font>[4]() &uArr;<a href="#code-ref-mode_tracker-1">48c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-mode_tracker-3">48e</a> <a href="#code-ref-mode_tracker-5">53b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>31  </tt>function untab(text) {
<tt>32  </tt>  gsub(&quot;[[:space:]]*\xE2\x86\xA4&quot;,&quot;&quot;, text);
<tt>33  </tt>  return text;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>34  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker-4"></a>
      </p></font>
    </p>
    <p>
      Each nested mode can optionally define a set of transforms to be applied
      to any text that is included from another language.
    </p>
    <p>
      This code can perform transforms
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker-5"></a>
        <table style="width: 100%" id="code-ref-mode_tracker-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker</font>[5]() &uArr;<a href="#code-ref-mode_tracker-1">48c</a>,
              lang=<font color="blue">awk</font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker-4">53a</a> <a href="#code-ref-mode_tracker-6">53c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>35  </tt>function transform_escape(s, r, text,
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>36  </tt>    # optional
<tt>37  </tt>    max, 
<tt>38  </tt>        # local vars
<tt>39  </tt>        c)
<tt>40  </tt>{
<tt>41  </tt>  for(c=1; c &lt;= max &amp;&amp; (c in s); c++) {
<tt>42  </tt>    gsub(s[c], r[c], text);
<tt>43  </tt>  }
<tt>44  </tt>  return text;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>45  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-mode_tracker-5"></a>
      </p></font>
    </p>
    <p>
      This function must append from index c onwards, and escape transforms
      from the supplied context, and return c + number of new transforms.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-mode_tracker-6"></a>
        <table style="width: 100%" id="code-ref-mode_tracker-6">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="mode_tracker"></a><font size="-1"><div class="left-tab">
              <font color="blue">mode_tracker</font>[6]() &uArr;<a href="#code-ref-mode_tracker-1">48c</a>,
              lang=<font color="blue">awk</font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-mode_tracker-5">53b</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>46  </tt>function mode_escaper(context, s, r, src,
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>47  </tt>  c, cp, cpl)
<tt>48  </tt>{
<tt>49  </tt>  for(c = context[&quot;&quot;]; c &gt;= 0; c--) {
<tt>50  </tt>    if ( (context[c, &quot;language&quot;], context[c, &quot;mode&quot;]) in escapes) {
<tt>51  </tt>      cpl = escapes[context[c, &quot;language&quot;], context[c, &quot;mode&quot;]];
<tt>52  </tt>      for (cp = 1; cp &lt;= cpl; cp ++) {
<tt>53  </tt>        ++src;
<tt>54  </tt>        s[src] = escapes[context[c, &quot;language&quot;], context[c, &quot;mode&quot;], cp, &quot;s&quot;];
<tt>55  </tt>                                r[src] = escapes[context[c, &quot;language&quot;], context[c, &quot;mode&quot;], cp, &quot;r&quot;];
<tt>56  </tt>      }
<tt>57  </tt>    }
<tt>58  </tt>  }
<tt>59  </tt>  return src;
<tt>60  </tt>}
<tt>61  </tt>function dump_escaper(c, s, r, cc) {
<tt>62  </tt>  for(cc=1; cc&lt;=c; cc++) {
<tt>63  </tt>    printf(&quot;%2d s[%s] r[%s]\n&quot;, cc, s[cc], r[cc]) &gt; &quot;/dev/stderr&quot;
<tt>64  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>65  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-mode_tracker-6">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:escapes-1"></a>
        <table style="width: 100%" id="code-ref-test:escapes-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:escapes"></a><font size="-1"><font color="blue">test:escapes</font>[1](),
            lang=<font color="blue">sh</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>echo escapes test
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>passtest $FANGLE -Rtest:comment-quote $TEX_SRC
            &amp;&gt;/dev/null || ( echo &quot;Comment-quote failed&quot;
            &amp;&amp; exit 1 )
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:escapes-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-67">Chapter 10<br></br>Recognizing Chunks</h1>
    <p>
      Fangle recognizes noweb chunks, but as we also want better LaTeX
      integration we will recognize any of these:
    </p>
    <ul>
      <li>
        notangle chunks matching the pattern <tt class="verbatim">^&lt;&lt;.*?&gt;&gt;=</tt>
      </li>
      <li>
        chunks beginning with <tt class="verbatim">\begin{lstlistings}</tt>, possibly
        with <tt class="verbatim">\Chunk{...}</tt> on the previous line
      </li>
      <li>
        an older form I have used, beginning with
        <tt class="verbatim">\begin{Chunk}[options]</tt>
        &ndash;- also more suitable for plain LaTeX users
        <p>
          <font size="-1"><div align="justify">
            <div style="margin-left: 0px">
              <div style="margin-right: 0px">
                <p>
                  . Is there such a thing as plain LaTeX?
                </p>
              </div>
            </div>
          </div></font>
        </p>
        <span style="margin-left: 0em"></span>
        <a id="footnr-1"></a>
        <sup><a href="#footnote-1">1</a></sup>
        .
      </li>
    </ul>
    <h2 id="auto-68">10.1<span style="margin-left: 1em"></span>Chunk start</h2>
    <p>
      The variable chunking is used to signify that we are processing a code
      chunk and not document. In such a state, input lines will be assigned to
      the current chunk; otherwise they are ignored.
    </p>
    <h3 id="auto-69">10.1.1<span style="margin-left: 1em"></span>TeXmacs hackery</h3>
    <p>
      We don't handle TeXmacs files natively but instead emit unicode
      character sequences to mark up the text-export file which we work on.
    </p>
    <p>
      These hacks detect such sequences and retro-fit in the old TeX parsing.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-1"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-recognize-chunk-2">56a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>1  </tt>#/\n/ {
<tt>2  </tt>#  gsub(&quot;\n*$&quot;,&quot;&quot;);
<tt>3  </tt>#  gsub(&quot;\n&quot;, &quot; &quot;);
<tt>4  </tt>#}
<tt>5  </tt>#===
<tt>6  </tt>/\xE2\x86\xA6/ {
<tt>7  </tt>  gsub(&quot;\\xE2\\x86\\xA6&quot;, &quot;\x09&quot;);
<tt>8  </tt>}
<tt>9  </tt>
<tt>10  </tt>/\xE2\x80\x98/ {
<tt>11  </tt>  gsub(&quot;\\xE2\\x80\\x98&quot;, &quot;&lsquo;&quot;);
<tt>12  </tt>}
<tt>13  </tt>
<tt>14  </tt>/\xE2\x89\xA1/ {
<tt>15  </tt>  if (match($0, &quot;^ *([^[ ]* |)&lt;([^[ ]*)\\[[0-9]*\\][(](.*)[)].*, lang=([^ ]*)&quot;, line)) {
<tt>16  </tt>    next_chunk_name=line[2];
<tt>17  </tt>    gsub(&quot;,&quot;,&quot;;&quot;,line[3]);
<tt>18  </tt>    params=&quot;params=&quot; line[3];
<tt>19  </tt>    if ((line[4])) {
<tt>20  </tt>      params = params &quot;,language=&quot; line[4]
<tt>21  </tt>    }
<tt>22  </tt>    get_chunk_args(params, next_chunk_args);
<tt>23  </tt>    new_chunk(next_chunk_name, next_chunk_args);
<tt>24  </tt>    texmacs_chunking = 1;
<tt>25  </tt>  } else {
<tt>26  </tt>#print &quot;Unexpected 
<tt>27  </tt>#print 
<tt>28  </tt>#exit 1
<tt>29  </tt>  }
<tt>30  </tt>  next;
<tt>31  </tt>}</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>32  </tt>#===
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-recognize-chunk-1"></a>
      </p></font>
    </p>
    <h3 id="auto-70">10.1.2<span style="margin-left: 1em"></span>lstlistings</h3>
    <p>
      Our current scheme is to recognize the new lstlisting chunks, but these
      may be preceded by a <tt class="verbatim">\Chunk</tt> command which in L<span
      style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X is a more convenient way to pass
      the chunk name to the <tt class="verbatim">\begin{lstlistings}</tt> command, and a
      more visible way to specify other <tt class="verbatim">lstset</tt> settings.
    </p>
    <p>
      The arguments to the <tt class="verbatim">\Chunk</tt> command are a name, and then
      a comma-seperated list of key-value pairs after the manner of <tt class="verbatim">\lstset</tt>.
      (In fact within the LaTeX <tt class="verbatim">\Chunk</tt> macro (section <a href="#sub:The-chunk-command">15.2.1</a>)
      the text <tt class="verbatim">name=</tt> is prefixed to the argument which is then
      literally passed to <tt class="verbatim">\lstset</tt>).
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-2"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[2]() &uArr;<a href="#code-ref-recognize-chunk-1">55a</a>,
              lang=<font color="blue">awk</font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-recognize-chunk-1">55a</a> <a href="#code-ref-recognize-chunk-3">56b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>33  </tt>/^\\Chunk{/ {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>34  </tt>  if (match($0, &quot;^\\\\Chunk{ *([^ ,}]*),?(.*)}&quot;, line)) {
<tt>35  </tt>    next_chunk_name = line[1];
<tt>36  </tt>    get_chunk_args(line[2], next_chunk_args);
<tt>37  </tt>  }
<tt>38  </tt>  next;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>39  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-recognize-chunk-2"></a>
      </p></font>
    </p>
    <p>
      We also make a basic attempt to parse the name out of the
      <tt class="verbatim">\lstlistings[name=chunk-name]</tt>
      text, otherwise we fall back to the name found in the previous chunk
      command. This attempt is very basic and doesn't support commas or spaces
      or square brackets as part of the chunkname. We also recognize
      <tt class="verbatim">\begin{Chunk}</tt>
      which is convenient for some users
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . but not yet supported in the LaTeX macros
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-2"></a>
      <sup><a href="#footnote-2">2</a></sup>
      .
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-3"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[3]() &uArr;<a href="#code-ref-recognize-chunk-1">55a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-recognize-chunk-2">56a</a> <a href="#code-ref-recognize-chunk-4">56c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>40  </tt>/^\\begin{lstlisting}|^\\begin{Chunk}/ {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>41  </tt>  if (match($0, &quot;}.*[[,] *name= *{? *([^], }]*)&quot;, line)) {
<tt>42  </tt>    new_chunk(line[1]);
<tt>43  </tt>  } else {
<tt>44  </tt>    new_chunk(next_chunk_name, next_chunk_args);
<tt>45  </tt>  }
<tt>46  </tt>  chunking=1;
<tt>47  </tt>  next;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>48  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-recognize-chunk-3"></a>
      </p></font>
    </p>
    <h3 id="auto-71">10.1.3<span style="margin-left: 1em"></span>TeXmacs</h3>
    <p>
      
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-4"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[4]() &uArr;<a href="#code-ref-recognize-chunk-1">55a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-recognize-chunk-3">56b</a> <a href="#code-ref-recognize-chunk-5">57a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>49  </tt>#===
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>50  </tt>/^ *\|____________*/ &amp;&amp; texmacs_chunking {
<tt>51  </tt>  active_chunk=&quot;&quot;;
<tt>52  </tt>  texmacs_chunking=0;
<tt>53  </tt>  chunking=0;
<tt>54  </tt>}
<tt>55  </tt>/^ *\|\/\\/ &amp;&amp; texmacs_chunking {
<tt>56  </tt>  texmacs_chunking=0;
<tt>57  </tt>  chunking=0;
<tt>58  </tt>  active_chunk=&quot;&quot;;
<tt>59  </tt>}
<tt>60  </tt>texmacs_chunk=0;
<tt>61  </tt>/^ *[1-9][0-9]* *\| / {
<tt>62  </tt>  if (texmacs_chunking) {
<tt>63  </tt>    chunking=1;
<tt>64  </tt>    texmacs_chunk=1;
<tt>65  </tt>    gsub(&quot;^ *[1-9][0-9]* *\\| &quot;, &quot;&quot;)
<tt>66  </tt>  }
<tt>67  </tt>}
<tt>68  </tt>/^ *\.\/\\/ &amp;&amp; texmacs_chunking {
<tt>69  </tt>  next;
<tt>70  </tt>}
<tt>71  </tt>/^ *__*$/ &amp;&amp; texmacs_chunking {
<tt>72  </tt>  next;
<tt>73  </tt>}
<tt>74  </tt>
<tt>75  </tt>texmacs_chunking {
<tt>76  </tt>  if (! texmacs_chunk) {
<tt>77  </tt>    # must be a texmacs continued line
<tt>78  </tt>    chunking=1;
<tt>79  </tt>    texmacs_chunk=1;
<tt>80  </tt>  }
<tt>81  </tt>}
<tt>82  </tt>! texmacs_chunk {
<tt>83  </tt>#  texmacs_chunking=0;
<tt>84  </tt>  chunking=0;
<tt>85  </tt>}
<tt>86  </tt></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>87  </tt>#===
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-recognize-chunk-4"></a>
      </p></font>
    </p>
    <h3 id="auto-72">10.1.4<span style="margin-left: 1em"></span>Noweb</h3>
    <p>
      We recognize notangle style chunks too:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-5"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[5]() &uArr;<a href="#code-ref-recognize-chunk-1">55a</a>,
              lang=<font color="blue">awk</font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-recognize-chunk-4">56c</a> <a href="#code-ref-recognize-chunk-6">58a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>88  </tt>/^[&lt;]&lt;.*[&gt;]&gt;=/ {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>89  </tt>  if (match($0, &quot;^[&lt;]&lt;(.*)[&gt;]&gt;= *$&quot;, line)) {
<tt>90  </tt>    chunking=1;
<tt>91  </tt>    notangle_mode=1;
<tt>92  </tt>    new_chunk(line[1]);
<tt>93  </tt>    next;
<tt>94  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>95  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-recognize-chunk-5"></a>
      </p></font>
    </p>
    <h2 id="auto-73">10.2<span style="margin-left: 1em"></span>Chunk end</h2>
    <p>
      Likewise, we need to recognize when a chunk ends.
    </p>
    <h3 id="auto-74">10.2.1<span style="margin-left: 1em"></span>lstlistings</h3>
    <p>
      The
      <tt class="verbatim">e</tt>
      in
      <tt class="verbatim">[e]nd{lislisting}</tt>
      is surrounded by square brackets so that when this document is
      processed, this chunk doesn't terminate early when the lstlistings
      package recognizes it's own end-string!
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . This doesn't make sense as the regex is anchored with ^,
                which this line does not begin with!
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-3"></a>
      <sup><a href="#footnote-3">3</a></sup>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-6"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-6">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[6]() &uArr;<a href="#code-ref-recognize-chunk-1">55a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-recognize-chunk-5">57a</a> <a href="#code-ref-recognize-chunk-7">58b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>96  </tt>/^\\[e]nd{lstlisting}|^\\[e]nd{Chunk}/ {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>97  </tt>  chunking=0;
<tt>98  </tt>  active_chunk=&quot;&quot;;
<tt>99  </tt>  next;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>100  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-recognize-chunk-6"></a>
      </p></font>
    </p>
    <h3 id="auto-75">10.2.2<span style="margin-left: 1em"></span>noweb</h3>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-7"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-7">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[7]() &uArr;<a href="#code-ref-recognize-chunk-1">55a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-recognize-chunk-6">58a</a> <a href="#code-ref-recognize-chunk-8">58c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>101  </tt>/^@ *$/ {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>102  </tt>  chunking=0;
<tt>103  </tt>  active_chunk=&quot;&quot;;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>104  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-recognize-chunk-7"></a>
      </p></font>
    </p>
    <p>
      All other recognizers are only of effect if we are chunking; there's no
      point in looking at lines if they aren't part of a chunk, so we just
      ignore them as efficiently as we can.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-8"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-8">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[8]() &uArr;<a href="#code-ref-recognize-chunk-1">55a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-recognize-chunk-7">58b</a> <a href="#code-ref-recognize-chunk-9">58d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>105  </tt>! chunking { next; }
        </div></tt>
      </p><p>
        <a id="code-end-recognize-chunk-8"></a>
      </p></font>
    </p>
    <h2 id="auto-76">10.3<span style="margin-left: 1em"></span>Chunk contents</h2>
    <p>
      Chunk contents are any lines read while <tt class="verbatim">chunking</tt> is
      true. Some chunk contents are special in that they refer to other
      chunks, and will be replaced by the contents of these chunks when the
      file is generated.
    </p>
    <p>
      <a id="sub:ORS-chunk-text"></a>
      We add the output record separator
      <tt class="verbatim">ORS</tt>
      to the line now, because we will set
      <tt class="verbatim">ORS</tt>
      to the empty string when we generate the output
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . So that we can partial print lines using
                <tt class="verbatim">print</tt>
                instead of
                <tt class="verbatim">printf</tt>
                .
                <table style="display: inline; vertical-align: -0.55em">
                  <tbody><tr>
                    <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: This does't make sense</td>
                  </tr></tbody>
                </table>
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-4"></a>
      <sup><a href="#footnote-4">4</a></sup>
      .
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-recognize-chunk-9"></a>
        <table style="width: 100%" id="code-ref-recognize-chunk-9">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="recognize-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">recognize-chunk</font>[9]() &uArr;<a href="#code-ref-recognize-chunk-1">55a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-recognize-chunk-8">58c</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>106  </tt>length(active_chunk) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>107  </tt>  =&lt;\chunkref{process-chunk-tabs}&gt;
<tt>108  </tt>  =&lt;\chunkref{process-chunk}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>109  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-recognize-chunk-9">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      If a chunk just consisted of plain text, we could handle the chunk like
      this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-process-chunk-simple-1"></a>
        <table style="width: 100%" id="code-ref-process-chunk-simple-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="process-chunk-simple"></a><font size="-1"><font color="blue">process-chunk-simple</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>chunk_line(active_chunk, $0 ORS);
        </div></tt>
      </p><table style="width: 100%" id="code-end-process-chunk-simple-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      but in fact a chunk can include references to other chunks. Chunk
      includes are traditionally written as <tt class="verbatim">&lt;&lt;chunk-name&gt;&gt;</tt>
      but we support other variations, some of which are more suitable for
      particular editing systems.
    </p>
    <p>
      However, we also process tabs at this point, a tab at input can be
      replaced by a number of spaces defined by the <tt class="verbatim">tabs</tt>
      variable, set by the <tt class="verbatim">-T</tt> option. Of course this is poor
      tab behaviour, we should probably have the option to use proper counted
      tab-stops and process this on output.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-process-chunk-tabs-1"></a>
        <table style="width: 100%" id="code-ref-process-chunk-tabs-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="process-chunk-tabs"></a><font size="-1"><font color="blue">process-chunk-tabs</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (length(tabs)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  gsub(&quot;\t&quot;, tabs);</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-process-chunk-tabs-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h3 id="auto-77"><a id="sub:lst-listings-includes"></a>10.3.1<span style="margin-left: 1em"></span>lstlistings</h3>
    <p>
      If <tt class="verbatim">\lstset{escapeinside={=&lt;}{&gt;}}</tt> is set, then we
      can use <tt class="verbatim">=&lt;\chunkref{chunk-name}&gt;</tt> in listings. The
      sequence <tt class="verbatim">=&lt;</tt> was chosen because:
    </p>
    <ol>
      <li>
        it is a better mnemonic than <tt class="verbatim">&lt;&lt;chunk-name&gt;&gt;</tt>
        in that the <tt class="verbatim">=</tt> sign signifies equivalence or
        substitutability.
      </li>
      <li>
        and because <tt class="verbatim">=&lt;</tt> is not valid in C or any language I
        can think of.
      </li>
      <li>
        and also because lstlistings doesn't like <tt class="verbatim">&gt;&gt;</tt> as
        an end delimiter for the <em>texcl</em> escape, so we must make do
        with a single <tt class="verbatim">&gt;</tt> which is better complemented by <tt
        class="verbatim">=&lt;</tt> than by <tt class="verbatim">&lt;&lt;</tt>.
      </li>
    </ol>
    <p>
      Unfortunately the <tt class="verbatim">=&lt;...&gt;</tt> that we use re-enters a
      LaTeX parsing mode in which some characters are special, e.g. <tt class="verbatim">#
      \</tt> and so these cause trouble if used in arguments to <tt class="verbatim">\chunkref</tt>.
      At some point I must fix the LaTeX command <tt class="verbatim">\chunkref</tt> so
      that it can accept these literally, but until then, when writing
      chunkref argumemts that need these characters, I must use the forms <tt
      class="verbatim">\textbackslash{}</tt> and <tt class="verbatim">\#</tt>; so I also define a
      hacky chunk <tt class="verbatim">delatex</tt> to be used further on whose purpose
      it is to remove these from any arguments parsed by fangle.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-delatex-1"></a>
        <table style="width: 100%" id="code-ref-delatex-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="delatex"></a><font size="-1"><font color="blue">delatex</font>[1](<font
            color="blue">text</font>), lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt># FILTHY HACK
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>gsub(&quot;\\\\#&quot;, &quot;#&quot;, ${text});
<tt>3  </tt>gsub(&quot;\\\\textbackslash{}&quot;, &quot;\\&quot;, ${text});</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>gsub(&quot;\\\\\\^&quot;, &quot;^&quot;, ${text});
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-delatex-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      As each chunk line may contain more than one chunk include, we will
      split out chunk includes in an iterative fashion
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . Contrary to our use of split when substituting parameters in
                chapter <a href="#Here-we-split">?</a>
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-5"></a>
      <sup><a href="#footnote-5">5</a></sup>
      .
    </p>
    <p>
      First, as long as the chunk contains a <tt class="verbatim">\chunkref</tt> command
      we take as much as we can up to the first <tt class="verbatim">\chunkref</tt>
      command.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-process-chunk-1"></a>
        <table style="width: 100%" id="code-ref-process-chunk-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="process-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">process-chunk</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-process-chunk-2">60a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>chunk = $0;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>indent = 0;
<tt>3  </tt>while(match(chunk,&quot;(\xC2\xAB)([^\xC2]*) [^\xC2]*\xC2\xBB&quot;, line) ||
<tt>4  </tt>      match(chunk, 
<tt>5  </tt>            &quot;([=]&lt;\\\\chunkref{([^}&gt;]*)}(\\(.*\\)|)&gt;|&lt;&lt;([a-zA-Z_][-a-zA-Z0-9_]*)&gt;&gt;)&quot;, 
<tt>6  </tt>            line)\
<tt>7  </tt>) {</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>8  </tt>  chunklet = substr(chunk, 1, RSTART - 1);
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-process-chunk-1"></a>
      </p></font>
    </p>
    <p>
      We keep track of the indent count, by counting the number of literal
      characters found. We can then preserve this indent on each output line
      when multi-line chunks are expanded.
    </p>
    <p>
      We then process this first part literal text, and set the chunk which is
      still to be processed to be the text after the <tt class="verbatim">\chunkref</tt>
      command, which we will process next as we continue around the loop.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-process-chunk-2"></a>
        <table style="width: 100%" id="code-ref-process-chunk-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="process-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">process-chunk</font>[2]() &uArr;<a href="#code-ref-process-chunk-1">59c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-process-chunk-1">59c</a> <a href="#code-ref-process-chunk-3">60b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>9  </tt>  indent += length(chunklet);
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>10  </tt>  chunk_line(active_chunk, chunklet);</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>11  </tt>  chunk = substr(chunk, RSTART + RLENGTH);
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-process-chunk-2"></a>
      </p></font>
    </p>
    <p>
      We then consider the type of chunk command we have found, whether it is
      the fangle style command beginning with <tt class="verbatim">=&lt;</tt> the older
      notangle style beginning with <tt class="verbatim">&lt;&lt;</tt>.
    </p>
    <p>
      Fangle chunks may have parameters contained within square brackets.
      These will be matched in <tt class="verbatim">line[3]</tt> and are considered at
      this stage of processing to be part of the name of the chunk to be
      included.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-process-chunk-3"></a>
        <table style="width: 100%" id="code-ref-process-chunk-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="process-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">process-chunk</font>[3]() &uArr;<a href="#code-ref-process-chunk-1">59c</a>,
              lang=<font color="blue"><p>
                
              </p></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-process-chunk-2">60a</a> <a href="#code-ref-process-chunk-4">60c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>12  </tt>  if (substr(line[1], 1, 1) == &quot;=&quot;) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>13  </tt>    # chunk name up to }
<tt>14  </tt>        =&lt;\chunkref{delatex}(line[3])&gt;
<tt>15  </tt>    chunk_include(active_chunk, line[2] line[3], indent);
<tt>16  </tt>  } else if (substr(line[1], 1, 1) == &quot;&lt;&quot;) {
<tt>17  </tt>    chunk_include(active_chunk, line[4], indent);
<tt>18  </tt>  } else if (line[1] == &quot;\xC2\xAB&quot;) {
<tt>19  </tt>    chunk_include(active_chunk, line[2], indent);
<tt>20  </tt>  } else {
<tt>21  </tt>    error(&quot;Unknown chunk fragment: &quot; line[1]);</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>22  </tt>  }
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-process-chunk-3"></a>
      </p></font>
    </p>
    <p>
      The loop will continue until there are no more chunkref statements in
      the text, at which point we process the final part of the chunk.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-process-chunk-4"></a>
        <table style="width: 100%" id="code-ref-process-chunk-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="process-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">process-chunk</font>[4]() &uArr;<a href="#code-ref-process-chunk-1">59c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-process-chunk-3">60b</a> <a href="#code-ref-process-chunk-5">60d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>23  </tt>}
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>24  </tt>chunk_line(active_chunk, chunk);
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-process-chunk-4"></a>
      </p></font>
    </p>
    <p>
      <a id="lone-newline"></a>We add the newline character as a chunklet on it's own, to
      make it easier to detect new lines and thus manage indentation when
      processing the output.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-process-chunk-5"></a>
        <table style="width: 100%" id="code-ref-process-chunk-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="process-chunk"></a><font size="-1"><div class="left-tab">
              <font color="blue">process-chunk</font>[5]() &uArr;<a href="#code-ref-process-chunk-1">59c</a>,
              lang=<font color="blue"><p>
                
              </p></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-process-chunk-4">60c</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>25  </tt>chunk_line(active_chunk, &quot;\n&quot;);
        </div></tt>
      </p><table style="width: 100%" id="code-end-process-chunk-5">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We will also permit a chunk-part number to follow in square brackets, so
      that <tt class="verbatim">=&lt;\chunkref{chunk-name[1]}&gt;</tt> will refer to the
      first part only. This can make it easy to include a C function prototype
      in a header file, if the first part of the chunk is just the function
      prototype without the trailing semi-colon. The header file would include
      the prototype with the trailing semi-colon, like this:
    </p>
    <pre class="verbatim" xml:space="preserve">
=&lt;\chunkref{chunk-name[1]}&gt;</pre>
    <p>
      This is handled in section <a href="#sub:Chunk-parts">12.1.1</a>
    </p>
    <p>
      We should perhaps introduce a notion of language specific chunk options;
      so that perhaps we could specify:
    </p>
    <pre class="verbatim" xml:space="preserve">
=&lt;\chunkref{chunk-name[function-declaration]}</pre>
    <p>
      which applies a transform
      <tt class="verbatim">function-declaration</tt>
      to the chunk &ndash;- which in this case would extract a function
      prototype from a function.
      <table style="display: inline; vertical-align: -0.55em">
        <tbody><tr>
          <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid; border-left: 1px solid; border-left: 0.5px solid; border-right: 0.5px solid; border-bottom: 0.5px solid; border-top: 0.5px solid" bgcolor="#ffdfdf">To do: Do it</td>
        </tr></tbody>
      </table>
    </p>
    <h1 id="auto-78">Chapter 11<br></br>Processing Options</h1>
    <p>
      At the start, first we set the default options.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-default-options-1"></a>
        <table style="width: 100%" id="code-ref-default-options-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="default-options"></a><font size="-1"><font color="blue">default-options</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>debug=0;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>linenos=0;
<tt>3  </tt>notangle_mode=0;
<tt>4  </tt>root=&quot;*&quot;;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>tabs = &quot;&quot;;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-default-options-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      Then we use getopt the standard way, and null out ARGV afterwards in the
      normal AWK fashion.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-read-options-1"></a>
        <table style="width: 100%" id="code-ref-read-options-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="read-options"></a><font size="-1"><font color="blue">read-options</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>Optind = 1    # skip ARGV[0]
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>while(getopt(ARGC, ARGV, &quot;R:LdT:hr&quot;)!=-1) {
<tt>3  </tt>  =&lt;\chunkref{handle-options}&gt;
<tt>4  </tt>}</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>for (i=1; i&lt;Optind; i++) { ARGV[i]=&quot;&quot;; }
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-read-options-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      This is how we handle our options:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-handle-options-1"></a>
        <table style="width: 100%" id="code-ref-handle-options-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="handle-options"></a><font size="-1"><font color="blue">handle-options</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (Optopt == &quot;R&quot;) root = Optarg;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>else if (Optopt == &quot;r&quot;) root=&quot;&quot;;
<tt>3  </tt>else if (Optopt == &quot;L&quot;) linenos = 1;
<tt>4  </tt>else if (Optopt == &quot;d&quot;) debug = 1;
<tt>5  </tt>else if (Optopt == &quot;T&quot;) tabs = indent_string(Optarg+0);
<tt>6  </tt>else if (Optopt == &quot;h&quot;) help();</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>else if (Optopt == &quot;?&quot;) help();
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-handle-options-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We do all of this at the beginning of the program
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-begin-1"></a>
        <table style="width: 100%" id="code-ref-begin-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="begin"></a><font size="-1"><font color="blue">begin</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>BEGIN {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  =&lt;\chunkref{constants}&gt;
<tt>3  </tt>  =&lt;\chunkref{mode-definitions}&gt;
<tt>4  </tt>  =&lt;\chunkref{default-options}&gt;
<tt>5  </tt>
<tt>6  </tt>  =&lt;\chunkref{read-options}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-begin-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      And have a simple help function
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-help()-1"></a>
        <table style="width: 100%" id="code-ref-help()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="help()"></a><font size="-1"><font color="blue">help()</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function help() {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  print &quot;Usage:&quot;
<tt>3  </tt>  print &quot;  fangle [-L] -R&lt;rootname&gt; [source.tex ...]&quot;
<tt>4  </tt>  print &quot;  fangle -r [source.tex ...]&quot;
<tt>5  </tt>  print &quot;  If the filename, source.tex is not specified then stdin is used&quot;
<tt>6  </tt>  print
<tt>7  </tt>  print &quot;-L causes the C statement: #line &lt;lineno&gt; \&quot;filename\&quot;&quot; to be issued&quot;
<tt>8  </tt>  print &quot;-R causes the named root to be written to stdout&quot;
<tt>9  </tt>  print &quot;-r lists all roots in the file (even those used elsewhere)&quot;
<tt>10  </tt>  exit 1;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>11  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-help()-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-79">Chapter 12<br></br>Generating the Output</h1>
    <p>
      We generate output by calling output_chunk, or listing the chunk names.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-generate-output-1"></a>
        <table style="width: 100%" id="code-ref-generate-output-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="generate-output"></a><font size="-1"><font color="blue">generate-output</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (length(root)) output_chunk(root);
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>else output_chunk_names();
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-generate-output-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We also have some other output debugging:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-debug-output-1"></a>
        <table style="width: 100%" id="code-ref-debug-output-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="debug-output"></a><font size="-1"><font color="blue">debug-output</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (debug) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  print &quot;------ chunk names &quot;
<tt>3  </tt>  output_chunk_names();
<tt>4  </tt>  print &quot;====== chunks&quot;
<tt>5  </tt>  output_chunks();
<tt>6  </tt>  print &quot;++++++ debug&quot;
<tt>7  </tt>  for (a in chunks) {
<tt>8  </tt>    print a &quot;=&quot; chunks[a];
<tt>9  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-debug-output-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We do both of these at the end. We also set <tt class="verbatim">ORS=&quot;&quot;</tt>
      because each chunklet is not necessarily a complete line, and we already
      added <tt class="verbatim">ORS</tt> to each input line in section <a href="#sub:ORS-chunk-text">10.3</a>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-end-1"></a>
        <table style="width: 100%" id="code-ref-end-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="end"></a><font size="-1"><font color="blue">end</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>END {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  =&lt;\chunkref{debug-output}&gt;
<tt>3  </tt>  ORS=&quot;&quot;;
<tt>4  </tt>  =&lt;\chunkref{generate-output}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-end-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We write chunk names like this. If we seem to be running in notangle
      compatibility mode, then we enclose the name like this <tt class="verbatim">&lt;&lt;name&gt;&gt;</tt>
      the same way notangle does:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-output_chunk_names()-1"></a>
        <table style="width: 100%" id="code-ref-output_chunk_names()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="output_chunk_names()"></a><font size="-1"><font color="blue">output_chunk_names()</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function output_chunk_names(   c, prefix, suffix) 
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>{
<tt>3  </tt>  if (notangle_mode) {
<tt>4  </tt>    prefix=&quot;&lt;&lt;&quot;;
<tt>5  </tt>    suffix=&quot;&gt;&gt;&quot;;
<tt>6  </tt>  }
<tt>7  </tt>  for (c in chunk_names) {
<tt>8  </tt>    print prefix c suffix &quot;\n&quot;;
<tt>9  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-output_chunk_names()-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      This function would write out all chunks
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-output_chunks()-1"></a>
        <table style="width: 100%" id="code-ref-output_chunks()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="output_chunks()"></a><font size="-1"><font color="blue">output_chunks()</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function output_chunks(  a) 
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>{
<tt>3  </tt>  for (a in chunk_names) {
<tt>4  </tt>    output_chunk(a);
<tt>5  </tt>  }
<tt>6  </tt>}
<tt>7  </tt>
<tt>8  </tt>function output_chunk(chunk) {
<tt>9  </tt>  newline = 1;
<tt>10  </tt>  lineno_needed = linenos;
<tt>11  </tt>
<tt>12  </tt>  write_chunk(chunk);
<tt>13  </tt>}</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>14  </tt>
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-output_chunks()-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-80">12.1<span style="margin-left: 1em"></span>Assembling the Chunks</h2>
    <p>
      <tt class="verbatim">chunk_path</tt> holds a string consisting of the names of all
      the chunks that resulted in this chunk being output. It should probably
      also contain the source line numbers at which each inclusion also
      occured.
    </p>
    <p>
      We first initialize the mode tracker for this chunk.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write_chunk()-1"></a>
        <table style="width: 100%" id="code-ref-write_chunk()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write_chunk()"></a><font size="-1"><div class="left-tab">
              <font color="blue">write_chunk()</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-write_chunk()-2">64b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function write_chunk(chunk_name) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  =&lt;\chunkref{awk-delete-array}(context)&gt;
<tt>3  </tt>  return write_chunk_r(chunk_name, context);
<tt>4  </tt>}
<tt>5  </tt>
<tt>6  </tt>function write_chunk_r(chunk_name, context, indent, tail,
<tt>7  </tt>  # optional vars
<tt>8  </tt>  <i>chunk_path</i>, chunk_args, 
<tt>9  </tt>  s, r, src, new_src, 
<tt>10  </tt>  # local vars
<tt>11  </tt>  chunk_params, part, max_part, part_line, frag, max_frag, text, 
<tt>12  </tt>  chunklet, only_part, call_chunk_args, new_context)
<tt>13  </tt>{</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>14  </tt>  if (debug) debug_log(&quot;write_chunk_r(&quot;,
            chunk_name, &quot;)&quot;);
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-write_chunk()-1"></a>
      </p></font>
    </p>
    <h3 id="auto-81"><a id="sub:Chunk-parts"></a>12.1.1<span style="margin-left: 1em"></span>Chunk Parts</h3>
    <p>
      As mentioned in section <a href="#sub:lstlistings-includes">?</a>, a chunk name may contain a part
      specifier in square brackets, limiting the parts that should be emitted.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write_chunk()-2"></a>
        <table style="width: 100%" id="code-ref-write_chunk()-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write_chunk()"></a><font size="-1"><div class="left-tab">
              <font color="blue">write_chunk()</font>[2]() &uArr;<a href="#code-ref-write_chunk()-1">64a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-write_chunk()-1">64a</a> <a href="#code-ref-write_chunk()-3">64c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>15  </tt>  if (match(chunk_name,
            &quot;^(.*)\\[([0-9]*)\\]$&quot;, chunk_name_parts)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>16  </tt>    chunk_name = chunk_name_parts[1];
<tt>17  </tt>    only_part = chunk_name_parts[2];</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>  }
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-write_chunk()-2"></a>
      </p></font>
    </p>
    <p>
      We then create a mode tracker
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write_chunk()-3"></a>
        <table style="width: 100%" id="code-ref-write_chunk()-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write_chunk()"></a><font size="-1"><div class="left-tab">
              <font color="blue">write_chunk()</font>[3]() &uArr;<a href="#code-ref-write_chunk()-1">64a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-write_chunk()-2">64b</a> <a href="#code-ref-write_chunk()-4">65a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>19  </tt> =&lt;\chunkref{new-mode-tracker}(context,
          chunks[chunk_name, &quot;language&quot;], &quot;&quot;)&gt;
        </div></tt>
      </p><p>
        <a id="code-end-write_chunk()-3"></a>
      </p></font>
    </p>
    <p>
      We extract into <tt class="verbatim">chunk_params</tt> the names of the parameters
      that this chunk accepts, whose values were (optionally) passed in <tt
      class="verbatim">chunk_args</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write_chunk()-4"></a>
        <table style="width: 100%" id="code-ref-write_chunk()-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write_chunk()"></a><font size="-1"><div class="left-tab">
              <font color="blue">write_chunk()</font>[4]() &uArr;<a href="#code-ref-write_chunk()-1">64a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-write_chunk()-3">64c</a> <a href="#code-ref-write_chunk()-5">65b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>20  </tt> split(chunks[chunk_name, &quot;params&quot;],
          chunk_params, &quot; *; *&quot;);
        </div></tt>
      </p><p>
        <a id="code-end-write_chunk()-4"></a>
      </p></font>
    </p>
    <p>
      To assemble a chunk, we write out each part.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write_chunk()-5"></a>
        <table style="width: 100%" id="code-ref-write_chunk()-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write_chunk()"></a><font size="-1"><div class="left-tab">
              <font color="blue">write_chunk()</font>[5]() &uArr;<a href="#code-ref-write_chunk()-1">64a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-write_chunk()-4">65a</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>21  </tt>  if (! (chunk_name in chunk_names)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>22  </tt>    error(sprintf(_&quot;The root module &lt;&lt;%s&gt;&gt; was not defined.\nUsed by: %s&quot;,\
<tt>23  </tt>                  chunk_name, chunk_path));
<tt>24  </tt>  }
<tt>25  </tt>
<tt>26  </tt>  max_part = chunks[chunk_name, &quot;part&quot;];
<tt>27  </tt>  for(part = 1; part &lt;= max_part; part++) {
<tt>28  </tt>    if (! only_part || part == only_part) {
<tt>29  </tt>      =&lt;\chunkref{write-part}&gt;
<tt>30  </tt>    }
<tt>31  </tt>  }
<tt>32  </tt>  if (! finalize_mode_tracker(context)) {
<tt>33  </tt>    dump_mode_tracker(context);
<tt>34  </tt>    error(sprintf(_&quot;Module %s did not close context properly.\nUsed by: %s\n&quot;, chunk_name, chunk_path));
<tt>35  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>36  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-write_chunk()-5">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      A part can either be a chunklet of lines, or an include of another
      chunk.
    </p>
    <p>
      Chunks may also have parameters, specified in LaTeX style with braces
      after the chunk name &ndash;- looking like this in the document:
      chunkname{param1, param2}. Arguments are passed in square brackets: <tt
      class="verbatim">\chunkref{chunkname}[arg1, arg2]</tt>.
    </p>
    <p>
      Before we process each part, we check that the source position hasn't
      changed unexpectedly, so that we can know if we need to output a new
      file-line directive.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-part-1"></a>
        <table style="width: 100%" id="code-ref-write-part-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-part"></a><font size="-1"><font color="blue">write-part</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{check-source-jump}&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>
<tt>3  </tt>chunklet = chunks[chunk_name, &quot;part&quot;, part];
<tt>4  </tt>if (chunks[chunk_name, &quot;part&quot;, part, &quot;type&quot;] == part_type_chunk) {
<tt>5  </tt>  =&lt;\chunkref{write-included-chunk}&gt;
<tt>6  </tt>} else if (chunklet SUBSEP &quot;line&quot; in chunks) {
<tt>7  </tt>  =&lt;\chunkref{write-chunklets}&gt;
<tt>8  </tt>} else {
<tt>9  </tt>  # empty last chunklet</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-write-part-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      To write an included chunk, we must detect any optional chunk arguments
      in parenthesis. Then we recurse calling <tt class="verbatim">write_chunk()</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-included-chunk-1"></a>
        <table style="width: 100%" id="code-ref-write-included-chunk-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-included-chunk"></a><font size="-1"><font color="blue">write-included-chunk</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (match(chunklet,
            &quot;^([^\\[\\(]*)\\((.*)\\)$&quot;, chunklet_parts)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  chunklet = chunklet_parts[1];
<tt>3  </tt>  parse_chunk_args(&quot;c-like&quot;, chunklet_parts[2], call_chunk_args, &quot;(&quot;);
<tt>4  </tt>  for (c in call_chunk_args) {
<tt>5  </tt>    call_chunk_args[c] = expand_chunk_args(call_chunk_args[c], chunk_params, chunk_args);
<tt>6  </tt>  }
<tt>7  </tt>} else {
<tt>8  </tt>  split(&quot;&quot;, call_chunk_args);
<tt>9  </tt>}
<tt>10  </tt># update the transforms arrays
<tt>11  </tt>new_src = mode_escaper(context, s, r, src);
<tt>12  </tt>=&lt;\chunkref{awk-delete-array}(new_context)&gt;
<tt>13  </tt>write_chunk_r(chunklet, new_context,
<tt>14  </tt>            chunks[chunk_name, &quot;part&quot;, part, &quot;indent&quot;] indent,
<tt>15  </tt>            chunks[chunk_name, &quot;part&quot;, part, &quot;tail&quot;],
<tt>16  </tt>            chunk_path &quot;\n         &quot; chunk_name,
<tt>17  </tt>            call_chunk_args,</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>            s, r, new_src);
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-write-included-chunk-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      Before we output a chunklet of lines, we first emit the file and line
      number if we have one, and if it is safe to do so.
    </p>
    <p>
      Chunklets are generally broken up by includes, so the start of a
      chunklet is a good place to do this. Then we output each line of the
      chunklet.
    </p>
    <p>
      When it is not safe, such as in the middle of a multi-line macro
      definition, <tt class="verbatim">lineno_suppressed</tt> is set to true, and in
      such a case we note that we want to emit the line statement when it is
      next safe.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-chunklets-1"></a>
        <table style="width: 100%" id="code-ref-write-chunklets-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-chunklets"></a><font size="-1"><div class="left-tab">
              <font color="blue">write-chunklets</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-write-chunklets-2">66b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>max_frag = chunks[chunklet, &quot;line&quot;];
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>for(frag = 1; frag &lt;= max_frag; frag++) {</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>  =&lt;\chunkref{write-file-line}&gt;
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-write-chunklets-1"></a>
      </p></font>
    </p>
    <p>
      We then extract the chunklet text and expand any arguments.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-chunklets-2"></a>
        <table style="width: 100%" id="code-ref-write-chunklets-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-chunklets"></a><font size="-1"><div class="left-tab">
              <font color="blue">write-chunklets</font>[2]() &uArr;<a href="#code-ref-write-chunklets-1">66a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-write-chunklets-1">66a</a> <a href="#code-ref-write-chunklets-3">66c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>5  </tt>  text = chunks[chunklet, frag];
<tt>6  </tt> 
<tt>7  </tt>  /* check params */</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>8  </tt>  text = expand_chunk_args(text, chunk_params,
            chunk_args);
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-write-chunklets-2"></a>
      </p></font>
    </p>
    <p>
      If the text is a single newline (which we keep separate - see <a href="#lone-newline">5</a>)
      then we increment the line number. In the case where this is the last
      line of a chunk and it is not a top-level chunk we replace the newline
      with an empty string &ndash;- because the chunk that included this chunk
      will have the newline at the end of the line that included this chunk.
    </p>
    <p>
      We also note by <tt class="verbatim">newline = 1</tt> that we have started a new
      line, so that indentation can be managed with the following piece of
      text.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-chunklets-3"></a>
        <table style="width: 100%" id="code-ref-write-chunklets-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-chunklets"></a><font size="-1"><div class="left-tab">
              <font color="blue">write-chunklets</font>[3]() &uArr;<a href="#code-ref-write-chunklets-1">66a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-write-chunklets-2">66b</a> <a href="#code-ref-write-chunklets-4">66d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>9  </tt>
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>10  </tt> if (text == &quot;\n&quot;) {
<tt>11  </tt>    lineno++;
<tt>12  </tt>    if (part == max_part &amp;&amp; frag == max_frag &amp;&amp; length(chunk_path)) {
<tt>13  </tt>      text = &quot;&quot;;
<tt>14  </tt>      break;
<tt>15  </tt>    } else {
<tt>16  </tt>      newline = 1;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>17  </tt>    }
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-write-chunklets-3"></a>
      </p></font>
    </p>
    <p>
      If this text does not represent a newline, but we see that we are the
      first piece of text on a newline, then we prefix our text with the
      current indent. 
    </p>
    <p style="margin-top: 1em; margin-bottom: 1em">
      <b>Note <class style="font-style: normal">1</class>. </b><tt class="verbatim">newline</tt> is a global
      output-state variable, but the <tt class="verbatim">indent</tt> is not.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-chunklets-4"></a>
        <table style="width: 100%" id="code-ref-write-chunklets-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-chunklets"></a><font size="-1"><div class="left-tab">
              <font color="blue">write-chunklets</font>[4]() &uArr;<a href="#code-ref-write-chunklets-1">66a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-write-chunklets-3">66c</a> <a href="#code-ref-write-chunklets-5">67a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>  } else if (length(text) || length(tail)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>19  </tt>    if (newline) text = indent text;
<tt>20  </tt>    newline = 0;
<tt>21  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>22  </tt>
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-write-chunklets-4"></a>
      </p></font>
    </p>
    <p>
      Tail will soon no longer be relevant once mode-detection is in place.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-chunklets-5"></a>
        <table style="width: 100%" id="code-ref-write-chunklets-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-chunklets"></a><font size="-1"><div class="left-tab">
              <font color="blue">write-chunklets</font>[5]() &uArr;<a href="#code-ref-write-chunklets-1">66a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-write-chunklets-4">66d</a> <a href="#code-ref-write-chunklets-6">67b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>23  </tt>  text = text tail;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>24  </tt>  mode_tracker(context, text);</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>25  </tt>  print untab(transform_escape(s, r, text, src));
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-write-chunklets-5"></a>
      </p></font>
    </p>
    <p>
      If a line ends in a backslash &ndash;- suggesting continuation &ndash;-
      then we supress outputting file-line as it would probably break the
      continued lines.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-chunklets-6"></a>
        <table style="width: 100%" id="code-ref-write-chunklets-6">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-chunklets"></a><font size="-1"><div class="left-tab">
              <font color="blue">write-chunklets</font>[6]() &uArr;<a href="#code-ref-write-chunklets-1">66a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-write-chunklets-5">67a</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>26  </tt>  if (linenos) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>27  </tt>    lineno_suppressed = substr(lastline, length(lastline)) == &quot;\\&quot;;
<tt>28  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>29  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-write-chunklets-6">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      Of course there is no point in actually outputting the source filename
      and line number (file-line) if they don't say anything new! We only need
      to emit them if they aren't what is expected, or if we we not able to
      emit one when they had changed.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-write-file-line-1"></a>
        <table style="width: 100%" id="code-ref-write-file-line-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="write-file-line"></a><font size="-1"><font color="blue">write-file-line</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (newline &amp;&amp; lineno_needed &amp;&amp; !
            lineno_suppressed) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  filename = a_filename;
<tt>3  </tt>  lineno = a_lineno;
<tt>4  </tt>  print &quot;#line &quot; lineno &quot; \&quot;&quot; filename &quot;\&quot;\n&quot;
<tt>5  </tt>  lineno_needed = 0;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-write-file-line-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      We check if a new file-line is needed by checking if the source line
      matches what we (or a compiler) would expect.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-check-source-jump-1"></a>
        <table style="width: 100%" id="code-ref-check-source-jump-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="check-source-jump"></a><font size="-1"><font color="blue">check-source-jump</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>if (linenos &amp;&amp; (chunk_name SUBSEP
            &quot;part&quot; SUBSEP part SUBSEP &quot;FILENAME&quot; in
            chunks)) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  a_filename = chunks[chunk_name, &quot;part&quot;, part, &quot;FILENAME&quot;];
<tt>3  </tt>  a_lineno = chunks[chunk_name, &quot;part&quot;, part, &quot;LINENO&quot;];
<tt>4  </tt>  if (a_filename != filename || a_lineno != lineno) {
<tt>5  </tt>    lineno_needed++;
<tt>6  </tt>  }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-check-source-jump-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-82">Chapter 13<br></br>Storing Chunks</h1>
    <p>
      Awk has pretty limited data structures, so we will use two main hashes.
      Uninterrupted sequences of a chunk will be stored in chunklets and the
      chunklets used in a chunk will be stored in <tt class="verbatim">chunks</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-constants-1"></a>
        <table style="width: 100%" id="code-ref-constants-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="constants"></a><font size="-1"><font color="blue">constants</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>part_type_chunk=1;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>SUBSEP=&quot;,&quot;;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-constants-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      The params mentioned are not chunk parameters for parameterized chunks,
      as mentioned in
      <a href="#Chunk Arguments">8.2</a>
      , but the lstlistings style parameters used in the
      <tt class="verbatim">\Chunk</tt>
      command
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . The <tt class="verbatim">params</tt> parameter is used to hold the
                parameters for parameterized chunks
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-1"></a>
      <sup><a href="#footnote-1">1</a></sup>
      .
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-chunk-storage-functions-1"></a>
        <table style="width: 100%" id="code-ref-chunk-storage-functions-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="chunk-storage-functions"></a><font size="-1"><div class="left-tab">
              <font color="blue">chunk-storage-functions</font>[1](), lang=<font
              color="blue"></font> &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-chunk-storage-functions-2">69c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function new_chunk(chunk_name, params,
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  # local vars
<tt>3  </tt>  p, append )
<tt>4  </tt>{
<tt>5  </tt>  # HACK WHILE WE CHANGE TO ( ) for PARAM CHUNKS
<tt>6  </tt>  gsub(&quot;\\(\\)$&quot;, &quot;&quot;, chunk_name);
<tt>7  </tt>  if (! (chunk_name in chunk_names)) {
<tt>8  </tt>    if (debug) print &quot;New chunk &quot; chunk_name;
<tt>9  </tt>    chunk_names[chunk_name];
<tt>10  </tt>    for (p in params) {
<tt>11  </tt>      chunks[chunk_name, p] = params[p];
<tt>12  </tt>      if (debug) print &quot;chunks[&quot; chunk_name &quot;,&quot; p &quot;] = &quot; params[p];
<tt>13  </tt>    }
<tt>14  </tt>    if (&quot;append&quot; in params) {
<tt>15  </tt>      append=params[&quot;append&quot;];
<tt>16  </tt>      if (! (append in chunk_names)) {
<tt>17  </tt>        warning(&quot;Chunk &quot; chunk_name &quot; is appended to chunk &quot; append &quot; which is not defined yet&quot;);
<tt>18  </tt>        new_chunk(append);
<tt>19  </tt>      }
<tt>20  </tt>      chunk_include(append, chunk_name);
<tt>21  </tt>      chunk_line(append, ORS);
<tt>22  </tt>    }
<tt>23  </tt>  }
<tt>24  </tt>  active_chunk = chunk_name;
<tt>25  </tt>  prime_chunk(chunk_name);</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>26  </tt>}
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-chunk-storage-functions-1"></a>
      </p></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-chunk-storage-functions-2"></a>
        <table style="width: 100%" id="code-ref-chunk-storage-functions-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="chunk-storage-functions"></a><font size="-1"><div class="left-tab">
              <font color="blue">chunk-storage-functions</font>[2]() &uArr;<a href="#code-ref-chunk-storage-functions-1">69b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-chunk-storage-functions-1">69b</a> <a href="#code-ref-chunk-storage-functions-3">70a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>27  </tt>
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>28  </tt>function prime_chunk(chunk_name)
<tt>29  </tt>{
<tt>30  </tt>  chunks[chunk_name, &quot;part&quot;, ++chunks[chunk_name, &quot;part&quot;] ] = \
<tt>31  </tt>         chunk_name SUBSEP &quot;chunklet&quot; SUBSEP &quot;&quot; ++chunks[chunk_name, &quot;chunklet&quot;];
<tt>32  </tt>  chunks[chunk_name, &quot;part&quot;, chunks[chunk_name, &quot;part&quot;], &quot;FILENAME&quot;] = FILENAME;
<tt>33  </tt>  chunks[chunk_name, &quot;part&quot;, chunks[chunk_name, &quot;part&quot;], &quot;LINENO&quot;] = FNR + 1;
<tt>34  </tt>}
<tt>35  </tt>
<tt>36  </tt>function chunk_line(chunk_name, line){
<tt>37  </tt>  chunks[chunk_name, &quot;chunklet&quot;, chunks[chunk_name, &quot;chunklet&quot;],
<tt>38  </tt>         ++chunks[chunk_name, &quot;chunklet&quot;, chunks[chunk_name, &quot;chunklet&quot;], &quot;line&quot;]  ] = line;
<tt>39  </tt>}</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>40  </tt>
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-chunk-storage-functions-2"></a>
      </p></font>
    </p>
    <p>
      Chunk include represents a <em>chunkref</em> statement, and stores the
      requirement to include another chunk. The parameter indent represents
      the quanity of literal text characters that preceded this
      <em>chunkref</em> statement and therefore by how much additional lines
      of the included chunk should be indented.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-chunk-storage-functions-3"></a>
        <table style="width: 100%" id="code-ref-chunk-storage-functions-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="chunk-storage-functions"></a><font size="-1"><div class="left-tab">
              <font color="blue">chunk-storage-functions</font>[3]() &uArr;<a href="#code-ref-chunk-storage-functions-1">69b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-chunk-storage-functions-2">69c</a> <a href="#code-ref-chunk-storage-functions-4">70b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>41  </tt>function chunk_include(chunk_name, chunk_ref, indent,
            tail)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>42  </tt>{
<tt>43  </tt>  chunks[chunk_name, &quot;part&quot;, ++chunks[chunk_name, &quot;part&quot;] ] = chunk_ref;
<tt>44  </tt>  chunks[chunk_name, &quot;part&quot;, chunks[chunk_name, &quot;part&quot;], &quot;type&quot; ] = part_type_chunk;
<tt>45  </tt>  chunks[chunk_name, &quot;part&quot;, chunks[chunk_name, &quot;part&quot;], &quot;indent&quot; ] = indent_string(indent);
<tt>46  </tt>  chunks[chunk_name, &quot;part&quot;, chunks[chunk_name, &quot;part&quot;], &quot;tail&quot; ] = tail;
<tt>47  </tt>  prime_chunk(chunk_name);
<tt>48  </tt>}</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>49  </tt>
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-chunk-storage-functions-3"></a>
      </p></font>
    </p>
    <p>
      The indent is calculated by indent_string, which may in future convert
      some spaces into tab characters. This function works by generating a
      printf padded format string, like <tt class="verbatim">%22s</tt> for an indent of
      22, and then printing an empty string using that format.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-chunk-storage-functions-4"></a>
        <table style="width: 100%" id="code-ref-chunk-storage-functions-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="chunk-storage-functions"></a><font size="-1"><div class="left-tab">
              <font color="blue">chunk-storage-functions</font>[4]() &uArr;<a href="#code-ref-chunk-storage-functions-1">69b</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-chunk-storage-functions-3">70a</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>50  </tt>function indent_string(indent) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>51  </tt>  return sprintf(&quot;%&quot; indent &quot;s&quot;, &quot;&quot;);</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>52  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-chunk-storage-functions-4">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-83"><a id="cha:getopt"></a>Chapter 14<br></br>getopt</h1>
    <p>
      I use Arnold Robbins public domain getopt (1993 revision). This is
      probably the same one that is covered in chapter 12 of
      &acirc;&#x0102;&#x0132;Edition 3 of GAWK: Effective AWK Programming: A
      User's Guide for GNU Awk&acirc;&#x0102;&#x0130; but as that is licensed
      under the GNU Free Documentation License, Version 1.3, which conflicts
      with the GPL3, I can't use it from there (or it's accompanying
      explanations), so I do my best to explain how it works here.
    </p>
    <p>
      The getopt.awk header is:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-getopt.awk-header-1"></a>
        <table style="width: 100%" id="code-ref-getopt.awk-header-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="getopt.awk-header"></a><font size="-1"><font color="blue">getopt.awk-header</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt># getopt.awk &ndash;- do C library getopt(3) function
            in awk
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>#
<tt>3  </tt># Arnold Robbins, arnold@skeeve.com, Public Domain
<tt>4  </tt>#
<tt>5  </tt># Initial version: March, 1991
<tt>6  </tt># Revised: May, 1993</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>7  </tt>
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-getopt.awk-header-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      The provided explanation is:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-getopt.awk-notes-1"></a>
        <table style="width: 100%" id="code-ref-getopt.awk-notes-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="getopt.awk-notes"></a><font size="-1"><font color="blue">getopt.awk-notes</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt># External variables:
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>#    Optind -- index in ARGV of first nonoption argument
<tt>3  </tt>#    Optarg -- string value of argument to current option
<tt>4  </tt>#    Opterr -- if nonzero, print our own diagnostic
<tt>5  </tt>#    Optopt -- current option letter
<tt>6  </tt>
<tt>7  </tt># Returns:
<tt>8  </tt>#    -1     at end of options
<tt>9  </tt>#    ?      for unrecognized option
<tt>10  </tt>#    &lt;c&gt;    a character representing the current option
<tt>11  </tt>
<tt>12  </tt># Private Data:
<tt>13  </tt>#    _opti  -- index in multi-flag option, e.g., -abc</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>14  </tt>
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-getopt.awk-notes-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      The function follows. The final two parameters, <tt class="verbatim">thisopt</tt>
      and <tt class="verbatim">i</tt> are local variables and not parameters &ndash;- as
      indicated by the multiple spaces preceding them. Awk doesn't care, the
      multiple spaces are a convention to help us humans.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-getopt.awk-getopt()-1"></a>
        <table style="width: 100%" id="code-ref-getopt.awk-getopt()-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="getopt.awk-getopt()"></a><font size="-1"><div class="left-tab">
              <font color="blue">getopt.awk-getopt()</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-getopt.awk-getopt()-2">72a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>function getopt(argc, argv, options,    thisopt, i)
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>{
<tt>3  </tt>    if (length(options) == 0)    # no options given
<tt>4  </tt>        return -1
<tt>5  </tt>    if (argv[Optind] == &quot;--&quot;) {  # all done
<tt>6  </tt>        Optind++
<tt>7  </tt>        _opti = 0
<tt>8  </tt>        return -1
<tt>9  </tt>    } else if (argv[Optind] !~ /^-[^: \t\n\f\r\v\b]/) {
<tt>10  </tt>        _opti = 0
<tt>11  </tt>        return -1
<tt>12  </tt>    }
<tt>13  </tt>    if (_opti == 0)
<tt>14  </tt>        _opti = 2
<tt>15  </tt>    thisopt = substr(argv[Optind], _opti, 1)
<tt>16  </tt>    Optopt = thisopt
<tt>17  </tt>    i = index(options, thisopt)
<tt>18  </tt>    if (i == 0) {
<tt>19  </tt>        if (Opterr)
<tt>20  </tt>            printf(&quot;%c -- invalid option\n&quot;,
<tt>21  </tt>                                  thisopt) &gt; &quot;/dev/stderr&quot;
<tt>22  </tt>        if (_opti &gt;= length(argv[Optind])) {
<tt>23  </tt>            Optind++
<tt>24  </tt>            _opti = 0
<tt>25  </tt>        } else
<tt>26  </tt>            _opti++
<tt>27  </tt>        return &quot;?&quot;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>28  </tt>    }
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-getopt.awk-getopt()-1"></a>
      </p></font>
    </p>
    <p>
      At this point, the option has been found and we need to know if it takes
      any arguments.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-getopt.awk-getopt()-2"></a>
        <table style="width: 100%" id="code-ref-getopt.awk-getopt()-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="getopt.awk-getopt()"></a><font size="-1"><div class="left-tab">
              <font color="blue">getopt.awk-getopt()</font>[2]() &uArr;<a href="#code-ref-getopt.awk-getopt()-1">71c</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-getopt.awk-getopt()-1">71c</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>29  </tt>    if (substr(options, i + 1, 1) == &quot;:&quot;) {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>30  </tt>        # get option argument
<tt>31  </tt>        if (length(substr(argv[Optind], _opti + 1)) &gt; 0)
<tt>32  </tt>            Optarg = substr(argv[Optind], _opti + 1)
<tt>33  </tt>        else
<tt>34  </tt>            Optarg = argv[++Optind]
<tt>35  </tt>        _opti = 0
<tt>36  </tt>    } else
<tt>37  </tt>        Optarg = &quot;&quot;
<tt>38  </tt>    if (_opti == 0 || _opti &gt;= length(argv[Optind])) {
<tt>39  </tt>        Optind++
<tt>40  </tt>        _opti = 0
<tt>41  </tt>    } else
<tt>42  </tt>        _opti++
<tt>43  </tt>    return thisopt</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>44  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-getopt.awk-getopt()-2">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      A test program is built in, too
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-getopt.awk-begin-1"></a>
        <table style="width: 100%" id="code-ref-getopt.awk-begin-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="getopt.awk-begin"></a><font size="-1"><font color="blue">getopt.awk-begin</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>BEGIN {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>    Opterr = 1    # default is to diagnose
<tt>3  </tt>    Optind = 1    # skip ARGV[0]
<tt>4  </tt>    # test program
<tt>5  </tt>    if (_getopt_test) {
<tt>6  </tt>        while ((_go_c = getopt(ARGC, ARGV, &quot;ab:cd&quot;)) != -1)
<tt>7  </tt>            printf(&quot;c = &lt;%c&gt;, optarg = &lt;%s&gt;\n&quot;,
<tt>8  </tt>                                       _go_c, Optarg)
<tt>9  </tt>        printf(&quot;non-option arguments:\n&quot;)
<tt>10  </tt>        for (; Optind &lt; ARGC; Optind++)
<tt>11  </tt>            printf(&quot;\tARGV[%d] = &lt;%s&gt;\n&quot;,
<tt>12  </tt>                                    Optind, ARGV[Optind])
<tt>13  </tt>    }</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>14  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-getopt.awk-begin-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      The entire getopt.awk is made out of these chunks in order
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-getopt.awk-1"></a>
        <table style="width: 100%" id="code-ref-getopt.awk-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="getopt.awk"></a><font size="-1"><font color="blue">getopt.awk</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>=&lt;\chunkref{getopt.awk-header}&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>
<tt>3  </tt>=&lt;\chunkref{getopt.awk-notes}&gt;
<tt>4  </tt>=&lt;\chunkref{getopt.awk-getopt()}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>=&lt;\chunkref{getopt.awk-begin}&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-getopt.awk-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      Although we only want the header and function:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-getopt-1"></a>
        <table style="width: 100%" id="code-ref-getopt-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="getopt"></a><font size="-1"><font color="blue">getopt</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt># try: locate getopt.awk for the full original file
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt># as part of your standard awk installation
<tt>3  </tt>=&lt;\chunkref{getopt.awk-header}&gt;
<tt>4  </tt></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>=&lt;\chunkref{getopt.awk-getopt()}&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-getopt-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-84"><a id="latex-source"></a>Chapter 15<br></br>Fangle LaTeX source code</h1>
    <h2 id="auto-85">15.1<span style="margin-left: 1em"></span>fangle module</h2>
    <p>
      Here we define a L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X <tt class="verbatim">.module</tt>
      file that makes it convenient to use L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X
      for writing such literate programs.
    </p>
    <p>
      This file <tt class="verbatim">./fangle.module</tt> can be installed in your
      personal <tt class="verbatim">.lyx/layouts</tt> folder. You will need to Tools
      Reconfigure so that L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X notices
      it. It adds a new format Chunk, which should precede every listing and
      contain the chunk name.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.module-1"></a>
        <table style="width: 100%" id="code-ref-./fangle.module-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.module"></a><font size="-1"><font color="blue">./fangle.module</font>[1](),
            lang=<font color="blue">lyx-module</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>#\DeclareLyXModule{Fangle Literate Listings}
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>#DescriptionBegin
<tt>3  </tt>#  Fangle literate listings allow one to write
<tt>4  </tt>#   literate programs after the fashion of noweb, but without having
<tt>5  </tt>#   to use noweave to generate the documentation. Instead the listings
<tt>6  </tt>#   package is extended in conjunction with the noweb package to implement
<tt>7  </tt>#   to code formating directly as latex.
<tt>8  </tt>#  The fangle awk script
<tt>9  </tt>#DescriptionEnd
<tt>10  </tt>
<tt>11  </tt>=&lt;\chunkref{gpl3-copyright.hashed}&gt;
<tt>12  </tt>
<tt>13  </tt>Format 11
<tt>14  </tt>
<tt>15  </tt>AddToPreamble
<tt>16  </tt>=&lt;\chunkref{./fangle.sty}&gt;
<tt>17  </tt>EndPreamble
<tt>18  </tt>
<tt>19  </tt>=&lt;\chunkref{chunkstyle}&gt;
<tt>20  </tt></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>21  </tt>=&lt;\chunkref{chunkref}&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-./fangle.module-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      Because L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X modules are not yet
      a language supported by fangle or lstlistings, we resort to this fake
      awk chunk below in order to have each line of the GPL3 license commence
      with a #
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-gpl3-copyright.hashed-1"></a>
        <table style="width: 100%" id="code-ref-gpl3-copyright.hashed-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="gpl3-copyright.hashed"></a><font size="-1"><font color="blue">gpl3-copyright.hashed</font>[1](),
            lang=<font color="blue">awk</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>#=&lt;\chunkref{gpl3-copyright}&gt;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-gpl3-copyright.hashed-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h3 id="auto-86">15.1.1<span style="margin-left: 1em"></span>The Chunk style</h3>
    <p>
      The purpose of the <class style="font-variant: small-caps">chunk</class> style is to make it
      easier for L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X users to provide
      the name to <tt class="verbatim">lstlistings</tt>. Normally this requires
      right-clicking on the listing, choosing settings, advanced, and then
      typing <tt class="verbatim">name=chunk-name</tt>. This has the further
      disadvantage that the name (and other options) are not generally visible
      during document editing.
    </p>
    <p>
      The chunk style is defined as a LaTeX command, so that all text on the
      same line is passed to the <tt class="verbatim">LaTeX</tt> command <tt class="verbatim">Chunk</tt>.
      This makes it easy to parse using <tt class="verbatim">fangle</tt>, and easy to
      pass these options on to the listings package. The first word in a chunk
      section should be the chunk name, and will have <tt class="verbatim">name=</tt>
      prepended to it. Any other words are accepted arguments to <tt class="verbatim">lstset</tt>.
    </p>
    <p>
      We set PassThru to 1 because the user is actually entering raw latex.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-chunkstyle-1"></a>
        <table style="width: 100%" id="code-ref-chunkstyle-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="chunkstyle"></a><font size="-1"><div class="left-tab">
              <font color="blue">chunkstyle</font>[1](), lang=<font color="blue"></font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-chunkstyle-2">76b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>Style Chunk
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  LatexType             Command
<tt>3  </tt>  LatexName             Chunk
<tt>4  </tt>  Margin                First_Dynamic
<tt>5  </tt>  LeftMargin            Chunk:xxx
<tt>6  </tt>  LabelSep              xx
<tt>7  </tt>  LabelType             Static
<tt>8  </tt>  LabelString           &quot;Chunk:&quot;
<tt>9  </tt>  Align                 Left
<tt>10  </tt>  PassThru              1</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>11  </tt>
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-chunkstyle-1"></a>
      </p></font>
    </p>
    <p>
      To make the label very visible we choose a larger font coloured red.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-chunkstyle-2"></a>
        <table style="width: 100%" id="code-ref-chunkstyle-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="chunkstyle"></a><font size="-1"><div class="left-tab">
              <font color="blue">chunkstyle</font>[2]() &uArr;<a href="#code-ref-chunkstyle-1">76a</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-chunkstyle-1">76a</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>12  </tt>  LabelFont
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>13  </tt>    Family              Sans
<tt>14  </tt>    Size                Large
<tt>15  </tt>    Series              Bold
<tt>16  </tt>    Shape               Italic
<tt>17  </tt>    Color               red
<tt>18  </tt>  EndFont</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>19  </tt>End
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-chunkstyle-2">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h3 id="auto-87">15.1.2<span style="margin-left: 1em"></span>The chunkref style</h3>
    <p>
      We also define the Chunkref style which can be used to express cross
      references to chunks.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-chunkref-1"></a>
        <table style="width: 100%" id="code-ref-chunkref-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="chunkref"></a><font size="-1"><font color="blue">chunkref</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>InsetLayout Chunkref
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  LyxType               charstyle
<tt>3  </tt>  LatexType             Command
<tt>4  </tt>  LatexName             chunkref
<tt>5  </tt>  PassThru              1
<tt>6  </tt>  LabelFont             
<tt>7  </tt>    Shape               Italic
<tt>8  </tt>    Color               red
<tt>9  </tt>  EndFont</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>End
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-chunkref-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-88"><a id="sec:Latex-Macros"></a>15.2<span style="margin-left: 1em"></span>Latex Macros</h2>
    <p>
      We require the listings, noweb and xargs packages. As noweb defines it's
      own <tt class="verbatim">\code</tt> environment, we re-define the one that L<span
      style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X logical markup module expects here.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-1"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[1](), lang=<font color="blue">tex</font>
              &equiv;
            </div><div class="right-tab">
              <a href="#code-ref-./fangle.sty-2">77a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>\usepackage{listings}%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>\usepackage{noweb}%
<tt>3  </tt>\usepackage{xargs}%</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>\renewcommand{\code}[1]{\texttt{#1}}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-1"></a>
      </p></font>
    </p>
    <p>
      We also define a <tt class="verbatim">CChunk</tt> macro, for use as: <tt class="verbatim">\begin{CChunk}</tt>
      which will need renaming to <tt class="verbatim">\begin{Chunk}</tt> when I can do
      this without clashing with <tt class="verbatim">\Chunk</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-2"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[2]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-./fangle.sty-1">76d</a> <a href="#code-ref-./fangle.sty-3">77b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>5  </tt>\lstnewenvironment{Chunk}{\relax}{\relax}%
        </div></tt>
      </p><p>
        <a id="code-end-./fangle.sty-2"></a>
      </p></font>
    </p>
    <p>
      We also define a suitable <tt class="verbatim">\lstset</tt> of parameters that
      suit the literate programming style after the fashion of <class style="font-variant: small-caps">noweave</class>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-3"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-3">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[3]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-2">77a</a> <a href="#code-ref-./fangle.sty-4">77c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>6  </tt>\lstset{numbers=left, stepnumber=5, numbersep=5pt,
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>7  </tt>        breaklines=false,basicstyle=\ttfamily,</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>8  </tt>        numberstyle=\tiny, language=C}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-3"></a>
      </p></font>
    </p>
    <p>
      We also define a notangle-like mechanism for escaping to LaTeX from the
      listing, and by which we can refer to other listings. We declare the <tt
      class="verbatim">=&lt;...&gt;</tt> sequence to contain LaTeX code, and include
      another like this chunk: <tt class="verbatim">=&lt;\chunkref{chunkname}&gt;</tt>.
      However, because <tt class="verbatim">=&lt;...&gt;</tt> is already defined to
      contain LaTeX code for this document &ndash;- this is a fangle document
      after all &ndash;- the code fragment below effectively contains the
      LaTeX code: <tt class="verbatim">}{</tt>. To avoid problems with document
      generation, I had to declare an lstlistings property: <tt class="verbatim">escapeinside={}</tt>
      for this listing only; which in L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X
      was done by right-clicking the listings inset, choosing
      settings-&gt;advanced. Therefore <tt class="verbatim">=&lt;</tt> isn't interpreted
      literally here, in a listing when the escape sequence is already defined
      as shown... we need to somehow escape this representation...
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-4"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-4">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[4]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-3">77b</a> <a href="#code-ref-./fangle.sty-5">77d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>9  </tt>\lstset{escapeinside={=&lt;}{&gt;}}%
        </div></tt>
      </p><p>
        <a id="code-end-./fangle.sty-4"></a>
      </p></font>
    </p>
    <p>
      Although our macros will contain the <tt class="verbatim">@</tt> symbol, they will
      be included in a <tt class="verbatim">\makeatletter</tt> section by L<span style="margin-left: -0.1667em"></span>Y<span
      style="margin-left: -0.125em"></span>X; however we keep the commented out <tt class="verbatim">\makeatletter</tt>
      as a reminder. The listings package likes to centre the titles, but
      noweb titles are specially formatted and must be left aligned. The
      simplest way to do this turned out to be by removing the definition of
      <tt class="verbatim">\lst@maketitle</tt>. This may interact badly if other
      listings want a regular title or caption. We remember the old maketitle
      in case we need it.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-5"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-5">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[5]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-4">77c</a> <a href="#code-ref-./fangle.sty-6">77e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>10  </tt>%\makeatletter
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>11  </tt>%somehow re-defining maketitle gives us a left-aligned title
<tt>12  </tt>%which is extactly what our specially formatted title needs!
<tt>13  </tt>\global\let\fangle@lst@maketitle\lst@maketitle%</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>14  </tt>\global\def\lst@maketitle{}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-5"></a>
      </p></font>
    </p>
    <h3 id="auto-89"><a id="sub:The-chunk-command"></a>15.2.1<span style="margin-left: 1em"></span>The chunk command</h3>
    <p>
      Our chunk command accepts one argument, and calls <tt class="verbatim">\ltset</tt>.
      Although <tt class="verbatim">\ltset</tt> will note the name, this is erased when
      the next <tt class="verbatim">\lstlisting</tt> starts, so we make a note of this
      in <tt class="verbatim">\lst@chunkname</tt> and restore in in lstlistings Init
      hook.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-6"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-6">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[6]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-5">77d</a> <a href="#code-ref-./fangle.sty-7">78a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>15  </tt>\def\Chunk#1{%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>16  </tt>  \lstset{title={\fanglecaption},name=#1}%
<tt>17  </tt>  \global\edef\lst@chunkname{\lst@intname}%
<tt>18  </tt>}%</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>19  </tt>\def\lst@chunkname{\empty}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-6"></a>
      </p></font>
    </p>
    <h4 id="auto-90">15.2.1.1<span style="margin-left: 1em"></span>Chunk parameters</h4>
    <p>
      Fangle permits parameterized chunks, and requires the paramters to be
      specified as listings options. The fangle script uses this, and although
      we don't do anything with these in the LaTeX code right now, we need to
      stop the listings package complaining.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-7"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-7">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[7]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-./fangle.sty-6">77e</a> <a href="#code-ref-./fangle.sty-8">78b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>20  </tt>\lst@Key{params}\relax{\def\fangle@chunk@params{#1}}%
        </div></tt>
      </p><p>
        <a id="code-end-./fangle.sty-7"></a>
      </p></font>
    </p>
    <p>
      As it is common to define a chunk which then needs appending to another
      chunk, and annoying to have to declare a single line chunk to manage the
      include, we support an append= option.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-8"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-8">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[8]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-7">78a</a> <a href="#code-ref-./fangle.sty-9">78c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>21  </tt>\lst@Key{append}\relax{\def\fangle@chunk@append{#1}}%
        </div></tt>
      </p><p>
        <a id="code-end-./fangle.sty-8"></a>
      </p></font>
    </p>
    <h3 id="auto-91">15.2.2<span style="margin-left: 1em"></span>The noweb styled caption</h3>
    <p>
      We define a public macro <tt class="verbatim">\fanglecaption</tt> which can be set
      as a regular title. By means of <tt class="verbatim">\protect</tt>, It expands to
      <tt class="verbatim">\fangle@caption</tt> at the appopriate time when the caption
      is emitted.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-9"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-9">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[9]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-8">78b</a> <a href="#code-ref-./fangle.sty-10">78d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          \def\fanglecaption{\protect\fangle@caption}%
        </div></tt>
      </p><p>
        <a id="code-end-./fangle.sty-9"></a>
      </p></font>
    </p>
    <table style="width: 100%">
      <tbody><tr>
        <td style="text-align: center; padding-left: 0em; padding-right: 0em"><p>
          22c &#x27E8;some-chunk 19b&#x27E9;&equiv;+   &#x22B2;22b 24d&#x22B3;
        </p><p>
          
        </p><p>
          In this example, the current chunk is 22c, and therefore the third
          chunk on page 22.
        </p><p>
          It's name is some-chunk. 
        </p><p>
          The first chunk with this name (19b) occurs as the second chunk on
          page 19.
        </p><p>
          The previous chunk (22d) with the same name is the second chunk on
          page 22.
        </p><p>
          The next chunk (24d) is the fourth chunk on page 24.
        </p></td>
      </tr><tr>
        <td style="text-align: center; padding-left: 0em; padding-right: 0em; height: 0.5em"></td>
      </tr><tr>
        <td style="text-align: center; padding-left: 0em; padding-right: 0em; padding-left: 1.5em; padding-right: 1.5em"><p>
          <font size="-1"><p>
            <b>Figure 1. </b><a id="auto-92"></a>Noweb Heading<a id="noweb heading"></a>
          </p></font>
        </p></td>
      </tr></tbody>
    </table>
    <p>
      The general noweb output format compactly identifies the current chunk,
      and references to the first chunk, and the previous and next chunks that
      have the same name.
    </p>
    <p>
      This means that we need to keep a counter for each chunk-name, that we
      use to count chunks of the same name.
    </p>
    <h3 id="auto-93">15.2.3<span style="margin-left: 1em"></span>The chunk counter</h3>
    <p>
      It would be natural to have a counter for each chunk name, but TeX would
      soon run out of counters
      <p>
        <font size="-1"><div align="justify">
          <div style="margin-left: 0px">
            <div style="margin-right: 0px">
              <p>
                . ...soon did run out of counters and so I had to re-write the
                LaTeX macros to share a counter as described here.
              </p>
            </div>
          </div>
        </div></font>
      </p>
      <span style="margin-left: 0em"></span>
      <a id="footnr-1"></a>
      <sup><a href="#footnote-1">1</a></sup>
      , so we have one counter which we save at the end of a chunk and restore
      at the beginning of a chunk.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-10"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-10">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[10]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-9">78c</a> <a href="#code-ref-./fangle.sty-11">79c</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>22  </tt>\newcounter{fangle@chunkcounter}%
        </div></tt>
      </p><p>
        <a id="code-end-./fangle.sty-10"></a>
      </p></font>
    </p>
    <p>
      We construct the name of this variable to store the counter to be the
      text <tt class="verbatim">lst-chunk-</tt> prefixed onto the chunks own name, and
      store it in <tt class="verbatim">\chunkcount</tt>. 
    </p>
    <p>
      We save the counter like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-save-counter-1"></a>
        <table style="width: 100%" id="code-ref-save-counter-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="save-counter"></a><font size="-1"><font color="blue">save-counter</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          \global\expandafter\edef\csname
          \chunkcount\endcsname{\arabic{fangle@chunkcounter}}%
        </div></tt>
      </p><table style="width: 100%" id="code-end-save-counter-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      and restore the counter like this:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-restore-counter-1"></a>
        <table style="width: 100%" id="code-ref-restore-counter-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="restore-counter"></a><font size="-1"><font color="blue">restore-counter</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          \setcounter{fangle@chunkcounter}{\csname \chunkcount\endcsname}%
        </div></tt>
      </p><table style="width: 100%" id="code-end-restore-counter-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      If there does not already exist a variable whose name is stored in <tt
      class="verbatim">\chunkcount</tt>, then we know we are the first chunk with this
      name, and then define a counter. 
    </p>
    <p>
      Although chunks of the same name share a common counter, they must still
      be distinguished. We use is the internal name of the listing, suffixed
      by the counter value. So the first chunk might be <tt class="verbatim">something-1</tt>
      and the second chunk be <tt class="verbatim">something-2</tt>, etc.
    </p>
    <p>
      We also calculate the name of the previous chunk if we can (before we
      increment the chunk counter). If this is the first chunk of that name,
      then <tt class="verbatim">\prevchunkname</tt> is set to <tt class="verbatim">\relax</tt>
      which the noweb package will interpret as not existing.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-11"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-11">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[11]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-./fangle.sty-10">78d</a> <a href="#code-ref-./fangle.sty-12">79d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>23  </tt>\def\fangle@caption{%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>24  </tt>  \edef\chunkcount{lst-chunk-\lst@intname}%
<tt>25  </tt>  \@ifundefined{\chunkcount}{%
<tt>26  </tt>    \expandafter\gdef\csname \chunkcount\endcsname{0}%
<tt>27  </tt>    \setcounter{fangle@chunkcounter}{\csname \chunkcount\endcsname}%
<tt>28  </tt>    \let\prevchunkname\relax%
<tt>29  </tt>  }{%
<tt>30  </tt>    \setcounter{fangle@chunkcounter}{\csname \chunkcount\endcsname}%
<tt>31  </tt>    \edef\prevchunkname{\lst@intname-\arabic{fangle@chunkcounter}}%</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>32  </tt>  }%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-11"></a>
      </p></font>
    </p>
    <p>
      After incrementing the chunk counter, we then define the name of this
      chunk, as well as the name of the first chunk.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-12"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-12">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[12]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-11">79c</a> <a href="#code-ref-./fangle.sty-13">79e</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>33  </tt>  \addtocounter{fangle@chunkcounter}{1}%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>34  </tt>  \global\expandafter\edef\csname \chunkcount\endcsname{\arabic{fangle@chunkcounter}}%
<tt>35  </tt>  \edef\chunkname{\lst@intname-\arabic{fangle@chunkcounter}}%</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>36  </tt>  \edef\firstchunkname{\lst@intname-1}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-12"></a>
      </p></font>
    </p>
    <p>
      We now need to calculate the name of the next chunk. We do this by
      temporarily skipping the counter on by one; however there may not
      actually be another chunk with this name! We detect this by also
      defining a label for each chunk based on the chunkname. If there is a
      next chunkname then it will define a label with that name. As labels are
      persistent, we can at least tell the second time LaTeX is run. If we
      don't find such a defined label then we define <tt class="verbatim">\nextchunkname</tt>
      to <tt class="verbatim">\relax</tt>.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-13"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-13">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[13]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-12">79d</a> <a href="#code-ref-./fangle.sty-14">80a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>37  </tt>  \addtocounter{fangle@chunkcounter}{1}%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>38  </tt>  \edef\nextchunkname{\lst@intname-\arabic{fangle@chunkcounter}}%</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>39  </tt> 
            \@ifundefined{r@label-\nextchunkname}{\let\nextchunkname\relax}{}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-13"></a>
      </p></font>
    </p>
    <p>
      The noweb package requires that we define a <tt class="verbatim">\sublabel</tt>
      for every chunk, with a unique name, which is then used to print out
      it's navigation hints.
    </p>
    <p>
      We also define a regular label for this chunk, as was mentioned above
      when we calculated <tt class="verbatim">\nextchunkname</tt>. This requires LaTeX
      to be run at least twice after new chunk sections are added &ndash;- but
      noweb requried that anyway.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-14"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-14">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[14]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-./fangle.sty-13">79e</a> <a href="#code-ref-./fangle.sty-15">80b</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>40  </tt>  \sublabel{\chunkname}%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>41  </tt>% define this label for every chunk instance, so we
<tt>42  </tt>% can tell when we are the last chunk of this name</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>43  </tt>  \label{label-\chunkname}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-14"></a>
      </p></font>
    </p>
    <p>
      We also try and add the chunk to the list of listings, but I'm afraid we
      don't do very well. We want each chunk name listing once, with all of
      it's references.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-15"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-15">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[15]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-14">80a</a> <a href="#code-ref-./fangle.sty-16">80c</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>44  </tt> 
          \addcontentsline{lol}{lstlisting}{\lst@name~[\protect\subpageref{\chunkname}]}%
        </div></tt>
      </p><p>
        <a id="code-end-./fangle.sty-15"></a>
      </p></font>
    </p>
    <p>
      We then call the noweb output macros in the same way that noweave
      generates them, except that we don't need to call <tt class="verbatim">\nwstartdeflinemarkup</tt>
      or <tt class="verbatim">\nwenddeflinemarkup</tt> <class style="font-family: Times New Roman">&mdash;</class> and
      if we do, it messes up the output somewhat.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-16"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-16">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[16]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-15">80b</a> <a href="#code-ref-./fangle.sty-17">80d</a>&#x25BF;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>45  </tt>  \nwmargintag{%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>46  </tt>    {%
<tt>47  </tt>      \nwtagstyle{}%
<tt>48  </tt>      \subpageref{\chunkname}%
<tt>49  </tt>    }%
<tt>50  </tt>  }%
<tt>51  </tt>%
<tt>52  </tt>  \moddef{%
<tt>53  </tt>    {\lst@name}%
<tt>54  </tt>    {%
<tt>55  </tt>      \nwtagstyle{}\/%
<tt>56  </tt>      \@ifundefined{fangle@chunk@params}{}{%
<tt>57  </tt>        (\fangle@chunk@params)%
<tt>58  </tt>      }%
<tt>59  </tt>      [\csname \chunkcount\endcsname]~%
<tt>60  </tt>      \subpageref{\firstchunkname}%
<tt>61  </tt>    }%
<tt>62  </tt>    \@ifundefined{fangle@chunk@append}{}{%
<tt>63  </tt>    \ifx{}\fangle@chunk@append{x}\else%
<tt>64  </tt>        ,~add~to~\fangle@chunk@append%
<tt>65  </tt>    \fi%
<tt>66  </tt>    }%
<tt>67  </tt>\global\def\fangle@chunk@append{}%
<tt>68  </tt>\lstset{append=x}%
<tt>69  </tt>  }%
<tt>70  </tt>%
<tt>71  </tt>  \ifx\relax\prevchunkname\endmoddef\else\plusendmoddef\fi%
<tt>72  </tt>%  \nwstartdeflinemarkup%
<tt>73  </tt>  \nwprevnextdefs{\prevchunkname}{\nextchunkname}%
<tt>74  </tt>%  \nwenddeflinemarkup%</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>75  </tt>}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-16"></a>
      </p></font>
    </p>
    <p>
      Originally this was developed as a <tt class="verbatim">listings</tt> aspect, in
      the Init hook, but it was found easier to affect the title without using
      a hook <class style="font-family: Times New Roman">&mdash;</class> <tt class="verbatim">\lst@AddToHookExe{PreSet}</tt>
      is still required to set the listings name to the name passed to the <tt
      class="verbatim">\Chunk</tt> command, though.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-17"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-17">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[17]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x25B5;<a href="#code-ref-./fangle.sty-16">80c</a> <a href="#code-ref-./fangle.sty-18">81a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>76  </tt>%\lst@BeginAspect{fangle}
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>77  </tt>%\lst@Key{fangle}{true}[t]{\lstKV@SetIf{#1}{true}}
<tt>78  </tt>\lst@AddToHookExe{PreSet}{\global\let\lst@intname\lst@chunkname}
<tt>79  </tt>\lst@AddToHook{Init}{}%\fangle@caption}</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>80  </tt>%\lst@EndAspect
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-17"></a>
      </p></font>
    </p>
    <h3 id="auto-94">15.2.4<span style="margin-left: 1em"></span>Cross references</h3>
    <p>
      We define the <tt class="verbatim">\chunkref</tt> command which makes it easy to
      generate visual references to different code chunks, e.g.
    </p>
    <table style="display: inline; vertical-align: -2.2em">
      <tbody><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-left: 1px solid; border-top: 1px solid">Macro</td>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-top: 1px solid">Appearance</td>
      </tr><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-left: 1px solid"><tt class="verbatim">\chunkref{preamble}</tt></td>
        <td style="border-right: 1px solid; border-bottom: 1px solid"></td>
      </tr><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-left: 1px solid"><tt class="verbatim">\chunkref[3]{preamble}</tt></td>
        <td style="border-right: 1px solid; border-bottom: 1px solid"></td>
      </tr><tr>
        <td style="border-right: 1px solid; border-bottom: 1px solid; border-left: 1px solid"><tt class="verbatim">\chunkref{preamble}[arg1, arg2]</tt></td>
        <td style="border-right: 1px solid; border-bottom: 1px solid"></td>
      </tr></tbody>
    </table>
    <p>
      Chunkref can also be used within a code chunk to include another code
      chunk. The third optional parameter to chunkref is a comma sepatarated
      list of arguments, which will replace defined parameters in the
      chunkref.
    </p>
    <p style="margin-top: 1em; margin-bottom: 1em">
      <b>Note <class style="font-style: normal">1</class>. </b>Darn it, if I have: <tt class="verbatim">=&lt;\chunkref{new-mode-tracker}[{chunks[chunk_name,
      &quot;language&quot;]},{mode}]&gt;</tt> the inner braces (inside [ ])
      cause _ to signify subscript even though we have <tt class="verbatim">lst@ReplaceIn</tt>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-18"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-18">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[18]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-./fangle.sty-17">80d</a> <a href="#code-ref-./fangle.sty-19">82a</a>&#x22B3;
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>81  </tt>\def\chunkref@args#1,{%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>82  </tt>  \def\arg{#1}%
<tt>83  </tt>  \lst@ReplaceIn\arg\lst@filenamerpl%
<tt>84  </tt>  \arg%
<tt>85  </tt>  \@ifnextchar){\relax}{, \chunkref@args}%
<tt>86  </tt>}%
<tt>87  </tt>\newcommand\chunkref[2][0]{%
<tt>88  </tt>  \@ifnextchar({\chunkref@i{#1}{#2}}{\chunkref@i{#1}{#2}()}%
<tt>89  </tt>}%
<tt>90  </tt>\def\chunkref@i#1#2(#3){%
<tt>91  </tt>  \def\zero{0}%
<tt>92  </tt>  \def\chunk{#2}%
<tt>93  </tt>  \def\chunkno{#1}%
<tt>94  </tt>  \def\chunkargs{#3}%
<tt>95  </tt>  \ifx\chunkno\zero%
<tt>96  </tt>    \def\chunkname{#2-1}%
<tt>97  </tt>  \else%
<tt>98  </tt>    \def\chunkname{#2-\chunkno}%
<tt>99  </tt>  \fi%
<tt>100  </tt>  \let\lst@arg\chunk%
<tt>101  </tt>  \lst@ReplaceIn\chunk\lst@filenamerpl%
<tt>102  </tt>  \LA{%\moddef{%
<tt>103  </tt>    {\chunk}%
<tt>104  </tt>    {%
<tt>105  </tt>      \nwtagstyle{}\/%
<tt>106  </tt>      \ifx\chunkno\zero%
<tt>107  </tt>      \else%
<tt>108  </tt>      [\chunkno]%
<tt>109  </tt>      \fi%
<tt>110  </tt>      \ifx\chunkargs\empty%
<tt>111  </tt>      \else%
<tt>112  </tt>        (\chunkref@args #3,)%
<tt>113  </tt>      \fi%
<tt>114  </tt>      ~\subpageref{\chunkname}%
<tt>115  </tt>    }%
<tt>116  </tt>  }%
<tt>117  </tt>  \RA%\endmoddef%</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>118  </tt>}%
          </div></tt>
        </p>
      </p><p>
        <a id="code-end-./fangle.sty-18"></a>
      </p></font>
    </p>
    <h3 id="auto-95">15.2.5<span style="margin-left: 1em"></span>The end</h3>
    <p>
      <font size="-1"><p>
        <a id="code-label-./fangle.sty-19"></a>
        <table style="width: 100%" id="code-ref-./fangle.sty-19">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./fangle.sty"></a><font size="-1"><div class="left-tab">
              <font color="blue">./fangle.sty</font>[19]() &uArr;<a href="#code-ref-./fangle.sty-1">76d</a>,
              lang=<font color="blue"></font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-./fangle.sty-18">81a</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>119  </tt>%
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>120  </tt>%\makeatother
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-./fangle.sty-19">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-96">Chapter 16<br></br>Extracting fangle</h1>
    <h2 id="auto-97">16.1<span style="margin-left: 1em"></span>Extracting from Lyx</h2>
    <p>
      To extract from L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X, you will
      need to configure L<span style="margin-left: -0.1667em"></span>Y<span style="margin-left: -0.125em"></span>X as
      explained in section <a href="#Configuring-the-build">?</a>.
    </p>
    <p>
      <a id="lyx-build-script"></a>And this lyx-build scrap will extract fangle for me.
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-lyx-build-2"></a>
        <table style="width: 100%" id="code-ref-lyx-build-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="lyx-build"></a><font size="-1"><div class="left-tab">
              <font color="blue">lyx-build</font>[2]() &uArr;<a href="#code-ref-lyx-build-1">20a</a>,
              lang=<font color="blue">sh</font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-lyx-build-1">20a</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>11  </tt>#! /bin/sh
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>12  </tt>set -x
<tt>13  </tt>
<tt>14  </tt>=&lt;\chunkref{lyx-build-helper}&gt;
<tt>15  </tt>cd $PROJECT_DIR || exit 1
<tt>16  </tt>
<tt>17  </tt>/usr/local/bin/fangle -R./fangle $TEX_SRC &gt; ./fangle
<tt>18  </tt>/usr/local/bin/fangle -R./fangle.module $TEX_SRC &gt; ./fangle.module
<tt>19  </tt>
<tt>20  </tt>=&lt;\chunkref{test:helpers}&gt;
<tt>21  </tt>export FANGLE=./fangle
<tt>22  </tt>export TMP=${TMP:-/tmp}
<tt>23  </tt>=&lt;\chunkref{test:run-tests}&gt;
<tt>24  </tt># Now check that we can extract a fangle that also passes the tests!
<tt>25  </tt>$FANGLE -R./fangle $TEX_SRC &gt; ./new-fangle
<tt>26  </tt>export FANGLE=./new-fangle</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>27  </tt>=&lt;\chunkref{test:run-tests}&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-lyx-build-2">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:run-tests-1"></a>
        <table style="width: 100%" id="code-ref-test:run-tests-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:run-tests"></a><font size="-1"><font color="blue">test:run-tests</font>[1](),
            lang=<font color="blue">sh</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt># run tests
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>$FANGLE -Rpca-test.awk $TEX_SRC | awk -f - || exit 1
<tt>3  </tt>=&lt;\chunkref{test:cromulence}&gt;
<tt>4  </tt>=&lt;\chunkref{test:escapes}&gt;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>=&lt;\chunkref{test:chunk-params}&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:run-tests-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      With a lyx-build-helper
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-lyx-build-helper-2"></a>
        <table style="width: 100%" id="code-ref-lyx-build-helper-2">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0px solid; padding-top: 0pt; padding-bottom: 1px"><a id="lyx-build-helper"></a><font size="-1"><div class="left-tab">
              <font color="blue">lyx-build-helper</font>[2]() &uArr;<a href="#code-ref-lyx-build-helper-1">19b</a>,
              lang=<font color="blue">sh</font>  + &equiv;
            </div><div class="right-tab">
              &#x22B2;<a href="#code-ref-lyx-build-helper-1">19b</a>
            </div></font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>5  </tt>PROJECT_DIR=&quot;$LYX_r&quot;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>6  </tt>LYX_SRC=&quot;$PROJECT_DIR/${LYX_i%.tex}.lyx&quot;
<tt>7  </tt>TEX_DIR=&quot;$LYX_p&quot;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>8  </tt>TEX_SRC=&quot;$TEX_DIR/$LYX_i&quot;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-lyx-build-helper-2">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-98">16.2<span style="margin-left: 1em"></span>Extracting documentation</h2>
    <p>
      <font size="-1"><p>
        <a id="code-label-./gen-www-1"></a>
        <table style="width: 100%" id="code-ref-./gen-www-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="./gen-www"></a><font size="-1"><font color="blue">./gen-www</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>#python -m elyxer &ndash;css lyx.css $LYX_SRC | \
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>#  iconv -c -f utf-8 -t ISO-8859-1//TRANSLIT | \
<tt>3  </tt>#  sed 's/UTF-8&quot;\(.\)&gt;/ISO-8859-1&quot;\1&gt;/' &gt; www/docs/fangle.html
<tt>4  </tt>
<tt>5  </tt>python -m elyxer --css lyx.css --iso885915 --html --destdirectory www/docs/fangle.e \
<tt>6  </tt>       fangle.lyx &gt; www/docs/fangle.e/fangle.html
<tt>7  </tt>
<tt>8  </tt>( mkdir -p www/docs/fangle &amp;&amp; cd www/docs/fangle &amp;&amp; \
<tt>9  </tt>  lyx -e latex ../../../fangle.lyx &amp;&amp; \
<tt>10  </tt>  htlatex ../../../fangle.tex &quot;xhtml,fn-in&quot; &amp;&amp; \
<tt>11  </tt>  sed -i -e 's/&lt;!--l\. [0-9][0-9]* *--&gt;//g' fangle.html
<tt>12  </tt>)
<tt>13  </tt>
<tt>14  </tt>( mkdir -p www/docs/literate &amp;&amp; cd www/docs/literate &amp;&amp; \
<tt>15  </tt>  lyx -e latex ../../../literate.lyx &amp;&amp; \
<tt>16  </tt>  htlatex ../../../literate.tex &quot;xhtml,fn-in&quot; &amp;&amp; \
<tt>17  </tt>  sed -i -e 's/&lt;!--l\. [0-9][0-9]* *--&gt;$//g' literate.html</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>18  </tt>)
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-./gen-www-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-99">16.3<span style="margin-left: 1em"></span>Extracting from the command line</h2>
    <p>
      First you will need the tex output, then you can extract:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-lyx-build-manual-1"></a>
        <table style="width: 100%" id="code-ref-lyx-build-manual-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="lyx-build-manual"></a><font size="-1"><font color="blue">lyx-build-manual</font>[1](),
            lang=<font color="blue">sh</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>lyx -e latex fangle.lyx
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>fangle -R./fangle fangle.tex &gt; ./fangle</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>fangle -R./fangle.module fangle.tex &gt;
            ./fangle.module
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-lyx-build-manual-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h2 id="auto-100">16.4<span style="margin-left: 1em"></span>Testing</h2>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:helpers-1"></a>
        <table style="width: 100%" id="code-ref-test:helpers-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:helpers"></a><font size="-1"><font color="blue">test:helpers</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>passtest() {
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>  if &quot;$@&quot;
<tt>3  </tt>  then echo &quot;Passed&quot;
<tt>4  </tt>  else echo &quot;Failed&quot;
<tt>5  </tt>       return 1
<tt>6  </tt>  fi
<tt>7  </tt>}
<tt>8  </tt>
<tt>9  </tt>failtest() {
<tt>10  </tt>  if ! &quot;$@&quot;
<tt>11  </tt>  then echo &quot;Passed&quot;
<tt>12  </tt>  else echo &quot;Failed&quot;
<tt>13  </tt>       return 1
<tt>14  </tt>  fi</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>15  </tt>}
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:helpers-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p style="margin-top: 25%; margin-bottom: 10%">
      <a id="auto-101"></a><br></br><b><font size="+5"><div class="center-tab">
        Part III
      </div><div class="right-tab">
        <br></br>Tests
      </div></font></b>
    </p>
    <h1 id="auto-102">Chapter 17<br></br>Chunk Parameters</h1>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:chunk-params:sub-1"></a>
        <table style="width: 100%" id="code-ref-test:chunk-params:sub-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:chunk-params:sub"></a><font size="-1"><font color="blue">test:chunk-params:sub</font>[1](<font
            color="blue">THING</font>, <font color="blue">colour</font>), lang=<font
            color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>I see a ${THING},
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>a ${THING} of colour ${colour}, </div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>and looking closer
            =&lt;\chunkref{test:chunk-params:sub:sub}(${colour})&gt;
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:chunk-params:sub-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:chunk-params:sub:sub-1"></a>
        <table style="width: 100%" id="code-ref-test:chunk-params:sub:sub-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:chunk-params:sub:sub"></a><font size="-1"><font color="blue">test:chunk-params:sub:sub</font>[1](<font
            color="blue">colour</font>), lang=<font color="blue"></font>
            &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <tt class="verbatim"><div class="compact-block">
          <tt>1  </tt>a funny shade of ${colour}
        </div></tt>
      </p><table style="width: 100%" id="code-end-test:chunk-params:sub:sub-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:chunk-params:text-1"></a>
        <table style="width: 100%" id="code-ref-test:chunk-params:text-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:chunk-params:text"></a><font size="-1"><font color="blue">test:chunk-params:text</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>What do you see?
            &quot;=&lt;\chunkref{test:chunk-params:sub}(joe, red)&gt;&quot;
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"></div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>2  </tt>Well, fancy!
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:chunk-params:text-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      Should generate output:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:chunk-params:result-1"></a>
        <table style="width: 100%" id="code-ref-test:chunk-params:result-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:chunk-params:result"></a><font size="-1"><font color="blue">test:chunk-params:result</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>What do you see? &quot;I see a joe,
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>                  a joe of colour red, 
<tt>3  </tt>                  and looking closer a funny shade of red&quot;</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>4  </tt>Well, fancy!
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:chunk-params:result-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      And this chunk will perform the test:
    </p>
    <p>
      <font size="-1"><p>
        <a id="code-label-test:chunk-params-1"></a>
        <table style="width: 100%" id="code-ref-test:chunk-params-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="test:chunk-params"></a><font size="-1"><font color="blue">test:chunk-params</font>[1](),
            lang=<font color="blue"></font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>$FANGLE -Rtest:chunk-params:result $TEX_SRC &gt;
            $TMP/answer || exit 1
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt>$FANGLE -Rtest:chunk-params:text $TEX_SRC &gt; $TMP/result || exit 1</div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>3  </tt>passtest diff $TMP/answer $TMP/result || (echo
            test:chunk-params:text failed ; exit 1)
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-test:chunk-params-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <h1 id="auto-103"><a id="Compile-log-lyx"></a>Chapter 18<br></br>Compile-log-lyx</h1>
    <p>
      <font size="-1"><p>
        <a id="code-label-Chunk:./compile-log-lyx-1"></a>
        <table style="width: 100%" id="code-ref-Chunk:./compile-log-lyx-1">
          <tbody><tr>
            <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0pt solid; border-bottom: 0.5px solid; padding-top: 0pt; padding-bottom: 1px"><a id="Chunk:./compile-log-lyx"></a><font size="-1"><font color="blue">Chunk:./compile-log-lyx</font>[1](),
            lang=<font color="blue">sh</font> &equiv;</font></td>
          </tr></tbody>
        </table>
      </p><p>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>1  </tt>#! /bin/sh
          </div></tt>
        </p>
        <pre class="verbatim" xml:space="preserve">
<div class="compact-block"><tt>2  </tt># can't use gtkdialog -i, cos it uses the &quot;source&quot; command which ubuntu sh doesn't have
<tt>3  </tt>
<tt>4  </tt>main() {
<tt>5  </tt>  errors=&quot;/tmp/compile.log.$$&quot;
<tt>6  </tt>#  if grep '^[^ ]*:\( In \|[0-9][0-9]*: [^ ]*:\)' &gt; $errors
<tt>7  </tt>if grep '^[^ ]*(\([0-9][0-9]*\)) *: *\(error\|warning\)' &gt; $errors
<tt>8  </tt>  then
<tt>9  </tt>    sed -i -e 's/^[^ ]*[/\\]\([^/\\]*\)(\([ 0-9][ 0-9]*\)) *: */\1:\2|\2|/' $errors
<tt>10  </tt>    COMPILE_DIALOG='
<tt>11  </tt> &lt;vbox&gt;
<tt>12  </tt>  &lt;text&gt;
<tt>13  </tt>    &lt;label&gt;Compiler errors:&lt;/label&gt;
<tt>14  </tt>  &lt;/text&gt;
<tt>15  </tt>  &lt;tree exported_column=&quot;0&quot;&gt;
<tt>16  </tt>    &lt;variable&gt;LINE&lt;/variable&gt;
<tt>17  </tt>    &lt;height&gt;400&lt;/height&gt;&lt;width&gt;800&lt;/width&gt;
<tt>18  </tt>    &lt;label&gt;File | Line | Message&lt;/label&gt;
<tt>19  </tt>    &lt;action&gt;'&quot;. $SELF ; &quot;'lyxgoto $LINE&lt;/action&gt;
<tt>20  </tt>    &lt;input&gt;'&quot;cat $errors&quot;'&lt;/input&gt;
<tt>21  </tt>  &lt;/tree&gt;
<tt>22  </tt>  &lt;hbox&gt;
<tt>23  </tt>   &lt;button&gt;&lt;label&gt;Build&lt;/label&gt;
<tt>24  </tt>     &lt;action&gt;lyxclient -c &quot;LYXCMD:build-program&quot; &amp;&lt;/action&gt;
<tt>25  </tt>   &lt;/button&gt;
<tt>26  </tt>   &lt;button ok&gt;&lt;/button&gt;
<tt>27  </tt>  &lt;/hbox&gt;
<tt>28  </tt> &lt;/vbox&gt;
<tt>29  </tt>'
<tt>30  </tt>    export COMPILE_DIALOG
<tt>31  </tt>    ( gtkdialog --program=COMPILE_DIALOG ; rm $errors ) &amp;
<tt>32  </tt>  else
<tt>33  </tt>    rm $errors
<tt>34  </tt>  fi
<tt>35  </tt>}
<tt>36  </tt>
<tt>37  </tt>lyxgoto() {
<tt>38  </tt>  file=&quot;${LINE%:*}&quot;
<tt>39  </tt>  line=&quot;${LINE##*:}&quot;
<tt>40  </tt>  extraline=&lsquo;cat $file | head -n $line | tac | sed '/^\\\\begin{lstlisting}/q' | wc -l&lsquo;
<tt>41  </tt>  extraline=&lsquo;expr $extraline - 1&lsquo;
<tt>42  </tt>  lyxclient -c &quot;LYXCMD:command-sequence server-goto-file-row $file $line ; char-forward ; repeat $extraline paragraph-down ; paragraph-up-select&quot;
<tt>43  </tt>}
<tt>44  </tt>
<tt>45  </tt>SELF=&quot;$0&quot;
<tt>46  </tt>if test -z &quot;$COMPILE_DIALOG&quot;
<tt>47  </tt>then main &quot;$@&quot; </div></pre>
        <p>
          <tt class="verbatim"><div class="compact-block">
            <tt>48  </tt>fi
          </div></tt>
        </p>
      </p><table style="width: 100%" id="code-end-Chunk:./compile-log-lyx-1">
        <tbody><tr>
          <td style="width: 100%; padding-left: 0pt; padding-right: 0pt; border-top: 0.5px solid; border-bottom: 0px solid; padding-top: 1px; padding-bottom: 0px"></td>
        </tr></tbody>
      </table></font>
    </p>
    <p>
      
    </p>
  </body>
</html>